{"version":3,"file":"admin-CmrKnu5O.js","sources":["../../src/js/admin.ts"],"sourcesContent":["import { supabase, getCurrentUser } from './supabase-client';\r\nimport { isCurrentUserSuperAdmin, getCurrentUserRole, isCurrentUserAdmin } from './auth';\r\n// Note: Removed old ingredient modal imports - now using simple-edit.ts\r\nimport { loadAndDisplayFoods, allFoods } from './food-tracker';\r\n\r\n// Import simple edit functions\r\nimport { openEditFoodModal, openEditMealModal } from './simple-edit';\r\nimport { loadMealsFromDatabase } from './meals';\r\n\r\n// Admin Module for NutriValor\r\nlet currentUsers: any[] = [];\r\nlet currentFoods: any[] = [];\r\nlet mealManagementInitialized = false;\r\nlet currentEditingMeal: any = null;\r\nlet ingredients: any[] = [];\r\n\r\n// Initialize admin functionality\r\nexport async function initializeAdmin(): Promise<void> {\r\n  try {\r\n    // Update role display\r\n    await updateRoleDisplay();\r\n    \r\n    // Load user list\r\n    await loadUserList();\r\n    \r\n    // Load food management\r\n    console.log('üîç loadFoodManagement called');\r\n    await loadFoodManagement();\r\n    \r\n  } catch (error) {\r\n    console.error('‚ùå Error initializing admin panel:', error);\r\n    showMessage('Error initializing admin panel', 'error');\r\n  }\r\n}\r\n\r\n// Update role display\r\nasync function updateRoleDisplay(): Promise<void> {\r\n  const roleElement = document.getElementById('currentUserRole');\r\n  if (!roleElement) return;\r\n  \r\n  try {\r\n    const role = await getCurrentUserRole();\r\n    roleElement.textContent = role.charAt(0).toUpperCase() + role.slice(1).replace('_', ' ');\r\n    roleElement.className = `role-badge ${role}`;\r\n  } catch (error) {\r\n    console.error('Error updating role display:', error);\r\n    roleElement.textContent = 'User';\r\n    roleElement.className = 'role-badge user';\r\n  }\r\n}\r\n\r\n// Load and display user list\r\nexport async function loadUserList(): Promise<void> {\r\n  const container = document.getElementById('userListContainer');\r\n  if (!container) return;\r\n  \r\n  try {\r\n    container.innerHTML = '<div class=\"loading-users\">Loading users...</div>';\r\n    \r\n    const { data: users, error } = await supabase\r\n      .from('user_management')\r\n      .select('*')\r\n      .order('user_created_at', { ascending: false });\r\n    \r\n    if (error) {\r\n      container.innerHTML = '<div class=\"error-message\">Error loading users</div>';\r\n      return;\r\n    }\r\n    \r\n    currentUsers = users || [];\r\n    displayUserList(currentUsers);\r\n    \r\n  } catch (error) {\r\n    container.innerHTML = '<div class=\"error-message\">Error loading users</div>';\r\n  }\r\n}\r\n\r\n// Display user list\r\nfunction displayUserList(users: any[]): void {\r\n  const container = document.getElementById('userListContainer');\r\n  if (!container) return;\r\n  \r\n  if (users.length === 0) {\r\n    container.innerHTML = '<div class=\"empty-state\">No users found</div>';\r\n    return;\r\n  }\r\n  \r\n  const userListHTML = users.map(user => {\r\n    const joinDate = new Date(user.user_created_at).toLocaleDateString();\r\n    const lastLogin = user.last_sign_in_at \r\n      ? new Date(user.last_sign_in_at).toLocaleDateString() \r\n      : 'Never';\r\n    \r\n    const isConfirmed = user.email_confirmed_at ? 'Confirmed' : 'Pending';\r\n    const roleClass = user.role === 'super_admin' ? 'super-admin' : user.role;\r\n    \r\n    return `\r\n      <div class=\"user-item\" data-user-id=\"${user.id}\">\r\n        <div class=\"user-info\">\r\n          <div class=\"user-email\">${user.email}</div>\r\n          <div class=\"user-meta\">\r\n            <span class=\"user-status ${isConfirmed.toLowerCase()}\">${isConfirmed}</span>\r\n            <span class=\"user-join-date\">Joined: ${joinDate}</span>\r\n            <span class=\"user-last-login\">Last login: ${lastLogin}</span>\r\n          </div>\r\n        </div>\r\n        \r\n        <div class=\"user-role-section\">\r\n          <span class=\"current-role ${roleClass}\">${user.role.replace('_', ' ').toUpperCase()}</span>\r\n          <div class=\"role-actions\">\r\n            ${generateRoleButtons(user)}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }).join('');\r\n  \r\n  container.innerHTML = userListHTML;\r\n}\r\n\r\n// Generate role action buttons based on current user's permissions\r\nfunction generateRoleButtons(user: any): string {\r\n  // Only super admins can change roles\r\n  return `\r\n    <button \r\n      onclick=\"toggleUserRole('${user.id}', '${user.email}', '${user.role}')\" \r\n      class=\"role-btn ${user.role === 'admin' || user.role === 'super_admin' ? 'revoke' : 'grant'}\"\r\n      id=\"roleBtn_${user.id}\"\r\n    >\r\n      ${user.role === 'admin' || user.role === 'super_admin' ? 'Revoke Admin' : 'Make Admin'}\r\n    </button>\r\n    \r\n    <!-- Delete User Button (Testing Only) -->\r\n    <button \r\n      onclick=\"deleteUserAccount('${user.id}', '${user.email}')\" \r\n      class=\"role-btn revoke\"\r\n      style=\"background: linear-gradient(135deg, #991b1b 0%, #ef4444 100%); margin-left: 10px;\"\r\n      title=\"‚ö†Ô∏è Testing Only: Delete User Account\"\r\n    >\r\n      Delete User\r\n    </button>\r\n  `;\r\n}\r\n\r\n// Toggle user role between user and admin\r\nexport async function toggleUserRole(userId: string, email: string, currentRole: string): Promise<void> {\r\n  try {\r\n    // Check if current user is super admin\r\n    const isSuperAdmin = await isCurrentUserSuperAdmin();\r\n    if (!isSuperAdmin) {\r\n      showMessage('Only Super Admins can manage user roles', 'error');\r\n      return;\r\n    }\r\n    \r\n    // Don't allow changing super admin roles\r\n    if (currentRole === 'super_admin') {\r\n      showMessage('Super Admin roles cannot be changed', 'error');\r\n      return;\r\n    }\r\n    \r\n    const newRole = (currentRole === 'admin') ? 'user' : 'admin';\r\n    const action = newRole === 'admin' ? 'grant' : 'revoke';\r\n    \r\n    const confirmed = confirm(\r\n      `Are you sure you want to ${action} admin privileges ${newRole === 'admin' ? 'to' : 'from'} ${email}?`\r\n    );\r\n    \r\n    if (!confirmed) return;\r\n    \r\n    // Update role in database\r\n    const { error } = await supabase\r\n      .from('user_roles')\r\n      .upsert({\r\n        user_id: userId,\r\n        role: newRole,\r\n        granted_by: (await getCurrentUser())?.id\r\n      });\r\n    \r\n    if (error) {\r\n      console.error('Error updating user role:', error);\r\n      showMessage('Error updating user role', 'error');\r\n      return;\r\n    }\r\n    \r\n    showMessage(\r\n      `Successfully ${action === 'grant' ? 'granted' : 'revoked'} admin privileges ${action === 'grant' ? 'to' : 'from'} ${email}`, \r\n      'success'\r\n    );\r\n    \r\n    // Refresh user list\r\n    await loadUserList();\r\n    \r\n  } catch (error) {\r\n    console.error('Error toggling user role:', error);\r\n    showMessage('Error updating user role', 'error');\r\n  }\r\n}\r\n\r\n// Delete user account (for testing purposes only)\r\nexport async function deleteUserAccount(userId: string, email: string): Promise<void> {\r\n  try {\r\n    // Check if current user is super admin\r\n    const isSuperAdmin = await isCurrentUserSuperAdmin();\r\n    if (!isSuperAdmin) {\r\n      showMessage('Only Super Admins can delete user accounts', 'error');\r\n      return;\r\n    }\r\n    \r\n    const confirmed = confirm(\r\n      `‚ö†Ô∏è WARNING: Are you absolutely sure you want to delete the account for ${email}?\\n\\nThis will permanently remove:\\n- User profile\\n- All associated data (foods, meals, weight entries, etc.)\\n\\nThis action CANNOT be undone!`\r\n    );\r\n    \r\n    if (!confirmed) return;\r\n    \r\n    // Double confirmation for safety\r\n    const doubleConfirm = confirm(\r\n      `‚ö†Ô∏è FINAL WARNING: This will permanently delete ${email}'s data.\\n\\nClick OK to confirm.`\r\n    );\r\n    \r\n    if (!doubleConfirm) return;\r\n    \r\n    showMessage('Deleting user data...', 'info');\r\n    \r\n    try {\r\n      // 1. Delete user's data from various tables\r\n      await Promise.all([\r\n        // Delete user profile\r\n        supabase.from('user_profiles').delete().eq('user_id', userId),\r\n        \r\n        // Delete user's foods\r\n        supabase.from('foods').delete().eq('user_id', userId),\r\n        \r\n        // Delete user's meals\r\n        supabase.from('meals').delete().eq('user_id', userId),\r\n        \r\n        // Delete user's shopping list\r\n        supabase.from('shopping_list').delete().eq('user_id', userId),\r\n        \r\n        // Delete user's weight entries\r\n        supabase.from('weight_entries').delete().eq('user_id', userId),\r\n        \r\n        // Delete user's role\r\n        supabase.from('user_roles').delete().eq('user_id', userId)\r\n      ]);\r\n      \r\n      // 2. Notify admin that auth record requires Supabase dashboard access\r\n      showMessage(`User data for ${email} deleted. To remove the auth account completely, use the Supabase dashboard.`, 'success');\r\n      \r\n      // Refresh user list\r\n      await loadUserList();\r\n      \r\n    } catch (error) {\r\n      console.error('Error deleting user data:', error);\r\n      showMessage(`Error deleting user data: ${(error as Error).message}`, 'error');\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('Error in deleteUserAccount:', error);\r\n    showMessage(`Error: ${(error as Error).message}`, 'error');\r\n  }\r\n}\r\n\r\n// Refresh user list\r\nexport async function refreshUserList(): Promise<void> {\r\n  await loadUserList();\r\n  showMessage('User list refreshed', 'success');\r\n}\r\n\r\n// Show message helper\r\nexport function showMessage(message: string, type: 'success' | 'error' | 'info' | 'warning' = 'success'): void {\r\n  // Create or update message element\r\n  let messageEl = document.getElementById('admin-message');\r\n  if (!messageEl) {\r\n    messageEl = document.createElement('div');\r\n    messageEl.id = 'admin-message';\r\n    messageEl.className = 'message';\r\n    const container = document.getElementById('admin') || document.body;\r\n    container.insertBefore(messageEl, container.firstChild);\r\n  }\r\n  \r\n  messageEl.textContent = message;\r\n  messageEl.className = `message ${type}`;\r\n  messageEl.style.display = 'block';\r\n  \r\n  // Hide after 4 seconds\r\n  setTimeout(() => {\r\n    if (messageEl) messageEl.style.display = 'none';\r\n  }, 4000);\r\n}\r\n\r\n// FOOD MANAGEMENT FUNCTIONS\r\n// =====================================================\r\n\r\n// Load foods for edit dropdown\r\nasync function loadFoodsForEditDropdown(): Promise<void> {\r\n  try {\r\n    console.log('üçé Loading foods for edit dropdown...');\r\n    const { data: foods, error } = await supabase\r\n      .from('foods')\r\n      .select('*')\r\n      .order('name');\r\n\r\n    if (error) {\r\n      console.error('Error loading foods:', error);\r\n      showMessage('Error loading foods for editing', 'error');\r\n      return;\r\n    }\r\n\r\n    // Store foods for later use\r\n    currentFoods = foods || [];\r\n\r\n    // Get dropdown element\r\n    const dropdown = document.getElementById('foodSelectDropdown') as HTMLSelectElement;\r\n    if (!dropdown) {\r\n      console.warn('Food select dropdown not found');\r\n      return;\r\n    }\r\n\r\n    // Clear existing options except the first one\r\n    dropdown.innerHTML = '<option value=\"\">Choose a food to edit...</option>';\r\n\r\n    // Add foods to dropdown\r\n    foods?.forEach(food => {\r\n      const option = document.createElement('option');\r\n      option.value = food.id;\r\n      option.textContent = food.brand ? \r\n        `${food.name} (${food.brand})` : \r\n        food.name;\r\n      dropdown.appendChild(option);\r\n    });\r\n\r\n    console.log(`üìä Loaded ${foods?.length || 0} foods for editing`);\r\n  } catch (error) {\r\n    console.error('Error loading foods for dropdown:', error);\r\n    showMessage('Error loading foods', 'error');\r\n  }\r\n}\r\n\r\n// Load and display food management section\r\nexport async function loadFoodManagement(): Promise<void> {\r\n  try {\r\n    // Load foods first\r\n    await loadAndDisplayFoods();\r\n    \r\n    // Then setup event listeners\r\n    setupFoodManagementEventListeners();\r\n    \r\n  } catch (error) {\r\n    // Continue with admin initialization even if food management fails\r\n  }\r\n}\r\n\r\n// Setup event listeners for food management\r\nfunction setupFoodManagementEventListeners(): void {\r\n  const addFoodForm = document.getElementById('addFoodForm') as HTMLFormElement;\r\n  if (addFoodForm) {\r\n    addFoodForm.addEventListener('submit', handleAddFood);\r\n  }\r\n  \r\n  // Add duplicate detection for food name and brand\r\n  const foodNameInput = document.getElementById('foodName') as HTMLInputElement;\r\n  const foodBrandInput = document.getElementById('foodBrand') as HTMLInputElement;\r\n  \r\n  if (foodNameInput) {\r\n    foodNameInput.addEventListener('input', checkForDuplicates);\r\n  }\r\n  \r\n  if (foodBrandInput) {\r\n    foodBrandInput.addEventListener('input', checkForDuplicates);\r\n  }\r\n}\r\n\r\n// Check for duplicate food items\r\nasync function checkForDuplicates(): Promise<void> {\r\n  const foodNameInput = document.getElementById('foodName') as HTMLInputElement;\r\n  const foodBrandInput = document.getElementById('foodBrand') as HTMLInputElement;\r\n  const duplicateWarning = document.getElementById('duplicateWarning');\r\n  \r\n  if (!foodNameInput || !duplicateWarning) return;\r\n  \r\n  const foodName = foodNameInput.value.trim();\r\n  const foodBrand = foodBrandInput?.value.trim() || '';\r\n  \r\n  // Only check if we have a food name\r\n  if (!foodName) {\r\n    duplicateWarning.style.display = 'none';\r\n    return;\r\n  }\r\n  \r\n  try {\r\n    // Search for existing food with same name and brand\r\n    let query = supabase\r\n      .from('foods')\r\n      .select('id, name, brand')\r\n      .ilike('name', foodName);\r\n    \r\n    // If brand is provided, include it in the search\r\n    if (foodBrand) {\r\n      query = query.ilike('brand', foodBrand);\r\n    }\r\n    \r\n    const { data: existingFoods, error } = await query;\r\n    \r\n    if (error) {\r\n      console.error('Error checking for duplicates:', error);\r\n      return;\r\n    }\r\n    \r\n    // Check for exact matches (case-insensitive)\r\n    const duplicateFound = existingFoods?.some(food => \r\n      food.name.toLowerCase() === foodName.toLowerCase() &&\r\n      (food.brand || '').toLowerCase() === foodBrand.toLowerCase()\r\n    );\r\n    \r\n    if (duplicateFound) {\r\n      duplicateWarning.style.display = 'block';\r\n    } else {\r\n      duplicateWarning.style.display = 'none';\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('Error checking for duplicates:', error);\r\n    duplicateWarning.style.display = 'none';\r\n  }\r\n}\r\n\r\n// Handle adding new food item\r\nasync function handleAddFood(event: Event): Promise<void> {\r\n  event.preventDefault();\r\n  \r\n  try {\r\n    // Check if current user is admin\r\n    const isAdmin = await isCurrentUserAdmin();\r\n    if (!isAdmin) {\r\n      showMessage('Only admins can add food items', 'error');\r\n      return;\r\n    }\r\n    \r\n    const form = event.target as HTMLFormElement;\r\n    const formData = new FormData(form);\r\n    \r\n    // Get current user for attribution\r\n    const user = await getCurrentUser();\r\n    let createdBy = 'Admin User';\r\n    \r\n    if (user) {\r\n      try {\r\n        const { data: profile } = await supabase\r\n          .from('user_profiles')\r\n          .select('name')\r\n          .eq('user_id', user.id)\r\n          .single();\r\n        \r\n        createdBy = profile?.name || user.email || 'Admin User';\r\n      } catch (error) {\r\n        createdBy = user.email || 'Admin User';\r\n      }\r\n    }\r\n\r\n    // Extract form data\r\n    const foodData = {\r\n      name: formData.get('foodName') as string,\r\n      brand: formData.get('foodBrand') as string || null,\r\n      carbs: parseFloat(formData.get('foodCarbs') as string) || 0,\r\n      fat: parseFloat(formData.get('foodFat') as string) || 0,\r\n      protein: parseFloat(formData.get('foodProtein') as string) || 0,\r\n      category: formData.get('foodCategory') as string || 'OTHER',\r\n      created_by: createdBy,\r\n      user_id: null  // Global food - accessible to all users\r\n    };\r\n    \r\n    // Validate required fields\r\n    if (!foodData.name.trim()) {\r\n      showMessage('Food name is required', 'error');\r\n      return;\r\n    }\r\n    \r\n    console.log('üçé Adding food with data:', foodData);\r\n    \r\n    // Insert food into database\r\n    const { error } = await supabase\r\n      .from('foods')\r\n      .insert(foodData);\r\n    \r\n    if (error) {\r\n      console.error('Error adding food:', error);\r\n      showMessage('Error adding food item', 'error');\r\n      return;\r\n    }\r\n    \r\n    showMessage(`Successfully added \"${foodData.name}\" to the food database`, 'success');\r\n    \r\n    // Reload food tracker if available\r\n    if (typeof (window as any).reloadFoodTracker === 'function') {\r\n      console.log('üîÑ Reloading food tracker...');\r\n      await (window as any).reloadFoodTracker();\r\n    }\r\n    \r\n    // Reload food dropdowns\r\n    await loadFoodsForEditDropdown();\r\n    \r\n    // Reset form\r\n    form.reset();\r\n    \r\n  } catch (error) {\r\n    console.error('Error adding food:', error);\r\n    showMessage('Error adding food item', 'error');\r\n  }\r\n}\r\n\r\n// MEAL MANAGEMENT FUNCTIONS\r\n// =====================================================\r\n\r\n// Load and display meal management section\r\nexport async function loadMealManagement(): Promise<void> {\r\n  if (mealManagementInitialized) {\r\n    console.log('üçΩÔ∏è Meal management already initialized');\r\n    return;\r\n  }\r\n  \r\n  console.log('üçΩÔ∏è Loading meal management...');\r\n  \r\n  // Load foods for ingredient dropdowns\r\n  await loadFoodsForIngredients();\r\n  \r\n  // Load meals for edit dropdown\r\n  await loadMealsForEditDropdown();\r\n  \r\n  // Load foods for edit dropdown\r\n  await loadFoodsForEditDropdown();\r\n  \r\n  // Setup meal form event listeners\r\n  setupMealManagementEventListeners();\r\n  \r\n  mealManagementInitialized = true;\r\n  console.log('‚úÖ Meal management loaded');\r\n  \r\n  // Set up meal picture event listeners\r\n  setTimeout(() => {\r\n    if (typeof (window as any).setupMealPictureEventListeners === 'function') {\r\n      (window as any).setupMealPictureEventListeners();\r\n    }\r\n  }, 100);\r\n}\r\n\r\nasync function loadFoodsForIngredients(): Promise<void> {\r\n  try {\r\n    // Only load if not already loaded\r\n    if (currentFoods.length > 0) {\r\n      console.log(`üì¶ Foods already loaded (${currentFoods.length} items)`);\r\n      return;\r\n    }\r\n    \r\n    const { data: foods, error } = await supabase\r\n      .from('foods')\r\n      .select('id, name, category')\r\n      .order('name');\r\n    \r\n    if (error) {\r\n      console.error('Error loading foods for ingredients:', error);\r\n      return;\r\n    }\r\n    \r\n    // Remove duplicates based on name and category combination\r\n    const uniqueFoods = foods?.filter((food, index, self) => \r\n      index === self.findIndex(f => \r\n        f.name.toLowerCase() === food.name.toLowerCase() && \r\n        f.category === food.category\r\n      )\r\n    ) || [];\r\n    \r\n    currentFoods = uniqueFoods;\r\n    console.log(`üì¶ Loaded ${currentFoods.length} unique foods for ingredient selection`);\r\n    \r\n    // Log if duplicates were found\r\n    const duplicateCount = (foods?.length || 0) - uniqueFoods.length;\r\n    if (duplicateCount > 0) {\r\n      console.warn(`‚ö†Ô∏è Found and removed ${duplicateCount} duplicate food entries`);\r\n      \r\n      // Log the duplicates for debugging\r\n      const duplicates = foods?.filter((food, index, self) => \r\n        self.findIndex(f => \r\n          f.name.toLowerCase() === food.name.toLowerCase() && \r\n          f.category === food.category\r\n        ) !== index\r\n      ) || [];\r\n      \r\n      console.warn('Duplicate foods found:', duplicates.map(d => `${d.name} (${d.category})`));\r\n    }\r\n    \r\n  } catch (error) {\r\n    console.error('Error loading foods for ingredients:', error);\r\n  }\r\n}\r\n\r\nfunction setupMealManagementEventListeners(): void {\r\n  const mealForm = document.getElementById('addMealForm') as HTMLFormElement;\r\n  \r\n  if (mealForm) {\r\n    mealForm.addEventListener('submit', handleAddMeal);\r\n    mealForm.addEventListener('reset', handleClearMealForm);\r\n  }\r\n}\r\n\r\n// Handle add meal form submission\r\nexport async function handleAddMeal(event: Event): Promise<void> {\r\n  event.preventDefault();\r\n  \r\n  const form = event.target as HTMLFormElement;\r\n  const formData = new FormData(form);\r\n  \r\n  try {\r\n    // Get form data\r\n    const mealName = formData.get('mealName') as string;\r\n    const mealType = formData.get('mealType') as string;\r\n    const mealPicture = formData.get('mealPicture') as string;\r\n    const cookingInstructions = formData.get('cookingInstructions') as string;\r\n    \r\n    // Get current user\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n      showMessage('You must be logged in to add meals', 'error');\r\n      return;\r\n    }\r\n    \r\n    if (ingredients.length === 0) {\r\n      showMessage('Please add at least one ingredient', 'error');\r\n      return;\r\n    }\r\n    \r\n    // Fetch nutritional data for each ingredient\r\n    const enrichedIngredients = await Promise.all(ingredients.map(async (ing) => {\r\n      try {\r\n        const { data: foodData, error } = await supabase\r\n          .from('foods')\r\n          .select('carbs, fat, protein')\r\n          .eq('id', ing.food_id)\r\n          .single();\r\n\r\n        if (error) {\r\n          console.warn(`Could not fetch nutrition data for food_id: ${ing.food_id}`);\r\n          return {\r\n            food_id: ing.food_id,\r\n            food_name: ing.food_name,\r\n            name: ing.food_name,\r\n            quantity: ing.quantity,\r\n            instructions: ing.instructions,\r\n            carbs: 0,\r\n            fat: 0,\r\n            protein: 0\r\n          };\r\n        }\r\n        \r\n        return {\r\n          food_id: ing.food_id,\r\n          food_name: ing.food_name,\r\n          name: ing.food_name,\r\n          quantity: ing.quantity,\r\n          instructions: ing.instructions,\r\n          carbs: foodData.carbs || 0,\r\n          fat: foodData.fat || 0,\r\n          protein: foodData.protein || 0\r\n        };\r\n      } catch (error) {\r\n        console.error(`Error fetching nutrition for ingredient ${ing.food_name}:`, error);\r\n        return {\r\n          food_id: ing.food_id,\r\n          food_name: ing.food_name,\r\n          name: ing.food_name,\r\n          quantity: ing.quantity,\r\n          instructions: ing.instructions,\r\n          carbs: 0,\r\n          fat: 0,\r\n          protein: 0\r\n        };\r\n      }\r\n    }));\r\n\r\n    // Calculate total nutrition\r\n    const totalCarbs = enrichedIngredients.reduce((sum, ing) => sum + (ing.carbs || 0), 0);\r\n    const totalFat = enrichedIngredients.reduce((sum, ing) => sum + (ing.fat || 0), 0);\r\n    const totalProtein = enrichedIngredients.reduce((sum, ing) => sum + (ing.protein || 0), 0);\r\n\r\n    // Create meal object - matching the actual database schema\r\n    const mealData = {\r\n      number: `M${Date.now()}`, // Generate a unique meal number\r\n      name: mealName.trim(),\r\n      meal_type: mealType,\r\n      picture: mealPicture?.trim() || null,\r\n      cooking_instructions: cookingInstructions?.trim() || null,\r\n      ingredients: JSON.stringify(enrichedIngredients),\r\n      total_carbs: totalCarbs,\r\n      total_fat: totalFat,\r\n      total_protein: totalProtein,\r\n      user_id: user.id, // Attribute to the logged-in user\r\n      created_by: user.email // Store the creator's email for display\r\n    };\r\n    \r\n    console.log('üçΩÔ∏è Creating meal:', mealData);\r\n    \r\n    // Insert meal into database\r\n    const { data, error } = await supabase\r\n      .from('meals')\r\n      .insert([mealData])\r\n      .select();\r\n    \r\n    if (error) {\r\n      console.error('Error creating meal:', error);\r\n      showMessage('Error creating meal: ' + error.message, 'error');\r\n      return;\r\n    }\r\n    \r\n    console.log('‚úÖ Meal created successfully:', data);\r\n    showMessage(`Successfully created meal: ${mealName}`, 'success');\r\n    \r\n    // Reload meals in the main meals section\r\n    if (typeof (window as any).reloadMeals === 'function') {\r\n      console.log('üîÑ Reloading meals display...');\r\n      await (window as any).reloadMeals();\r\n    }\r\n    \r\n    // Clear the form\r\n    form.reset();\r\n    handleClearMealForm();\r\n    \r\n  } catch (error) {\r\n    console.error('Error creating meal:', error);\r\n    showMessage('Error creating meal', 'error');\r\n  }\r\n}\r\n\r\n// Handle clear meal form\r\nfunction handleClearMealForm(): void {\r\n  ingredients = [];\r\n  // renderIngredientsList(); // Commented out - using simple-edit.ts system\r\n  \r\n  // Clear rich text editor\r\n  const editor = document.getElementById('cookingInstructions') as HTMLDivElement;\r\n  if (editor) {\r\n    editor.innerHTML = '';\r\n  }\r\n  \r\n  // Clear hidden input\r\n  const hiddenInput = document.getElementById('cookingInstructionsHidden') as HTMLInputElement;\r\n  if (hiddenInput) {\r\n    hiddenInput.value = '';\r\n  }\r\n  \r\n  // Clear picture preview\r\n  const preview = document.getElementById('mealPicturePreview') as HTMLImageElement;\r\n  const placeholder = document.getElementById('mealPicturePlaceholder') as HTMLElement;\r\n  const removeBtn = document.getElementById('removeMealPictureBtn') as HTMLButtonElement;\r\n  \r\n  if (preview && placeholder) {\r\n    preview.style.display = 'none';\r\n    placeholder.style.display = 'block';\r\n  }\r\n  if (removeBtn) {\r\n    removeBtn.style.display = 'none';\r\n  }\r\n}\r\n\r\n// DATABASE CLEANUP FUNCTIONS\r\n// =====================================================\r\n\r\n// Remove duplicate foods from database\r\n// Meal Editing Functions\r\n\r\nexport async function loadMealsForEditDropdown(): Promise<void> {\r\n  try {\r\n    const user = await getCurrentUser();\r\n    if (!user) return;\r\n\r\n    const isAdmin = await isCurrentUserAdmin();\r\n    if (!isAdmin) return;\r\n\r\n    // Load all meals (admin can edit all meals)\r\n    const { data: meals, error } = await supabase\r\n      .from('meals')\r\n      .select('*')\r\n      .order('name');\r\n\r\n    if (error) {\r\n      console.error('Error loading meals:', error);\r\n      return;\r\n    }\r\n\r\n    const dropdown = document.getElementById('mealSelectDropdown') as HTMLSelectElement;\r\n    if (!dropdown) return;\r\n\r\n    // Clear existing options except the first one\r\n    dropdown.innerHTML = '<option value=\"\">Choose a meal to edit...</option>';\r\n\r\n    if (!meals || meals.length === 0) {\r\n      dropdown.innerHTML += '<option value=\"\" disabled>No meals available</option>';\r\n      return;\r\n    }\r\n\r\n    // Add meals to dropdown\r\n    meals.forEach(meal => {\r\n      const option = document.createElement('option');\r\n      option.value = meal.id;\r\n      option.textContent = `${meal.name} (${meal.created_by || (meal.user_id ? 'User Recipe' : 'No Carb Coach')})`;\r\n      dropdown.appendChild(option);\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Error loading meals for dropdown:', error);\r\n  }\r\n}\r\n\r\nexport async function selectMealForEdit(mealId: string): Promise<void> {\r\n  try {\r\n    // If no meal selected, hide the form\r\n    const formContainer = document.getElementById('editMealFormContainer');\r\n    if (!mealId) {\r\n      if (formContainer) {\r\n        formContainer.style.display = 'none';\r\n      }\r\n      currentEditingMeal = null;\r\n      return;\r\n    }\r\n\r\n    // Fetch meal details\r\n    const { data: meal, error } = await supabase\r\n      .from('meals')\r\n      .select('*')\r\n      .eq('id', mealId)\r\n      .single();\r\n\r\n    if (error || !meal) {\r\n      console.error('Error fetching meal:', error);\r\n      showMessage('Error loading meal for editing', 'error');\r\n      return;\r\n    }\r\n\r\n    currentEditingMeal = meal;\r\n    await populateEditForm(meal);\r\n\r\n    // Show edit form\r\n    if (formContainer) {\r\n      formContainer.style.display = 'block';\r\n      formContainer.scrollIntoView({ behavior: 'smooth' });\r\n    }\r\n\r\n    console.log('Meal edit form populated with:', meal);\r\n  } catch (error) {\r\n    console.error('Error selecting meal for edit:', error);\r\n    showMessage('Error loading meal for editing', 'error');\r\n  }\r\n}\r\n\r\n// Populate edit form with meal data\r\nasync function populateEditForm(meal: any): Promise<void> {\r\n  const nameInput = document.getElementById('editMealName') as HTMLInputElement;\r\n  const typeSelect = document.getElementById('editMealType') as HTMLSelectElement;\r\n  const pictureInput = document.getElementById('editMealPicture') as HTMLInputElement;\r\n  const instructionsInput = document.getElementById('editCookingInstructions') as HTMLDivElement;\r\n  \r\n  if (nameInput) nameInput.value = meal.name || '';\r\n  if (typeSelect) typeSelect.value = meal.meal_type || '';\r\n  if (pictureInput) pictureInput.value = meal.picture || '';\r\n  if (instructionsInput) instructionsInput.innerHTML = meal.cooking_instructions || '';\r\n  \r\n  // Parse and set ingredients\r\n  try {\r\n    const parsedIngredients = typeof meal.ingredients === 'string' \r\n      ? JSON.parse(meal.ingredients) \r\n      : meal.ingredients || [];\r\n    \r\n    ingredientState.ingredients = parsedIngredients.map((ing: any) => ({\r\n      food_id: ing.food_id,\r\n      food_name: ing.food_name || ing.name,\r\n      quantity: ing.quantity,\r\n      instructions: ing.instructions || ''\r\n    }));\r\n    \r\n    // Render ingredients list\r\n    renderIngredientsList();\r\n  } catch (error) {\r\n    console.error('Error parsing ingredients:', error);\r\n    ingredientState.ingredients = [];\r\n    renderIngredientsList();\r\n  }\r\n}\r\n\r\n// Cancel meal edit\r\nexport function cancelMealEdit(): void {\r\n  const formContainer = document.getElementById('editMealFormContainer');\r\n  if (formContainer) {\r\n    formContainer.style.display = 'none';\r\n  }\r\n  currentEditingMeal = null;\r\n}\r\n\r\n// Delete meal from edit\r\nexport async function deleteMealFromEdit(): Promise<void> {\r\n  if (!currentEditingMeal) {\r\n    showMessage('No meal selected for deletion', 'error');\r\n    return;\r\n  }\r\n\r\n  const confirmed = confirm(`Are you sure you want to delete the meal \"${currentEditingMeal.name}\"?`);\r\n  if (!confirmed) return;\r\n\r\n  try {\r\n    const { error } = await supabase\r\n      .from('meals')\r\n      .delete()\r\n      .eq('id', currentEditingMeal.id);\r\n\r\n    if (error) throw error;\r\n\r\n    showMessage('Meal deleted successfully', 'success');\r\n    cancelMealEdit();\r\n    await loadMealsForEditDropdown();\r\n  } catch (error) {\r\n    console.error('Error deleting meal:', error);\r\n    showMessage('Error deleting meal', 'error');\r\n  }\r\n}\r\n\r\n// Select food for edit\r\nexport async function selectFoodForEdit(foodId: string): Promise<void> {\r\n  try {\r\n    // If no food selected, do nothing\r\n    if (!foodId) {\r\n      return;\r\n    }\r\n\r\n    // Find the food in currentFoods\r\n    const food = currentFoods.find(f => f.id === foodId);\r\n    if (!food) {\r\n      showMessage('Food not found', 'error');\r\n      return;\r\n    }\r\n\r\n    // Set the selected food ID in the ingredient modal state\r\n    ingredientState.currentFoodId = foodId;\r\n\r\n    // Open the ingredient modal in edit mode\r\n    openIngredientModal('edit_food', null);\r\n\r\n    console.log('Food edit modal opened with:', food);\r\n  } catch (error) {\r\n    console.error('Error selecting food for edit:', error);\r\n    showMessage('Error loading food for editing', 'error');\r\n  }\r\n}\r\n\r\n// Cancel food edit\r\nexport function cancelFoodEdit(): void {\r\n  closeIngredientModal();\r\n  const dropdown = document.getElementById('foodSelectDropdown') as HTMLSelectElement;\r\n  if (dropdown) {\r\n    dropdown.value = '';\r\n  }\r\n}\r\n\r\n// Delete food from edit\r\nexport async function deleteFoodFromEdit(): Promise<void> {\r\n  const dropdown = document.getElementById('foodSelectDropdown') as HTMLSelectElement;\r\n  const foodId = dropdown.value;\r\n\r\n  if (!foodId) {\r\n    showMessage('No food selected for deletion', 'error');\r\n    return;\r\n  }\r\n\r\n  const food = currentFoods.find(f => f.id === foodId);\r\n  if (!food) {\r\n    showMessage('Food not found', 'error');\r\n    return;\r\n  }\r\n\r\n  const confirmed = confirm(`Are you sure you want to delete \"${food.name}\"?`);\r\n  if (!confirmed) return;\r\n\r\n  try {\r\n    const { error } = await supabase\r\n      .from('foods')\r\n      .delete()\r\n      .eq('id', foodId);\r\n\r\n    if (error) throw error;\r\n\r\n    showMessage('Food deleted successfully', 'success');\r\n    closeIngredientModal();\r\n    await loadFoodsForEditDropdown();\r\n  } catch (error) {\r\n    console.error('Error deleting food:', error);\r\n    showMessage('Error deleting food', 'error');\r\n  }\r\n}\r\n\r\n// Add to window object\r\ndeclare global {\r\n  interface Window {\r\n    openIngredientModal: (operation: ModalOperation, idx?: number | null, foodId?: string | null) => void;\r\n    closeIngredientModal: () => void;\r\n    removeIngredient: (idx: number) => void;\r\n    selectMealForEdit: (mealId: string) => Promise<void>;\r\n    addIngredientRow: () => void;\r\n    removeIngredientRow: (button: HTMLElement) => void;\r\n    cancelMealEdit: () => void;\r\n    deleteMealFromEdit: () => Promise<void>;\r\n    selectFoodForEdit: (foodId: string) => Promise<void>;\r\n    cancelFoodEdit: () => void;\r\n    deleteFoodFromEdit: () => Promise<void>;\r\n    toggleUserRole: (userId: string, email: string, currentRole: string) => Promise<void>;\r\n    refreshUserList: () => Promise<void>;\r\n    deleteUserAccount: (userId: string, email: string) => Promise<void>;\r\n  }\r\n}\r\n\r\n// Note: Removed old ingredient modal functions - using simple-edit.ts system\r\n// window.openIngredientModal = openIngredientModal;\r\n// window.closeIngredientModal = closeIngredientModal;\r\n// window.removeIngredient = removeIngredient;\r\nwindow.selectMealForEdit = selectMealForEdit;\r\n// window.removeIngredientRow = removeIngredientRow;\r\nwindow.cancelMealEdit = cancelMealEdit;\r\nwindow.deleteMealFromEdit = deleteMealFromEdit;\r\nwindow.selectFoodForEdit = selectFoodForEdit;\r\nwindow.cancelFoodEdit = cancelFoodEdit;\r\nwindow.deleteFoodFromEdit = deleteFoodFromEdit;\r\nwindow.toggleUserRole = toggleUserRole;\r\nwindow.refreshUserList = refreshUserList;\r\nwindow.deleteUserAccount = deleteUserAccount;\r\n\r\n// ... existing code ...\r\n\r\nexport function setupAdminSection() {\r\n    const adminSection = document.getElementById('admin');\r\n    if (!adminSection) return;\r\n\r\n    adminSection.innerHTML = `\r\n        <div class=\"section-header\">\r\n            <h2>Admin Panel</h2>\r\n        </div>\r\n        <hr>\r\n        <div class=\"admin-grid\">\r\n            <!-- Create Food Column -->\r\n            <div class=\"admin-column\">\r\n                <h3>Create Food</h3>\r\n                <form id=\"createFoodForm\" class=\"admin-form\">\r\n                    <div class=\"form-group\">\r\n                        <label for=\"foodName\">Food Name *</label>\r\n                        <input type=\"text\" id=\"foodName\" required placeholder=\"e.g., Chicken Breast\">\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label for=\"foodBrand\">Brand</label>\r\n                        <input type=\"text\" id=\"foodBrand\" placeholder=\"e.g., Woolworths\">\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label for=\"foodCategory\">Category *</label>\r\n                        <select id=\"foodCategory\" required>\r\n                            <option value=\"\">Select a category...</option>\r\n                            <option value=\"VEGETABLES\">Vegetables</option>\r\n                            <option value=\"SALAD\">Salad</option>\r\n                            <option value=\"DAIRY\">Dairy</option>\r\n                            <option value=\"PROTEIN\">Protein</option>\r\n                            <option value=\"CONDIMENTS\">Condiments</option>\r\n                            <option value=\"DRINKS\">Drinks</option>\r\n                            <option value=\"OTHER\">Other</option>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label for=\"foodCarbs\">Carbs (g) *</label>\r\n                        <input type=\"number\" id=\"foodCarbs\" required min=\"0\" step=\"0.1\">\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label for=\"foodFat\">Fat (g) *</label>\r\n                        <input type=\"number\" id=\"foodFat\" required min=\"0\" step=\"0.1\">\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label for=\"foodProtein\">Protein (g) *</label>\r\n                        <input type=\"number\" id=\"foodProtein\" required min=\"0\" step=\"0.1\">\r\n                    </div>\r\n                    <button type=\"submit\" class=\"primary-btn\">Create Food</button>\r\n                </form>\r\n            </div>\r\n\r\n            <!-- Create Meal Column -->\r\n            <div class=\"admin-column\">\r\n                <h3>Create Meal</h3>\r\n                <form id=\"createMealForm\" class=\"admin-form\">\r\n                    <div class=\"form-group\">\r\n                        <label for=\"mealName\">Meal Name *</label>\r\n                        <input type=\"text\" id=\"mealName\" required placeholder=\"e.g., Bacon and Eggs Breakfast\">\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label for=\"mealType\">Meal Type *</label>\r\n                        <select id=\"mealType\" required>\r\n                            <option value=\"\">Select Type</option>\r\n                            <option value=\"BREAKFAST\">Breakfast</option>\r\n                            <option value=\"LUNCH\">Lunch</option>\r\n                            <option value=\"DINNER\">Dinner</option>\r\n                            <option value=\"SNACK\">Snack</option>\r\n                            <option value=\"DESSERT\">Dessert</option>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"form-group\">\r\n                        <label for=\"mealInstructions\">Cooking Instructions</label>\r\n                        <textarea id=\"mealInstructions\" rows=\"3\" placeholder=\"Optional cooking or preparation instructions\"></textarea>\r\n                    </div>\r\n                    <button type=\"submit\" class=\"primary-btn\">Create Meal</button>\r\n                </form>\r\n            </div>\r\n\r\n            <!-- Edit Column -->\r\n            <div class=\"admin-column\">\r\n                <h3>Edit Items</h3>\r\n                <div class=\"edit-buttons\">\r\n                    <button onclick=\"openEditFoodModal()\" class=\"secondary-btn\">Edit Food</button>\r\n                    <button onclick=\"openEditMealModal()\" class=\"secondary-btn\">Edit Meal</button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- Admin Footer with Version -->\r\n        <div style=\"margin-top: 50px; text-align: center; padding: 15px; background-color: #f8fafc; border-radius: 8px;\">\r\n            <p style=\"margin: 0; color: #22c55e; font-weight: 600; font-size: 1.2rem;\">NutriValor Version: V0.8.001</p>\r\n        </div>\r\n    `;\r\n\r\n    // Setup event listeners\r\n    setupAdminEventListeners();\r\n}\r\n\r\nfunction setupAdminEventListeners() {\r\n    // Setup form submission handlers\r\n    const createFoodForm = document.getElementById('createFoodForm') as HTMLFormElement;\r\n    const createMealForm = document.getElementById('createMealForm') as HTMLFormElement;\r\n\r\n    if (createFoodForm) {\r\n        createFoodForm.addEventListener('submit', async (e) => {\r\n            e.preventDefault();\r\n            const foodData = {\r\n                name: (document.getElementById('foodName') as HTMLInputElement).value,\r\n                brand: (document.getElementById('foodBrand') as HTMLInputElement).value,\r\n                category: (document.getElementById('foodCategory') as HTMLSelectElement).value,\r\n                carbs: parseFloat((document.getElementById('foodCarbs') as HTMLInputElement).value),\r\n                fat: parseFloat((document.getElementById('foodFat') as HTMLInputElement).value),\r\n                protein: parseFloat((document.getElementById('foodProtein') as HTMLInputElement).value)\r\n            };\r\n            await createFood(foodData);\r\n            createFoodForm.reset();\r\n        });\r\n    }\r\n\r\n    if (createMealForm) {\r\n        createMealForm.addEventListener('submit', async (e) => {\r\n            e.preventDefault();\r\n            const mealData = {\r\n                name: (document.getElementById('mealName') as HTMLInputElement).value,\r\n                meal_type: (document.getElementById('mealType') as HTMLSelectElement).value,\r\n                cooking_instructions: (document.getElementById('mealInstructions') as HTMLTextAreaElement).value,\r\n                ingredients: []\r\n            };\r\n            await createMeal(mealData);\r\n            createMealForm.reset();\r\n        });\r\n    }\r\n}\r\n\r\nasync function createFood(foodData: any) {\r\n    try {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) {\r\n            showMessage('Please log in to create food items', 'error');\r\n            return;\r\n        }\r\n\r\n        const { data, error } = await supabase\r\n            .from('foods')\r\n            .insert([{\r\n                ...foodData,\r\n                user_id: user.id,\r\n                created_by: user.email\r\n            }]);\r\n\r\n        if (error) {\r\n            showMessage('Error creating food: ' + error.message, 'error');\r\n            return;\r\n        }\r\n\r\n        showMessage('Food created successfully!', 'success');\r\n        await loadAndDisplayFoods(); // Refresh the food list\r\n    } catch (error) {\r\n        console.error('Error in createFood:', error);\r\n        showMessage('Error creating food', 'error');\r\n    }\r\n}\r\n\r\nasync function createMeal(mealData: any) {\r\n    try {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) {\r\n            showMessage('Please log in to create meals', 'error');\r\n            return;\r\n        }\r\n\r\n        const { data, error } = await supabase\r\n            .from('meals')\r\n            .insert([{\r\n                ...mealData,\r\n                user_id: user.id,\r\n                created_by: user.email,\r\n                ingredients: JSON.stringify(mealData.ingredients)\r\n            }]);\r\n\r\n        if (error) {\r\n            showMessage('Error creating meal: ' + error.message, 'error');\r\n            return;\r\n        }\r\n\r\n        showMessage('Meal created successfully!', 'success');\r\n        await loadMealsFromDatabase(); // Refresh the meals list\r\n    } catch (error) {\r\n        console.error('Error in createMeal:', error);\r\n        showMessage('Error creating meal', 'error');\r\n    }\r\n}\r\n\r\n// window.addIngredientRow = addIngredientRow;\r\n\r\n "],"names":["currentUsers","currentFoods","currentEditingMeal","initializeAdmin","updateRoleDisplay","loadUserList","loadFoodManagement","error","showMessage","roleElement","role","getCurrentUserRole","container","users","supabase","displayUserList","userListHTML","user","joinDate","lastLogin","isConfirmed","roleClass","generateRoleButtons","toggleUserRole","userId","email","currentRole","isCurrentUserSuperAdmin","newRole","action","_a","getCurrentUser","deleteUserAccount","refreshUserList","message","type","messageEl","loadFoodsForEditDropdown","foods","dropdown","food","option","loadAndDisplayFoods","setupFoodManagementEventListeners","addFoodForm","handleAddFood","foodNameInput","foodBrandInput","checkForDuplicates","duplicateWarning","foodName","foodBrand","query","existingFoods","event","isCurrentUserAdmin","form","formData","createdBy","profile","foodData","loadMealsForEditDropdown","meals","meal","selectMealForEdit","mealId","formContainer","populateEditForm","nameInput","typeSelect","pictureInput","instructionsInput","parsedIngredients","ing","cancelMealEdit","deleteMealFromEdit","selectFoodForEdit","foodId","f","cancelFoodEdit","deleteFoodFromEdit"],"mappings":"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"}