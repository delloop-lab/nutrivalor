(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();const gr="modulepreload",pr=function(n){return"/"+n},dn={},A=function(e,t,o){let r=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),a=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));r=Promise.allSettled(t.map(l=>{if(l=pr(l),l in dn)return;dn[l]=!0;const c=l.endsWith(".css"),d=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${d}`))return;const u=document.createElement("link");if(u.rel=c?"stylesheet":gr,c||(u.as="script"),u.crossOrigin="",u.href=l,a&&u.setAttribute("nonce",a),document.head.appendChild(u),c)return new Promise((f,h)=>{u.addEventListener("load",f),u.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(s){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=s,window.dispatchEvent(a),!a.defaultPrevented)throw s}return r.then(s=>{for(const a of s||[])a.status==="rejected"&&i(a.reason);return e().catch(i)})},mr=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>A(async()=>{const{default:o}=await Promise.resolve().then(()=>Le);return{default:o}},void 0).then(({default:o})=>o(...t)):e=fetch,(...t)=>e(...t)};class Ut extends Error{constructor(e,t="FunctionsError",o){super(e),this.name=t,this.context=o}}class yr extends Ut{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class vr extends Ut{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class wr extends Ut{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var Ct;(function(n){n.Any="any",n.ApNortheast1="ap-northeast-1",n.ApNortheast2="ap-northeast-2",n.ApSouth1="ap-south-1",n.ApSoutheast1="ap-southeast-1",n.ApSoutheast2="ap-southeast-2",n.CaCentral1="ca-central-1",n.EuCentral1="eu-central-1",n.EuWest1="eu-west-1",n.EuWest2="eu-west-2",n.EuWest3="eu-west-3",n.SaEast1="sa-east-1",n.UsEast1="us-east-1",n.UsWest1="us-west-1",n.UsWest2="us-west-2"})(Ct||(Ct={}));var _r=function(n,e,t,o){function r(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function a(d){try{c(o.next(d))}catch(u){s(u)}}function l(d){try{c(o.throw(d))}catch(u){s(u)}}function c(d){d.done?i(d.value):r(d.value).then(a,l)}c((o=o.apply(n,e||[])).next())})};class br{constructor(e,{headers:t={},customFetch:o,region:r=Ct.Any}={}){this.url=e,this.headers=t,this.region=r,this.fetch=mr(o)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var o;return _r(this,void 0,void 0,function*(){try{const{headers:r,method:i,body:s}=t;let a={},{region:l}=t;l||(l=this.region),l&&l!=="any"&&(a["x-region"]=l);let c;s&&(r&&!Object.prototype.hasOwnProperty.call(r,"Content-Type")||!r)&&(typeof Blob<"u"&&s instanceof Blob||s instanceof ArrayBuffer?(a["Content-Type"]="application/octet-stream",c=s):typeof s=="string"?(a["Content-Type"]="text/plain",c=s):typeof FormData<"u"&&s instanceof FormData?c=s:(a["Content-Type"]="application/json",c=JSON.stringify(s)));const d=yield this.fetch(`${this.url}/${e}`,{method:i||"POST",headers:Object.assign(Object.assign(Object.assign({},a),this.headers),r),body:c}).catch(g=>{throw new yr(g)}),u=d.headers.get("x-relay-error");if(u&&u==="true")throw new vr(d);if(!d.ok)throw new wr(d);let f=((o=d.headers.get("Content-Type"))!==null&&o!==void 0?o:"text/plain").split(";")[0].trim(),h;return f==="application/json"?h=yield d.json():f==="application/octet-stream"?h=yield d.blob():f==="text/event-stream"?h=d:f==="multipart/form-data"?h=yield d.formData():h=yield d.text(),{data:h,error:null}}catch(r){return{data:null,error:r}}})}}var Q=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Er(n){if(n.__esModule)return n;var e=n.default;if(typeof e=="function"){var t=function o(){return this instanceof o?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(n).forEach(function(o){var r=Object.getOwnPropertyDescriptor(n,o);Object.defineProperty(t,o,r.get?r:{enumerable:!0,get:function(){return n[o]}})}),t}var H={},jt={},at={},Ve={},lt={},ct={},Sr=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},Ae=Sr();const Ir=Ae.fetch,Ln=Ae.fetch.bind(Ae),Fn=Ae.Headers,kr=Ae.Request,$r=Ae.Response,Le=Object.freeze(Object.defineProperty({__proto__:null,Headers:Fn,Request:kr,Response:$r,default:Ln,fetch:Ir},Symbol.toStringTag,{value:"Module"})),Pr=Er(Le);var dt={};Object.defineProperty(dt,"__esModule",{value:!0});let Cr=class extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}};dt.default=Cr;var Bn=Q&&Q.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(ct,"__esModule",{value:!0});const Tr=Bn(Pr),Ar=Bn(dt);let xr=class{constructor(e){this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=e.headers,this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=e.shouldThrowOnError,this.signal=e.signal,this.isMaybeSingle=e.isMaybeSingle,e.fetch?this.fetch=e.fetch:typeof fetch>"u"?this.fetch=Tr.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(e,t){return this.headers=Object.assign({},this.headers),this.headers[e]=t,this}then(e,t){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers["Accept-Profile"]=this.schema:this.headers["Content-Profile"]=this.schema),this.method!=="GET"&&this.method!=="HEAD"&&(this.headers["Content-Type"]="application/json");const o=this.fetch;let r=o(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async i=>{var s,a,l;let c=null,d=null,u=null,f=i.status,h=i.statusText;if(i.ok){if(this.method!=="HEAD"){const w=await i.text();w===""||(this.headers.Accept==="text/csv"||this.headers.Accept&&this.headers.Accept.includes("application/vnd.pgrst.plan+text")?d=w:d=JSON.parse(w))}const p=(s=this.headers.Prefer)===null||s===void 0?void 0:s.match(/count=(exact|planned|estimated)/),m=(a=i.headers.get("content-range"))===null||a===void 0?void 0:a.split("/");p&&m&&m.length>1&&(u=parseInt(m[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(d)&&(d.length>1?(c={code:"PGRST116",details:`Results contain ${d.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},d=null,u=null,f=406,h="Not Acceptable"):d.length===1?d=d[0]:d=null)}else{const p=await i.text();try{c=JSON.parse(p),Array.isArray(c)&&i.status===404&&(d=[],c=null,f=200,h="OK")}catch{i.status===404&&p===""?(f=204,h="No Content"):c={message:p}}if(c&&this.isMaybeSingle&&(!((l=c==null?void 0:c.details)===null||l===void 0)&&l.includes("0 rows"))&&(c=null,f=200,h="OK"),c&&this.shouldThrowOnError)throw new Ar.default(c)}return{error:c,data:d,count:u,status:f,statusText:h}});return this.shouldThrowOnError||(r=r.catch(i=>{var s,a,l;return{error:{message:`${(s=i==null?void 0:i.name)!==null&&s!==void 0?s:"FetchError"}: ${i==null?void 0:i.message}`,details:`${(a=i==null?void 0:i.stack)!==null&&a!==void 0?a:""}`,hint:"",code:`${(l=i==null?void 0:i.code)!==null&&l!==void 0?l:""}`},data:null,count:null,status:0,statusText:""}})),r.then(e,t)}returns(){return this}overrideTypes(){return this}};ct.default=xr;var Lr=Q&&Q.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(lt,"__esModule",{value:!0});const Fr=Lr(ct);let Br=class extends Fr.default{select(e){let t=!1;const o=(e??"*").split("").map(r=>/\s/.test(r)&&!t?"":(r==='"'&&(t=!t),r)).join("");return this.url.searchParams.set("select",o),this.headers.Prefer&&(this.headers.Prefer+=","),this.headers.Prefer+="return=representation",this}order(e,{ascending:t=!0,nullsFirst:o,foreignTable:r,referencedTable:i=r}={}){const s=i?`${i}.order`:"order",a=this.url.searchParams.get(s);return this.url.searchParams.set(s,`${a?`${a},`:""}${e}.${t?"asc":"desc"}${o===void 0?"":o?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:o=t}={}){const r=typeof o>"u"?"limit":`${o}.limit`;return this.url.searchParams.set(r,`${e}`),this}range(e,t,{foreignTable:o,referencedTable:r=o}={}){const i=typeof r>"u"?"offset":`${r}.offset`,s=typeof r>"u"?"limit":`${r}.limit`;return this.url.searchParams.set(i,`${e}`),this.url.searchParams.set(s,`${t-e+1}`),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.Accept="application/vnd.pgrst.object+json",this}maybeSingle(){return this.method==="GET"?this.headers.Accept="application/json":this.headers.Accept="application/vnd.pgrst.object+json",this.isMaybeSingle=!0,this}csv(){return this.headers.Accept="text/csv",this}geojson(){return this.headers.Accept="application/geo+json",this}explain({analyze:e=!1,verbose:t=!1,settings:o=!1,buffers:r=!1,wal:i=!1,format:s="text"}={}){var a;const l=[e?"analyze":null,t?"verbose":null,o?"settings":null,r?"buffers":null,i?"wal":null].filter(Boolean).join("|"),c=(a=this.headers.Accept)!==null&&a!==void 0?a:"application/json";return this.headers.Accept=`application/vnd.pgrst.plan+${s}; for="${c}"; options=${l};`,s==="json"?this:this}rollback(){var e;return((e=this.headers.Prefer)!==null&&e!==void 0?e:"").trim().length>0?this.headers.Prefer+=",tx=rollback":this.headers.Prefer="tx=rollback",this}returns(){return this}};lt.default=Br;var Mr=Q&&Q.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(Ve,"__esModule",{value:!0});const Or=Mr(lt);let Dr=class extends Or.default{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}in(e,t){const o=Array.from(new Set(t)).map(r=>typeof r=="string"&&new RegExp("[,()]").test(r)?`"${r}"`:`${r}`).join(",");return this.url.searchParams.append(e,`in.(${o})`),this}contains(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return typeof t=="string"?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:o,type:r}={}){let i="";r==="plain"?i="pl":r==="phrase"?i="ph":r==="websearch"&&(i="w");const s=o===void 0?"":`(${o})`;return this.url.searchParams.append(e,`${i}fts${s}.${t}`),this}match(e){return Object.entries(e).forEach(([t,o])=>{this.url.searchParams.append(t,`eq.${o}`)}),this}not(e,t,o){return this.url.searchParams.append(e,`not.${t}.${o}`),this}or(e,{foreignTable:t,referencedTable:o=t}={}){const r=o?`${o}.or`:"or";return this.url.searchParams.append(r,`(${e})`),this}filter(e,t,o){return this.url.searchParams.append(e,`${t}.${o}`),this}};Ve.default=Dr;var Rr=Q&&Q.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(at,"__esModule",{value:!0});const Ue=Rr(Ve);let Ur=class{constructor(e,{headers:t={},schema:o,fetch:r}){this.url=e,this.headers=t,this.schema=o,this.fetch=r}select(e,{head:t=!1,count:o}={}){const r=t?"HEAD":"GET";let i=!1;const s=(e??"*").split("").map(a=>/\s/.test(a)&&!i?"":(a==='"'&&(i=!i),a)).join("");return this.url.searchParams.set("select",s),o&&(this.headers.Prefer=`count=${o}`),new Ue.default({method:r,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}insert(e,{count:t,defaultToNull:o=!0}={}){const r="POST",i=[];if(this.headers.Prefer&&i.push(this.headers.Prefer),t&&i.push(`count=${t}`),o||i.push("missing=default"),this.headers.Prefer=i.join(","),Array.isArray(e)){const s=e.reduce((a,l)=>a.concat(Object.keys(l)),[]);if(s.length>0){const a=[...new Set(s)].map(l=>`"${l}"`);this.url.searchParams.set("columns",a.join(","))}}return new Ue.default({method:r,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}upsert(e,{onConflict:t,ignoreDuplicates:o=!1,count:r,defaultToNull:i=!0}={}){const s="POST",a=[`resolution=${o?"ignore":"merge"}-duplicates`];if(t!==void 0&&this.url.searchParams.set("on_conflict",t),this.headers.Prefer&&a.push(this.headers.Prefer),r&&a.push(`count=${r}`),i||a.push("missing=default"),this.headers.Prefer=a.join(","),Array.isArray(e)){const l=e.reduce((c,d)=>c.concat(Object.keys(d)),[]);if(l.length>0){const c=[...new Set(l)].map(d=>`"${d}"`);this.url.searchParams.set("columns",c.join(","))}}return new Ue.default({method:s,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}update(e,{count:t}={}){const o="PATCH",r=[];return this.headers.Prefer&&r.push(this.headers.Prefer),t&&r.push(`count=${t}`),this.headers.Prefer=r.join(","),new Ue.default({method:o,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}delete({count:e}={}){const t="DELETE",o=[];return e&&o.push(`count=${e}`),this.headers.Prefer&&o.unshift(this.headers.Prefer),this.headers.Prefer=o.join(","),new Ue.default({method:t,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}};at.default=Ur;var ut={},ht={};Object.defineProperty(ht,"__esModule",{value:!0});ht.version=void 0;ht.version="0.0.0-automated";Object.defineProperty(ut,"__esModule",{value:!0});ut.DEFAULT_HEADERS=void 0;const jr=ht;ut.DEFAULT_HEADERS={"X-Client-Info":`postgrest-js/${jr.version}`};var Mn=Q&&Q.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(jt,"__esModule",{value:!0});const qr=Mn(at),Nr=Mn(Ve),Hr=ut;let Wr=class On{constructor(e,{headers:t={},schema:o,fetch:r}={}){this.url=e,this.headers=Object.assign(Object.assign({},Hr.DEFAULT_HEADERS),t),this.schemaName=o,this.fetch=r}from(e){const t=new URL(`${this.url}/${e}`);return new qr.default(t,{headers:Object.assign({},this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new On(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:o=!1,get:r=!1,count:i}={}){let s;const a=new URL(`${this.url}/rpc/${e}`);let l;o||r?(s=o?"HEAD":"GET",Object.entries(t).filter(([d,u])=>u!==void 0).map(([d,u])=>[d,Array.isArray(u)?`{${u.join(",")}}`:`${u}`]).forEach(([d,u])=>{a.searchParams.append(d,u)})):(s="POST",l=t);const c=Object.assign({},this.headers);return i&&(c.Prefer=`count=${i}`),new Nr.default({method:s,url:a,headers:c,schema:this.schemaName,body:l,fetch:this.fetch,allowEmpty:!1})}};jt.default=Wr;var Fe=Q&&Q.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(H,"__esModule",{value:!0});H.PostgrestError=H.PostgrestBuilder=H.PostgrestTransformBuilder=H.PostgrestFilterBuilder=H.PostgrestQueryBuilder=H.PostgrestClient=void 0;const Dn=Fe(jt);H.PostgrestClient=Dn.default;const Rn=Fe(at);H.PostgrestQueryBuilder=Rn.default;const Un=Fe(Ve);H.PostgrestFilterBuilder=Un.default;const jn=Fe(lt);H.PostgrestTransformBuilder=jn.default;const qn=Fe(ct);H.PostgrestBuilder=qn.default;const Nn=Fe(dt);H.PostgrestError=Nn.default;var zr=H.default={PostgrestClient:Dn.default,PostgrestQueryBuilder:Rn.default,PostgrestFilterBuilder:Un.default,PostgrestTransformBuilder:jn.default,PostgrestBuilder:qn.default,PostgrestError:Nn.default};const{PostgrestClient:Gr,PostgrestQueryBuilder:Fl,PostgrestFilterBuilder:Bl,PostgrestTransformBuilder:Ml,PostgrestBuilder:Ol,PostgrestError:Dl}=zr;function Vr(){if(typeof WebSocket<"u")return WebSocket;if(typeof global.WebSocket<"u")return global.WebSocket;if(typeof window.WebSocket<"u")return window.WebSocket;if(typeof self.WebSocket<"u")return self.WebSocket;throw new Error("`WebSocket` is not supported in this environment")}const Jr=Vr(),Kr="2.11.15",Qr=`realtime-js/${Kr}`,Xr="1.0.0",Hn=1e4,Yr=1e3;var qe;(function(n){n[n.connecting=0]="connecting",n[n.open=1]="open",n[n.closing=2]="closing",n[n.closed=3]="closed"})(qe||(qe={}));var D;(function(n){n.closed="closed",n.errored="errored",n.joined="joined",n.joining="joining",n.leaving="leaving"})(D||(D={}));var Y;(function(n){n.close="phx_close",n.error="phx_error",n.join="phx_join",n.reply="phx_reply",n.leave="phx_leave",n.access_token="access_token"})(Y||(Y={}));var Tt;(function(n){n.websocket="websocket"})(Tt||(Tt={}));var me;(function(n){n.Connecting="connecting",n.Open="open",n.Closing="closing",n.Closed="closed"})(me||(me={}));class Zr{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t(typeof e=="string"?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),o=new TextDecoder;return this._decodeBroadcast(e,t,o)}_decodeBroadcast(e,t,o){const r=t.getUint8(1),i=t.getUint8(2);let s=this.HEADER_LENGTH+2;const a=o.decode(e.slice(s,s+r));s=s+r;const l=o.decode(e.slice(s,s+i));s=s+i;const c=JSON.parse(o.decode(e.slice(s,e.byteLength)));return{ref:null,topic:a,event:l,payload:c}}}class Wn{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var C;(function(n){n.abstime="abstime",n.bool="bool",n.date="date",n.daterange="daterange",n.float4="float4",n.float8="float8",n.int2="int2",n.int4="int4",n.int4range="int4range",n.int8="int8",n.int8range="int8range",n.json="json",n.jsonb="jsonb",n.money="money",n.numeric="numeric",n.oid="oid",n.reltime="reltime",n.text="text",n.time="time",n.timestamp="timestamp",n.timestamptz="timestamptz",n.timetz="timetz",n.tsrange="tsrange",n.tstzrange="tstzrange"})(C||(C={}));const un=(n,e,t={})=>{var o;const r=(o=t.skipTypes)!==null&&o!==void 0?o:[];return Object.keys(e).reduce((i,s)=>(i[s]=ei(s,n,e,r),i),{})},ei=(n,e,t,o)=>{const r=e.find(a=>a.name===n),i=r==null?void 0:r.type,s=t[n];return i&&!o.includes(i)?zn(i,s):At(s)},zn=(n,e)=>{if(n.charAt(0)==="_"){const t=n.slice(1,n.length);return ri(e,t)}switch(n){case C.bool:return ti(e);case C.float4:case C.float8:case C.int2:case C.int4:case C.int8:case C.numeric:case C.oid:return ni(e);case C.json:case C.jsonb:return oi(e);case C.timestamp:return ii(e);case C.abstime:case C.date:case C.daterange:case C.int4range:case C.int8range:case C.money:case C.reltime:case C.text:case C.time:case C.timestamptz:case C.timetz:case C.tsrange:case C.tstzrange:return At(e);default:return At(e)}},At=n=>n,ti=n=>{switch(n){case"t":return!0;case"f":return!1;default:return n}},ni=n=>{if(typeof n=="string"){const e=parseFloat(n);if(!Number.isNaN(e))return e}return n},oi=n=>{if(typeof n=="string")try{return JSON.parse(n)}catch(e){return console.log(`JSON parse error: ${e}`),n}return n},ri=(n,e)=>{if(typeof n!="string")return n;const t=n.length-1,o=n[t];if(n[0]==="{"&&o==="}"){let i;const s=n.slice(1,t);try{i=JSON.parse("["+s+"]")}catch{i=s?s.split(","):[]}return i.map(a=>zn(e,a))}return n},ii=n=>typeof n=="string"?n.replace(" ","T"):n,Gn=n=>{let e=n;return e=e.replace(/^ws/i,"http"),e=e.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),e.replace(/\/+$/,"")};class _t{constructor(e,t,o={},r=Hn){this.channel=e,this.event=t,this.payload=o,this.timeout=r,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var o;return this._hasReceived(e)&&t((o=this.receivedResp)===null||o===void 0?void 0:o.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(o=>o.status===e).forEach(o=>o.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var hn;(function(n){n.SYNC="sync",n.JOIN="join",n.LEAVE="leave"})(hn||(hn={}));class Ne{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const o=(t==null?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(o.state,{},r=>{const{onJoin:i,onLeave:s,onSync:a}=this.caller;this.joinRef=this.channel._joinRef(),this.state=Ne.syncState(this.state,r,i,s),this.pendingDiffs.forEach(l=>{this.state=Ne.syncDiff(this.state,l,i,s)}),this.pendingDiffs=[],a()}),this.channel._on(o.diff,{},r=>{const{onJoin:i,onLeave:s,onSync:a}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(r):(this.state=Ne.syncDiff(this.state,r,i,s),a())}),this.onJoin((r,i,s)=>{this.channel._trigger("presence",{event:"join",key:r,currentPresences:i,newPresences:s})}),this.onLeave((r,i,s)=>{this.channel._trigger("presence",{event:"leave",key:r,currentPresences:i,leftPresences:s})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,o,r){const i=this.cloneDeep(e),s=this.transformState(t),a={},l={};return this.map(i,(c,d)=>{s[c]||(l[c]=d)}),this.map(s,(c,d)=>{const u=i[c];if(u){const f=d.map(m=>m.presence_ref),h=u.map(m=>m.presence_ref),g=d.filter(m=>h.indexOf(m.presence_ref)<0),p=u.filter(m=>f.indexOf(m.presence_ref)<0);g.length>0&&(a[c]=g),p.length>0&&(l[c]=p)}else a[c]=d}),this.syncDiff(i,{joins:a,leaves:l},o,r)}static syncDiff(e,t,o,r){const{joins:i,leaves:s}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return o||(o=()=>{}),r||(r=()=>{}),this.map(i,(a,l)=>{var c;const d=(c=e[a])!==null&&c!==void 0?c:[];if(e[a]=this.cloneDeep(l),d.length>0){const u=e[a].map(h=>h.presence_ref),f=d.filter(h=>u.indexOf(h.presence_ref)<0);e[a].unshift(...f)}o(a,d,l)}),this.map(s,(a,l)=>{let c=e[a];if(!c)return;const d=l.map(u=>u.presence_ref);c=c.filter(u=>d.indexOf(u.presence_ref)<0),e[a]=c,r(a,c,l),c.length===0&&delete e[a]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(o=>t(o,e[o]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,o)=>{const r=e[o];return"metas"in r?t[o]=r.metas.map(i=>(i.presence_ref=i.phx_ref,delete i.phx_ref,delete i.phx_ref_prev,i)):t[o]=r,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var fn;(function(n){n.ALL="*",n.INSERT="INSERT",n.UPDATE="UPDATE",n.DELETE="DELETE"})(fn||(fn={}));var gn;(function(n){n.BROADCAST="broadcast",n.PRESENCE="presence",n.POSTGRES_CHANGES="postgres_changes",n.SYSTEM="system"})(gn||(gn={}));var oe;(function(n){n.SUBSCRIBED="SUBSCRIBED",n.TIMED_OUT="TIMED_OUT",n.CLOSED="CLOSED",n.CHANNEL_ERROR="CHANNEL_ERROR"})(oe||(oe={}));class qt{constructor(e,t={config:{}},o){this.topic=e,this.params=t,this.socket=o,this.bindings={},this.state=D.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:""},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new _t(this,Y.join,this.params,this.timeout),this.rejoinTimer=new Wn(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=D.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(r=>r.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=D.closed,this.socket._remove(this)}),this._onError(r=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,r),this.state=D.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=D.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Y.reply,{},(r,i)=>{this._trigger(this._replyEventName(i),r)}),this.presence=new Ne(this),this.broadcastEndpointURL=Gn(this.socket.endPoint)+"/api/broadcast",this.private=this.params.config.private||!1}subscribe(e,t=this.timeout){var o,r;if(this.socket.isConnected()||this.socket.connect(),this.state==D.closed){const{config:{broadcast:i,presence:s,private:a}}=this.params;this._onError(d=>e==null?void 0:e(oe.CHANNEL_ERROR,d)),this._onClose(()=>e==null?void 0:e(oe.CLOSED));const l={},c={broadcast:i,presence:s,postgres_changes:(r=(o=this.bindings.postgres_changes)===null||o===void 0?void 0:o.map(d=>d.filter))!==null&&r!==void 0?r:[],private:a};this.socket.accessTokenValue&&(l.access_token=this.socket.accessTokenValue),this.updateJoinPayload(Object.assign({config:c},l)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:d})=>{var u;if(this.socket.setAuth(),d===void 0){e==null||e(oe.SUBSCRIBED);return}else{const f=this.bindings.postgres_changes,h=(u=f==null?void 0:f.length)!==null&&u!==void 0?u:0,g=[];for(let p=0;p<h;p++){const m=f[p],{filter:{event:w,schema:_,table:v,filter:b}}=m,k=d&&d[p];if(k&&k.event===w&&k.schema===_&&k.table===v&&k.filter===b)g.push(Object.assign(Object.assign({},m),{id:k.id}));else{this.unsubscribe(),this.state=D.errored,e==null||e(oe.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=g,e&&e(oe.SUBSCRIBED);return}}).receive("error",d=>{this.state=D.errored,e==null||e(oe.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(d).join(", ")||"error")))}).receive("timeout",()=>{e==null||e(oe.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,o){return this._on(e,t,o)}async send(e,t={}){var o,r;if(!this._canPush()&&e.type==="broadcast"){const{event:i,payload:s}=e,l={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:i,payload:s,private:this.private}]})};try{const c=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(o=t.timeout)!==null&&o!==void 0?o:this.timeout);return await((r=c.body)===null||r===void 0?void 0:r.cancel()),c.ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(i=>{var s,a,l;const c=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((l=(a=(s=this.params)===null||s===void 0?void 0:s.config)===null||a===void 0?void 0:a.broadcast)===null||l===void 0)&&l.ack)&&i("ok"),c.receive("ok",()=>i("ok")),c.receive("error",()=>i("error")),c.receive("timeout",()=>i("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=D.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Y.close,"leave",this._joinRef())};this.joinPush.destroy();let o=null;return new Promise(r=>{o=new _t(this,Y.leave,{},e),o.receive("ok",()=>{t(),r("ok")}).receive("timeout",()=>{t(),r("timed out")}).receive("error",()=>{r("error")}),o.send(),this._canPush()||o.trigger("ok",{})}).finally(()=>{o==null||o.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.rejoinTimer&&clearTimeout(this.rejoinTimer.timer),this.joinPush.destroy()}async _fetchWithTimeout(e,t,o){const r=new AbortController,i=setTimeout(()=>r.abort(),o),s=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:r.signal}));return clearTimeout(i),s}_push(e,t,o=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let r=new _t(this,e,t,o);return this._canPush()?r.send():(r.startTimeout(),this.pushBuffer.push(r)),r}_onMessage(e,t,o){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,o){var r,i;const s=e.toLocaleLowerCase(),{close:a,error:l,leave:c,join:d}=Y;if(o&&[a,l,c,d].indexOf(s)>=0&&o!==this._joinRef())return;let f=this._onMessage(s,t,o);if(t&&!f)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(s)?(r=this.bindings.postgres_changes)===null||r===void 0||r.filter(h=>{var g,p,m;return((g=h.filter)===null||g===void 0?void 0:g.event)==="*"||((m=(p=h.filter)===null||p===void 0?void 0:p.event)===null||m===void 0?void 0:m.toLocaleLowerCase())===s}).map(h=>h.callback(f,o)):(i=this.bindings[s])===null||i===void 0||i.filter(h=>{var g,p,m,w,_,v;if(["broadcast","presence","postgres_changes"].includes(s))if("id"in h){const b=h.id,k=(g=h.filter)===null||g===void 0?void 0:g.event;return b&&((p=t.ids)===null||p===void 0?void 0:p.includes(b))&&(k==="*"||(k==null?void 0:k.toLocaleLowerCase())===((m=t.data)===null||m===void 0?void 0:m.type.toLocaleLowerCase()))}else{const b=(_=(w=h==null?void 0:h.filter)===null||w===void 0?void 0:w.event)===null||_===void 0?void 0:_.toLocaleLowerCase();return b==="*"||b===((v=t==null?void 0:t.event)===null||v===void 0?void 0:v.toLocaleLowerCase())}else return h.type.toLocaleLowerCase()===s}).map(h=>{if(typeof f=="object"&&"ids"in f){const g=f.data,{schema:p,table:m,commit_timestamp:w,type:_,errors:v}=g;f=Object.assign(Object.assign({},{schema:p,table:m,commit_timestamp:w,eventType:_,new:{},old:{},errors:v}),this._getPayloadRecords(g))}h.callback(f,o)})}_isClosed(){return this.state===D.closed}_isJoined(){return this.state===D.joined}_isJoining(){return this.state===D.joining}_isLeaving(){return this.state===D.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,o){const r=e.toLocaleLowerCase(),i={type:r,filter:t,callback:o};return this.bindings[r]?this.bindings[r].push(i):this.bindings[r]=[i],this}_off(e,t){const o=e.toLocaleLowerCase();return this.bindings[o]=this.bindings[o].filter(r=>{var i;return!(((i=r.type)===null||i===void 0?void 0:i.toLocaleLowerCase())===o&&qt.isEqual(r.filter,t))}),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const o in e)if(e[o]!==t[o])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(Y.close,{},e)}_onError(e){this._on(Y.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=D.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=un(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=un(e.columns,e.old_record)),t}}const pn=()=>{},si=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class ai{constructor(e,t){var o;this.accessTokenValue=null,this.apiKey=null,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=Hn,this.heartbeatIntervalMs=25e3,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=pn,this.ref=0,this.logger=pn,this.conn=null,this.sendBuffer=[],this.serializer=new Zr,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._resolveFetch=i=>{let s;return i?s=i:typeof fetch>"u"?s=(...a)=>A(async()=>{const{default:l}=await Promise.resolve().then(()=>Le);return{default:l}},void 0).then(({default:l})=>l(...a)):s=fetch,(...a)=>s(...a)},this.endPoint=`${e}/${Tt.websocket}`,this.httpEndpoint=Gn(e),t!=null&&t.transport?this.transport=t.transport:this.transport=null,t!=null&&t.params&&(this.params=t.params),t!=null&&t.timeout&&(this.timeout=t.timeout),t!=null&&t.logger&&(this.logger=t.logger),(t!=null&&t.logLevel||t!=null&&t.log_level)&&(this.logLevel=t.logLevel||t.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),t!=null&&t.heartbeatIntervalMs&&(this.heartbeatIntervalMs=t.heartbeatIntervalMs);const r=(o=t==null?void 0:t.params)===null||o===void 0?void 0:o.apikey;if(r&&(this.accessTokenValue=r,this.apiKey=r),this.reconnectAfterMs=t!=null&&t.reconnectAfterMs?t.reconnectAfterMs:i=>[1e3,2e3,5e3,1e4][i-1]||1e4,this.encode=t!=null&&t.encode?t.encode:(i,s)=>s(JSON.stringify(i)),this.decode=t!=null&&t.decode?t.decode:this.serializer.decode.bind(this.serializer),this.reconnectTimer=new Wn(async()=>{this.disconnect(),this.connect()},this.reconnectAfterMs),this.fetch=this._resolveFetch(t==null?void 0:t.fetch),t!=null&&t.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.worker=(t==null?void 0:t.worker)||!1,this.workerUrl=t==null?void 0:t.workerUrl}this.accessToken=(t==null?void 0:t.accessToken)||null}connect(){if(!this.conn){if(this.transport||(this.transport=Jr),!this.transport)throw new Error("No transport provided");this.conn=new this.transport(this.endpointURL()),this.setupConnection()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:Xr}))}disconnect(e,t){this.conn&&(this.conn.onclose=function(){},e?this.conn.close(e,t??""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset(),this.channels.forEach(o=>o.teardown()))}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,o){this.logger(e,t,o)}connectionState(){switch(this.conn&&this.conn.readyState){case qe.connecting:return me.Connecting;case qe.open:return me.Open;case qe.closing:return me.Closing;default:return me.Closed}}isConnected(){return this.connectionState()===me.Open}channel(e,t={config:{}}){const o=`realtime:${e}`,r=this.getChannels().find(i=>i.topic===o);if(r)return r;{const i=new qt(`realtime:${e}`,t,this);return this.channels.push(i),i}}push(e){const{topic:t,event:o,payload:r,ref:i}=e,s=()=>{this.encode(e,a=>{var l;(l=this.conn)===null||l===void 0||l.send(a)})};this.log("push",`${t} ${o} (${i})`,r),this.isConnected()?s():this.sendBuffer.push(s)}async setAuth(e=null){let t=e||this.accessToken&&await this.accessToken()||this.accessTokenValue;this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(o=>{const r={access_token:t,version:Qr};t&&o.updateJoinPayload(r),o.joinedOnce&&o._isJoined()&&o._push(Y.access_token,{access_token:t})}))}async sendHeartbeat(){var e;if(!this.isConnected()){this.heartbeatCallback("disconnected");return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.heartbeatCallback("timeout"),(e=this.conn)===null||e===void 0||e.close(Yr,"hearbeat timeout");return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatCallback("sent"),await this.setAuth()}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(o=>o.topic===e&&(o._isJoined()||o._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}setupConnection(){this.conn&&(this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_onConnMessage(e){this.decode(e.data,t=>{let{topic:o,event:r,payload:i,ref:s}=t;o==="phoenix"&&r==="phx_reply"&&this.heartbeatCallback(t.payload.status=="ok"?"ok":"error"),s&&s===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null),this.log("receive",`${i.status||""} ${o} ${r} ${s&&"("+s+")"||""}`,i),Array.from(this.channels).filter(a=>a._isMember(o)).forEach(a=>a._trigger(r,i,s)),this.stateChangeCallbacks.message.forEach(a=>a(t))})}_onConnOpen(){this.log("transport",`connected to ${this.endpointURL()}`),this.flushSendBuffer(),this.reconnectTimer.reset(),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this.stateChangeCallbacks.open.forEach(e=>e())}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this.workerRef.terminate()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_onConnClose(e){this.log("transport","close",e),this._triggerChanError(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(t=>t(e))}_onConnError(e){this.log("transport",`${e}`),this._triggerChanError(),this.stateChangeCallbacks.error.forEach(t=>t(e))}_triggerChanError(){this.channels.forEach(e=>e._trigger(Y.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const o=e.match(/\?/)?"&":"?",r=new URLSearchParams(t);return`${e}${o}${r}`}_workerObjectUrl(e){let t;if(e)t=e;else{const o=new Blob([si],{type:"application/javascript"});t=URL.createObjectURL(o)}return t}}class Nt extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function B(n){return typeof n=="object"&&n!==null&&"__isStorageError"in n}class li extends Nt{constructor(e,t){super(e),this.name="StorageApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class xt extends Nt{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}var ci=function(n,e,t,o){function r(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function a(d){try{c(o.next(d))}catch(u){s(u)}}function l(d){try{c(o.throw(d))}catch(u){s(u)}}function c(d){d.done?i(d.value):r(d.value).then(a,l)}c((o=o.apply(n,e||[])).next())})};const Vn=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>A(async()=>{const{default:o}=await Promise.resolve().then(()=>Le);return{default:o}},void 0).then(({default:o})=>o(...t)):e=fetch,(...t)=>e(...t)},di=()=>ci(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield A(()=>Promise.resolve().then(()=>Le),void 0)).Response:Response}),Lt=n=>{if(Array.isArray(n))return n.map(t=>Lt(t));if(typeof n=="function"||n!==Object(n))return n;const e={};return Object.entries(n).forEach(([t,o])=>{const r=t.replace(/([-_][a-z])/gi,i=>i.toUpperCase().replace(/[-_]/g,""));e[r]=Lt(o)}),e};var be=function(n,e,t,o){function r(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function a(d){try{c(o.next(d))}catch(u){s(u)}}function l(d){try{c(o.throw(d))}catch(u){s(u)}}function c(d){d.done?i(d.value):r(d.value).then(a,l)}c((o=o.apply(n,e||[])).next())})};const bt=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),ui=(n,e,t)=>be(void 0,void 0,void 0,function*(){const o=yield di();n instanceof o&&!(t!=null&&t.noResolveJson)?n.json().then(r=>{e(new li(bt(r),n.status||500))}).catch(r=>{e(new xt(bt(r),r))}):e(new xt(bt(n),n))}),hi=(n,e,t,o)=>{const r={method:n,headers:(e==null?void 0:e.headers)||{}};return n==="GET"?r:(r.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),o&&(r.body=JSON.stringify(o)),Object.assign(Object.assign({},r),t))};function Je(n,e,t,o,r,i){return be(this,void 0,void 0,function*(){return new Promise((s,a)=>{n(t,hi(e,o,r,i)).then(l=>{if(!l.ok)throw l;return o!=null&&o.noResolveJson?l:l.json()}).then(l=>s(l)).catch(l=>ui(l,a,o))})})}function ot(n,e,t,o){return be(this,void 0,void 0,function*(){return Je(n,"GET",e,t,o)})}function le(n,e,t,o,r){return be(this,void 0,void 0,function*(){return Je(n,"POST",e,o,r,t)})}function fi(n,e,t,o,r){return be(this,void 0,void 0,function*(){return Je(n,"PUT",e,o,r,t)})}function gi(n,e,t,o){return be(this,void 0,void 0,function*(){return Je(n,"HEAD",e,Object.assign(Object.assign({},t),{noResolveJson:!0}),o)})}function Jn(n,e,t,o,r){return be(this,void 0,void 0,function*(){return Je(n,"DELETE",e,o,r,t)})}var N=function(n,e,t,o){function r(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function a(d){try{c(o.next(d))}catch(u){s(u)}}function l(d){try{c(o.throw(d))}catch(u){s(u)}}function c(d){d.done?i(d.value):r(d.value).then(a,l)}c((o=o.apply(n,e||[])).next())})};const pi={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},mn={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class mi{constructor(e,t={},o,r){this.url=e,this.headers=t,this.bucketId=o,this.fetch=Vn(r)}uploadOrUpdate(e,t,o,r){return N(this,void 0,void 0,function*(){try{let i;const s=Object.assign(Object.assign({},mn),r);let a=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(s.upsert)});const l=s.metadata;typeof Blob<"u"&&o instanceof Blob?(i=new FormData,i.append("cacheControl",s.cacheControl),l&&i.append("metadata",this.encodeMetadata(l)),i.append("",o)):typeof FormData<"u"&&o instanceof FormData?(i=o,i.append("cacheControl",s.cacheControl),l&&i.append("metadata",this.encodeMetadata(l))):(i=o,a["cache-control"]=`max-age=${s.cacheControl}`,a["content-type"]=s.contentType,l&&(a["x-metadata"]=this.toBase64(this.encodeMetadata(l)))),r!=null&&r.headers&&(a=Object.assign(Object.assign({},a),r.headers));const c=this._removeEmptyFolders(t),d=this._getFinalPath(c),u=yield this.fetch(`${this.url}/object/${d}`,Object.assign({method:e,body:i,headers:a},s!=null&&s.duplex?{duplex:s.duplex}:{})),f=yield u.json();return u.ok?{data:{path:c,id:f.Id,fullPath:f.Key},error:null}:{data:null,error:f}}catch(i){if(B(i))return{data:null,error:i};throw i}})}upload(e,t,o){return N(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,o)})}uploadToSignedUrl(e,t,o,r){return N(this,void 0,void 0,function*(){const i=this._removeEmptyFolders(e),s=this._getFinalPath(i),a=new URL(this.url+`/object/upload/sign/${s}`);a.searchParams.set("token",t);try{let l;const c=Object.assign({upsert:mn.upsert},r),d=Object.assign(Object.assign({},this.headers),{"x-upsert":String(c.upsert)});typeof Blob<"u"&&o instanceof Blob?(l=new FormData,l.append("cacheControl",c.cacheControl),l.append("",o)):typeof FormData<"u"&&o instanceof FormData?(l=o,l.append("cacheControl",c.cacheControl)):(l=o,d["cache-control"]=`max-age=${c.cacheControl}`,d["content-type"]=c.contentType);const u=yield this.fetch(a.toString(),{method:"PUT",body:l,headers:d}),f=yield u.json();return u.ok?{data:{path:i,fullPath:f.Key},error:null}:{data:null,error:f}}catch(l){if(B(l))return{data:null,error:l};throw l}})}createSignedUploadUrl(e,t){return N(this,void 0,void 0,function*(){try{let o=this._getFinalPath(e);const r=Object.assign({},this.headers);t!=null&&t.upsert&&(r["x-upsert"]="true");const i=yield le(this.fetch,`${this.url}/object/upload/sign/${o}`,{},{headers:r}),s=new URL(this.url+i.url),a=s.searchParams.get("token");if(!a)throw new Nt("No token returned by API");return{data:{signedUrl:s.toString(),path:e,token:a},error:null}}catch(o){if(B(o))return{data:null,error:o};throw o}})}update(e,t,o){return N(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,o)})}move(e,t,o){return N(this,void 0,void 0,function*(){try{return{data:yield le(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:o==null?void 0:o.destinationBucket},{headers:this.headers}),error:null}}catch(r){if(B(r))return{data:null,error:r};throw r}})}copy(e,t,o){return N(this,void 0,void 0,function*(){try{return{data:{path:(yield le(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:o==null?void 0:o.destinationBucket},{headers:this.headers})).Key},error:null}}catch(r){if(B(r))return{data:null,error:r};throw r}})}createSignedUrl(e,t,o){return N(this,void 0,void 0,function*(){try{let r=this._getFinalPath(e),i=yield le(this.fetch,`${this.url}/object/sign/${r}`,Object.assign({expiresIn:t},o!=null&&o.transform?{transform:o.transform}:{}),{headers:this.headers});const s=o!=null&&o.download?`&download=${o.download===!0?"":o.download}`:"";return i={signedUrl:encodeURI(`${this.url}${i.signedURL}${s}`)},{data:i,error:null}}catch(r){if(B(r))return{data:null,error:r};throw r}})}createSignedUrls(e,t,o){return N(this,void 0,void 0,function*(){try{const r=yield le(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),i=o!=null&&o.download?`&download=${o.download===!0?"":o.download}`:"";return{data:r.map(s=>Object.assign(Object.assign({},s),{signedUrl:s.signedURL?encodeURI(`${this.url}${s.signedURL}${i}`):null})),error:null}}catch(r){if(B(r))return{data:null,error:r};throw r}})}download(e,t){return N(this,void 0,void 0,function*(){const r=typeof(t==null?void 0:t.transform)<"u"?"render/image/authenticated":"object",i=this.transformOptsToQueryString((t==null?void 0:t.transform)||{}),s=i?`?${i}`:"";try{const a=this._getFinalPath(e);return{data:yield(yield ot(this.fetch,`${this.url}/${r}/${a}${s}`,{headers:this.headers,noResolveJson:!0})).blob(),error:null}}catch(a){if(B(a))return{data:null,error:a};throw a}})}info(e){return N(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const o=yield ot(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:Lt(o),error:null}}catch(o){if(B(o))return{data:null,error:o};throw o}})}exists(e){return N(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield gi(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(o){if(B(o)&&o instanceof xt){const r=o.originalError;if([400,404].includes(r==null?void 0:r.status))return{data:!1,error:o}}throw o}})}getPublicUrl(e,t){const o=this._getFinalPath(e),r=[],i=t!=null&&t.download?`download=${t.download===!0?"":t.download}`:"";i!==""&&r.push(i);const a=typeof(t==null?void 0:t.transform)<"u"?"render/image":"object",l=this.transformOptsToQueryString((t==null?void 0:t.transform)||{});l!==""&&r.push(l);let c=r.join("&");return c!==""&&(c=`?${c}`),{data:{publicUrl:encodeURI(`${this.url}/${a}/public/${o}${c}`)}}}remove(e){return N(this,void 0,void 0,function*(){try{return{data:yield Jn(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(B(t))return{data:null,error:t};throw t}})}list(e,t,o){return N(this,void 0,void 0,function*(){try{const r=Object.assign(Object.assign(Object.assign({},pi),t),{prefix:e||""});return{data:yield le(this.fetch,`${this.url}/object/list/${this.bucketId}`,r,{headers:this.headers},o),error:null}}catch(r){if(B(r))return{data:null,error:r};throw r}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const yi="2.7.1",vi={"X-Client-Info":`storage-js/${yi}`};var Se=function(n,e,t,o){function r(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function a(d){try{c(o.next(d))}catch(u){s(u)}}function l(d){try{c(o.throw(d))}catch(u){s(u)}}function c(d){d.done?i(d.value):r(d.value).then(a,l)}c((o=o.apply(n,e||[])).next())})};class wi{constructor(e,t={},o){this.url=e,this.headers=Object.assign(Object.assign({},vi),t),this.fetch=Vn(o)}listBuckets(){return Se(this,void 0,void 0,function*(){try{return{data:yield ot(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(B(e))return{data:null,error:e};throw e}})}getBucket(e){return Se(this,void 0,void 0,function*(){try{return{data:yield ot(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(B(t))return{data:null,error:t};throw t}})}createBucket(e,t={public:!1}){return Se(this,void 0,void 0,function*(){try{return{data:yield le(this.fetch,`${this.url}/bucket`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(o){if(B(o))return{data:null,error:o};throw o}})}updateBucket(e,t){return Se(this,void 0,void 0,function*(){try{return{data:yield fi(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(o){if(B(o))return{data:null,error:o};throw o}})}emptyBucket(e){return Se(this,void 0,void 0,function*(){try{return{data:yield le(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(B(t))return{data:null,error:t};throw t}})}deleteBucket(e){return Se(this,void 0,void 0,function*(){try{return{data:yield Jn(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(B(t))return{data:null,error:t};throw t}})}}class _i extends wi{constructor(e,t={},o){super(e,t,o)}from(e){return new mi(this.url,this.headers,e,this.fetch)}}const bi="2.50.2";let je="";typeof Deno<"u"?je="deno":typeof document<"u"?je="web":typeof navigator<"u"&&navigator.product==="ReactNative"?je="react-native":je="node";const Ei={"X-Client-Info":`supabase-js-${je}/${bi}`},Si={headers:Ei},Ii={schema:"public"},ki={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},$i={};var Pi=function(n,e,t,o){function r(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function a(d){try{c(o.next(d))}catch(u){s(u)}}function l(d){try{c(o.throw(d))}catch(u){s(u)}}function c(d){d.done?i(d.value):r(d.value).then(a,l)}c((o=o.apply(n,e||[])).next())})};const Ci=n=>{let e;return n?e=n:typeof fetch>"u"?e=Ln:e=fetch,(...t)=>e(...t)},Ti=()=>typeof Headers>"u"?Fn:Headers,Ai=(n,e,t)=>{const o=Ci(t),r=Ti();return(i,s)=>Pi(void 0,void 0,void 0,function*(){var a;const l=(a=yield e())!==null&&a!==void 0?a:n;let c=new r(s==null?void 0:s.headers);return c.has("apikey")||c.set("apikey",n),c.has("Authorization")||c.set("Authorization",`Bearer ${l}`),o(i,Object.assign(Object.assign({},s),{headers:c}))})};var xi=function(n,e,t,o){function r(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function a(d){try{c(o.next(d))}catch(u){s(u)}}function l(d){try{c(o.throw(d))}catch(u){s(u)}}function c(d){d.done?i(d.value):r(d.value).then(a,l)}c((o=o.apply(n,e||[])).next())})};function Li(n){return n.endsWith("/")?n:n+"/"}function Fi(n,e){var t,o;const{db:r,auth:i,realtime:s,global:a}=n,{db:l,auth:c,realtime:d,global:u}=e,f={db:Object.assign(Object.assign({},l),r),auth:Object.assign(Object.assign({},c),i),realtime:Object.assign(Object.assign({},d),s),global:Object.assign(Object.assign(Object.assign({},u),a),{headers:Object.assign(Object.assign({},(t=u==null?void 0:u.headers)!==null&&t!==void 0?t:{}),(o=a==null?void 0:a.headers)!==null&&o!==void 0?o:{})}),accessToken:()=>xi(this,void 0,void 0,function*(){return""})};return n.accessToken?f.accessToken=n.accessToken:delete f.accessToken,f}const Kn="2.70.0",Pe=30*1e3,Ft=3,Et=Ft*Pe,Bi="http://localhost:9999",Mi="supabase.auth.token",Oi={"X-Client-Info":`gotrue-js/${Kn}`},Bt="X-Supabase-Api-Version",Qn={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},Di=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,Ri=6e5;class Ht extends Error{constructor(e,t,o){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=o}}function E(n){return typeof n=="object"&&n!==null&&"__isAuthError"in n}class Ui extends Ht{constructor(e,t,o){super(e,t,o),this.name="AuthApiError",this.status=t,this.code=o}}function ji(n){return E(n)&&n.name==="AuthApiError"}class Xn extends Ht{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class he extends Ht{constructor(e,t,o,r){super(e,o,r),this.name=t,this.status=o}}class ae extends he{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function qi(n){return E(n)&&n.name==="AuthSessionMissingError"}class Qe extends he{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class Xe extends he{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class Ye extends he{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function Ni(n){return E(n)&&n.name==="AuthImplicitGrantRedirectError"}class yn extends he{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class Mt extends he{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function St(n){return E(n)&&n.name==="AuthRetryableFetchError"}class vn extends he{constructor(e,t,o){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=o}}class He extends he{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const rt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),wn=` 	
\r=`.split(""),Hi=(()=>{const n=new Array(128);for(let e=0;e<n.length;e+=1)n[e]=-1;for(let e=0;e<wn.length;e+=1)n[wn[e].charCodeAt(0)]=-2;for(let e=0;e<rt.length;e+=1)n[rt[e].charCodeAt(0)]=e;return n})();function _n(n,e,t){if(n!==null)for(e.queue=e.queue<<8|n,e.queuedBits+=8;e.queuedBits>=6;){const o=e.queue>>e.queuedBits-6&63;t(rt[o]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const o=e.queue>>e.queuedBits-6&63;t(rt[o]),e.queuedBits-=6}}function Yn(n,e,t){const o=Hi[n];if(o>-1)for(e.queue=e.queue<<6|o,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(o===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(n)}"`)}}function bn(n){const e=[],t=s=>{e.push(String.fromCodePoint(s))},o={utf8seq:0,codepoint:0},r={queue:0,queuedBits:0},i=s=>{Gi(s,o,t)};for(let s=0;s<n.length;s+=1)Yn(n.charCodeAt(s),r,i);return e.join("")}function Wi(n,e){if(n<=127){e(n);return}else if(n<=2047){e(192|n>>6),e(128|n&63);return}else if(n<=65535){e(224|n>>12),e(128|n>>6&63),e(128|n&63);return}else if(n<=1114111){e(240|n>>18),e(128|n>>12&63),e(128|n>>6&63),e(128|n&63);return}throw new Error(`Unrecognized Unicode codepoint: ${n.toString(16)}`)}function zi(n,e){for(let t=0;t<n.length;t+=1){let o=n.charCodeAt(t);if(o>55295&&o<=56319){const r=(o-55296)*1024&65535;o=(n.charCodeAt(t+1)-56320&65535|r)+65536,t+=1}Wi(o,e)}}function Gi(n,e,t){if(e.utf8seq===0){if(n<=127){t(n);return}for(let o=1;o<6;o+=1)if(!(n>>7-o&1)){e.utf8seq=o;break}if(e.utf8seq===2)e.codepoint=n&31;else if(e.utf8seq===3)e.codepoint=n&15;else if(e.utf8seq===4)e.codepoint=n&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(n<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|n&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function Vi(n){const e=[],t={queue:0,queuedBits:0},o=r=>{e.push(r)};for(let r=0;r<n.length;r+=1)Yn(n.charCodeAt(r),t,o);return new Uint8Array(e)}function Ji(n){const e=[];return zi(n,t=>e.push(t)),new Uint8Array(e)}function Ki(n){const e=[],t={queue:0,queuedBits:0},o=r=>{e.push(r)};return n.forEach(r=>_n(r,t,o)),_n(null,t,o),e.join("")}function Qi(n){return Math.round(Date.now()/1e3)+n}function Xi(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){const e=Math.random()*16|0;return(n=="x"?e:e&3|8).toString(16)})}const X=()=>typeof window<"u"&&typeof document<"u",ge={tested:!1,writable:!1},We=()=>{if(!X())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(ge.tested)return ge.writable;const n=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(n,n),globalThis.localStorage.removeItem(n),ge.tested=!0,ge.writable=!0}catch{ge.tested=!0,ge.writable=!1}return ge.writable};function Yi(n){const e={},t=new URL(n);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((r,i)=>{e[i]=r})}catch{}return t.searchParams.forEach((o,r)=>{e[r]=o}),e}const Zn=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>A(async()=>{const{default:o}=await Promise.resolve().then(()=>Le);return{default:o}},void 0).then(({default:o})=>o(...t)):e=fetch,(...t)=>e(...t)},Zi=n=>typeof n=="object"&&n!==null&&"status"in n&&"ok"in n&&"json"in n&&typeof n.json=="function",eo=async(n,e,t)=>{await n.setItem(e,JSON.stringify(t))},Ze=async(n,e)=>{const t=await n.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},et=async(n,e)=>{await n.removeItem(e)};class ft{constructor(){this.promise=new ft.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}ft.promiseConstructor=Promise;function It(n){const e=n.split(".");if(e.length!==3)throw new He("Invalid JWT structure");for(let o=0;o<e.length;o++)if(!Di.test(e[o]))throw new He("JWT not in base64url format");return{header:JSON.parse(bn(e[0])),payload:JSON.parse(bn(e[1])),signature:Vi(e[2]),raw:{header:e[0],payload:e[1]}}}async function es(n){return await new Promise(e=>{setTimeout(()=>e(null),n)})}function ts(n,e){return new Promise((o,r)=>{(async()=>{for(let i=0;i<1/0;i++)try{const s=await n(i);if(!e(i,null,s)){o(s);return}}catch(s){if(!e(i,s)){r(s);return}}})()})}function ns(n){return("0"+n.toString(16)).substr(-2)}function os(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",o=t.length;let r="";for(let i=0;i<56;i++)r+=t.charAt(Math.floor(Math.random()*o));return r}return crypto.getRandomValues(e),Array.from(e,ns).join("")}async function rs(n){const t=new TextEncoder().encode(n),o=await crypto.subtle.digest("SHA-256",t),r=new Uint8Array(o);return Array.from(r).map(i=>String.fromCharCode(i)).join("")}async function is(n){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),n;const t=await rs(n);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function Ie(n,e,t=!1){const o=os();let r=o;t&&(r+="/PASSWORD_RECOVERY"),await eo(n,`${e}-code-verifier`,r);const i=await is(o);return[i,o===i?"plain":"s256"]}const ss=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function as(n){const e=n.headers.get(Bt);if(!e||!e.match(ss))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function ls(n){if(!n)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(n<=e)throw new Error("JWT has expired")}function cs(n){switch(n){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const ds=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function ke(n){if(!ds.test(n))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}var us=function(n,e){var t={};for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&e.indexOf(o)<0&&(t[o]=n[o]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,o=Object.getOwnPropertySymbols(n);r<o.length;r++)e.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(n,o[r])&&(t[o[r]]=n[o[r]]);return t};const pe=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),hs=[502,503,504];async function En(n){var e;if(!Zi(n))throw new Mt(pe(n),0);if(hs.includes(n.status))throw new Mt(pe(n),n.status);let t;try{t=await n.json()}catch(i){throw new Xn(pe(i),i)}let o;const r=as(n);if(r&&r.getTime()>=Qn["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?o=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(o=t.error_code),o){if(o==="weak_password")throw new vn(pe(t),n.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(o==="session_not_found")throw new ae}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((i,s)=>i&&typeof s=="string",!0))throw new vn(pe(t),n.status,t.weak_password.reasons);throw new Ui(pe(t),n.status||500,o)}const fs=(n,e,t,o)=>{const r={method:n,headers:(e==null?void 0:e.headers)||{}};return n==="GET"?r:(r.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),r.body=JSON.stringify(o),Object.assign(Object.assign({},r),t))};async function S(n,e,t,o){var r;const i=Object.assign({},o==null?void 0:o.headers);i[Bt]||(i[Bt]=Qn["2024-01-01"].name),o!=null&&o.jwt&&(i.Authorization=`Bearer ${o.jwt}`);const s=(r=o==null?void 0:o.query)!==null&&r!==void 0?r:{};o!=null&&o.redirectTo&&(s.redirect_to=o.redirectTo);const a=Object.keys(s).length?"?"+new URLSearchParams(s).toString():"",l=await gs(n,e,t+a,{headers:i,noResolveJson:o==null?void 0:o.noResolveJson},{},o==null?void 0:o.body);return o!=null&&o.xform?o==null?void 0:o.xform(l):{data:Object.assign({},l),error:null}}async function gs(n,e,t,o,r,i){const s=fs(e,o,r,i);let a;try{a=await n(t,Object.assign({},s))}catch(l){throw console.error(l),new Mt(pe(l),0)}if(a.ok||await En(a),o!=null&&o.noResolveJson)return a;try{return await a.json()}catch(l){await En(l)}}function ne(n){var e;let t=null;vs(n)&&(t=Object.assign({},n),n.expires_at||(t.expires_at=Qi(n.expires_in)));const o=(e=n.user)!==null&&e!==void 0?e:n;return{data:{session:t,user:o},error:null}}function Sn(n){const e=ne(n);return!e.error&&n.weak_password&&typeof n.weak_password=="object"&&Array.isArray(n.weak_password.reasons)&&n.weak_password.reasons.length&&n.weak_password.message&&typeof n.weak_password.message=="string"&&n.weak_password.reasons.reduce((t,o)=>t&&typeof o=="string",!0)&&(e.data.weak_password=n.weak_password),e}function ce(n){var e;return{data:{user:(e=n.user)!==null&&e!==void 0?e:n},error:null}}function ps(n){return{data:n,error:null}}function ms(n){const{action_link:e,email_otp:t,hashed_token:o,redirect_to:r,verification_type:i}=n,s=us(n,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),a={action_link:e,email_otp:t,hashed_token:o,redirect_to:r,verification_type:i},l=Object.assign({},s);return{data:{properties:a,user:l},error:null}}function ys(n){return n}function vs(n){return n.access_token&&n.refresh_token&&n.expires_in}const kt=["global","local","others"];var ws=function(n,e){var t={};for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&e.indexOf(o)<0&&(t[o]=n[o]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,o=Object.getOwnPropertySymbols(n);r<o.length;r++)e.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(n,o[r])&&(t[o[r]]=n[o[r]]);return t};class _s{constructor({url:e="",headers:t={},fetch:o}){this.url=e,this.headers=t,this.fetch=Zn(o),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(e,t=kt[0]){if(kt.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${kt.join(", ")}`);try{return await S(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(o){if(E(o))return{data:null,error:o};throw o}}async inviteUserByEmail(e,t={}){try{return await S(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:ce})}catch(o){if(E(o))return{data:{user:null},error:o};throw o}}async generateLink(e){try{const{options:t}=e,o=ws(e,["options"]),r=Object.assign(Object.assign({},o),t);return"newEmail"in o&&(r.new_email=o==null?void 0:o.newEmail,delete r.newEmail),await S(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:r,headers:this.headers,xform:ms,redirectTo:t==null?void 0:t.redirectTo})}catch(t){if(E(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await S(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:ce})}catch(t){if(E(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,o,r,i,s,a,l;try{const c={nextPage:null,lastPage:0,total:0},d=await S(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(o=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&o!==void 0?o:"",per_page:(i=(r=e==null?void 0:e.perPage)===null||r===void 0?void 0:r.toString())!==null&&i!==void 0?i:""},xform:ys});if(d.error)throw d.error;const u=await d.json(),f=(s=d.headers.get("x-total-count"))!==null&&s!==void 0?s:0,h=(l=(a=d.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return h.length>0&&(h.forEach(g=>{const p=parseInt(g.split(";")[0].split("=")[1].substring(0,1)),m=JSON.parse(g.split(";")[1].split("=")[1]);c[`${m}Page`]=p}),c.total=parseInt(f)),{data:Object.assign(Object.assign({},u),c),error:null}}catch(c){if(E(c))return{data:{users:[]},error:c};throw c}}async getUserById(e){ke(e);try{return await S(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:ce})}catch(t){if(E(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){ke(e);try{return await S(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:ce})}catch(o){if(E(o))return{data:{user:null},error:o};throw o}}async deleteUser(e,t=!1){ke(e);try{return await S(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:ce})}catch(o){if(E(o))return{data:{user:null},error:o};throw o}}async _listFactors(e){ke(e.userId);try{const{data:t,error:o}=await S(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:r=>({data:{factors:r},error:null})});return{data:t,error:o}}catch(t){if(E(t))return{data:null,error:t};throw t}}async _deleteFactor(e){ke(e.userId),ke(e.id);try{return{data:await S(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(E(t))return{data:null,error:t};throw t}}}const bs={getItem:n=>We()?globalThis.localStorage.getItem(n):null,setItem:(n,e)=>{We()&&globalThis.localStorage.setItem(n,e)},removeItem:n=>{We()&&globalThis.localStorage.removeItem(n)}};function In(n={}){return{getItem:e=>n[e]||null,setItem:(e,t)=>{n[e]=t},removeItem:e=>{delete n[e]}}}function Es(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}const $e={debug:!!(globalThis&&We()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class to extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class Ss extends to{}async function Is(n,e,t){$e.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",n,e);const o=new globalThis.AbortController;return e>0&&setTimeout(()=>{o.abort(),$e.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",n)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(n,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:o.signal},async r=>{if(r){$e.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",n,r.name);try{return await t()}finally{$e.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",n,r.name)}}else{if(e===0)throw $e.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",n),new Ss(`Acquiring an exclusive Navigator LockManager lock "${n}" immediately failed`);if($e.debug)try{const i=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(i,null,"  "))}catch(i){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",i)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}Es();const ks={url:Bi,storageKey:Mi,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:Oi,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1};async function kn(n,e,t){return await t()}class ze{constructor(e){var t,o;this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=ze.nextInstanceID,ze.nextInstanceID+=1,this.instanceID>0&&X()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const r=Object.assign(Object.assign({},ks),e);if(this.logDebugMessages=!!r.debug,typeof r.debug=="function"&&(this.logger=r.debug),this.persistSession=r.persistSession,this.storageKey=r.storageKey,this.autoRefreshToken=r.autoRefreshToken,this.admin=new _s({url:r.url,headers:r.headers,fetch:r.fetch}),this.url=r.url,this.headers=r.headers,this.fetch=Zn(r.fetch),this.lock=r.lock||kn,this.detectSessionInUrl=r.detectSessionInUrl,this.flowType=r.flowType,this.hasCustomAuthorizationHeader=r.hasCustomAuthorizationHeader,r.lock?this.lock=r.lock:X()&&(!((t=globalThis==null?void 0:globalThis.navigator)===null||t===void 0)&&t.locks)?this.lock=Is:this.lock=kn,this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER,this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?r.storage?this.storage=r.storage:We()?this.storage=bs:(this.memoryStorage={},this.storage=In(this.memoryStorage)):(this.memoryStorage={},this.storage=In(this.memoryStorage)),X()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(i){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",i)}(o=this.broadcastChannel)===null||o===void 0||o.addEventListener("message",async i=>{this._debug("received broadcast notification from other tab or client",i),await this._notifyAllSubscribers(i.data.event,i.data.session,!1)})}this.initialize()}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${Kn}) ${new Date().toISOString()}`,...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{const t=Yi(window.location.href);let o="none";if(this._isImplicitGrantCallback(t)?o="implicit":await this._isPKCECallback(t)&&(o="pkce"),X()&&this.detectSessionInUrl&&o!=="none"){const{data:r,error:i}=await this._getSessionFromURL(t,o);if(i){if(this._debug("#_initialize()","error detecting session from URL",i),Ni(i)){const l=(e=i.details)===null||e===void 0?void 0:e.code;if(l==="identity_already_exists"||l==="identity_not_found"||l==="single_identity_not_deletable")return{error:i}}return await this._removeSession(),{error:i}}const{session:s,redirectType:a}=r;return this._debug("#_initialize()","detected session in URL",s,"redirect type",a),await this._saveSession(s),setTimeout(async()=>{a==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",s):await this._notifyAllSubscribers("SIGNED_IN",s)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return E(t)?{error:t}:{error:new Xn("Unexpected error during initialization",t)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,o,r;try{const i=await S(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(o=(t=e==null?void 0:e.options)===null||t===void 0?void 0:t.data)!==null&&o!==void 0?o:{},gotrue_meta_security:{captcha_token:(r=e==null?void 0:e.options)===null||r===void 0?void 0:r.captchaToken}},xform:ne}),{data:s,error:a}=i;if(a||!s)return{data:{user:null,session:null},error:a};const l=s.session,c=s.user;return s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",l)),{data:{user:c,session:l},error:null}}catch(i){if(E(i))return{data:{user:null,session:null},error:i};throw i}}async signUp(e){var t,o,r;try{let i;if("email"in e){const{email:d,password:u,options:f}=e;let h=null,g=null;this.flowType==="pkce"&&([h,g]=await Ie(this.storage,this.storageKey)),i=await S(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:f==null?void 0:f.emailRedirectTo,body:{email:d,password:u,data:(t=f==null?void 0:f.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:f==null?void 0:f.captchaToken},code_challenge:h,code_challenge_method:g},xform:ne})}else if("phone"in e){const{phone:d,password:u,options:f}=e;i=await S(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:d,password:u,data:(o=f==null?void 0:f.data)!==null&&o!==void 0?o:{},channel:(r=f==null?void 0:f.channel)!==null&&r!==void 0?r:"sms",gotrue_meta_security:{captcha_token:f==null?void 0:f.captchaToken}},xform:ne})}else throw new Xe("You must provide either an email or phone number and a password");const{data:s,error:a}=i;if(a||!s)return{data:{user:null,session:null},error:a};const l=s.session,c=s.user;return s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",l)),{data:{user:c,session:l},error:null}}catch(i){if(E(i))return{data:{user:null,session:null},error:i};throw i}}async signInWithPassword(e){try{let t;if("email"in e){const{email:i,password:s,options:a}=e;t=await S(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:i,password:s,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:Sn})}else if("phone"in e){const{phone:i,password:s,options:a}=e;t=await S(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:i,password:s,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:Sn})}else throw new Xe("You must provide either an email or phone number and a password");const{data:o,error:r}=t;return r?{data:{user:null,session:null},error:r}:!o||!o.session||!o.user?{data:{user:null,session:null},error:new Qe}:(o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",o.session)),{data:Object.assign({user:o.user,session:o.session},o.weak_password?{weakPassword:o.weak_password}:null),error:r})}catch(t){if(E(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOAuth(e){var t,o,r,i;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(o=e.options)===null||o===void 0?void 0:o.scopes,queryParams:(r=e.options)===null||r===void 0?void 0:r.queryParams,skipBrowserRedirect:(i=e.options)===null||i===void 0?void 0:i.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;if(t==="solana")return await this.signInWithSolana(e);throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}async signInWithSolana(e){var t,o,r,i,s,a,l,c,d,u,f,h;let g,p;if("message"in e)g=e.message,p=e.signature;else{const{chain:m,wallet:w,statement:_,options:v}=e;let b;if(X())if(typeof w=="object")b=w;else{const $=window;if("solana"in $&&typeof $.solana=="object"&&("signIn"in $.solana&&typeof $.solana.signIn=="function"||"signMessage"in $.solana&&typeof $.solana.signMessage=="function"))b=$.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof w!="object"||!(v!=null&&v.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");b=w}const k=new URL((t=v==null?void 0:v.url)!==null&&t!==void 0?t:window.location.href);if("signIn"in b&&b.signIn){const $=await b.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},v==null?void 0:v.signInWithSolana),{version:"1",domain:k.host,uri:k.href}),_?{statement:_}:null));let O;if(Array.isArray($)&&$[0]&&typeof $[0]=="object")O=$[0];else if($&&typeof $=="object"&&"signedMessage"in $&&"signature"in $)O=$;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in O&&"signature"in O&&(typeof O.signedMessage=="string"||O.signedMessage instanceof Uint8Array)&&O.signature instanceof Uint8Array)g=typeof O.signedMessage=="string"?O.signedMessage:new TextDecoder().decode(O.signedMessage),p=O.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in b)||typeof b.signMessage!="function"||!("publicKey"in b)||typeof b!="object"||!b.publicKey||!("toBase58"in b.publicKey)||typeof b.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");g=[`${k.host} wants you to sign in with your Solana account:`,b.publicKey.toBase58(),..._?["",_,""]:[""],"Version: 1",`URI: ${k.href}`,`Issued At: ${(r=(o=v==null?void 0:v.signInWithSolana)===null||o===void 0?void 0:o.issuedAt)!==null&&r!==void 0?r:new Date().toISOString()}`,...!((i=v==null?void 0:v.signInWithSolana)===null||i===void 0)&&i.notBefore?[`Not Before: ${v.signInWithSolana.notBefore}`]:[],...!((s=v==null?void 0:v.signInWithSolana)===null||s===void 0)&&s.expirationTime?[`Expiration Time: ${v.signInWithSolana.expirationTime}`]:[],...!((a=v==null?void 0:v.signInWithSolana)===null||a===void 0)&&a.chainId?[`Chain ID: ${v.signInWithSolana.chainId}`]:[],...!((l=v==null?void 0:v.signInWithSolana)===null||l===void 0)&&l.nonce?[`Nonce: ${v.signInWithSolana.nonce}`]:[],...!((c=v==null?void 0:v.signInWithSolana)===null||c===void 0)&&c.requestId?[`Request ID: ${v.signInWithSolana.requestId}`]:[],...!((u=(d=v==null?void 0:v.signInWithSolana)===null||d===void 0?void 0:d.resources)===null||u===void 0)&&u.length?["Resources",...v.signInWithSolana.resources.map(O=>`- ${O}`)]:[]].join(`
`);const $=await b.signMessage(new TextEncoder().encode(g),"utf8");if(!$||!($ instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");p=$}}try{const{data:m,error:w}=await S(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:g,signature:Ki(p)},!((f=e.options)===null||f===void 0)&&f.captchaToken?{gotrue_meta_security:{captcha_token:(h=e.options)===null||h===void 0?void 0:h.captchaToken}}:null),xform:ne});if(w)throw w;return!m||!m.session||!m.user?{data:{user:null,session:null},error:new Qe}:(m.session&&(await this._saveSession(m.session),await this._notifyAllSubscribers("SIGNED_IN",m.session)),{data:Object.assign({},m),error:w})}catch(m){if(E(m))return{data:{user:null,session:null},error:m};throw m}}async _exchangeCodeForSession(e){const t=await Ze(this.storage,`${this.storageKey}-code-verifier`),[o,r]=(t??"").split("/");try{const{data:i,error:s}=await S(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:o},xform:ne});if(await et(this.storage,`${this.storageKey}-code-verifier`),s)throw s;return!i||!i.session||!i.user?{data:{user:null,session:null,redirectType:null},error:new Qe}:(i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",i.session)),{data:Object.assign(Object.assign({},i),{redirectType:r??null}),error:s})}catch(i){if(E(i))return{data:{user:null,session:null,redirectType:null},error:i};throw i}}async signInWithIdToken(e){try{const{options:t,provider:o,token:r,access_token:i,nonce:s}=e,a=await S(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:o,id_token:r,access_token:i,nonce:s,gotrue_meta_security:{captcha_token:t==null?void 0:t.captchaToken}},xform:ne}),{data:l,error:c}=a;return c?{data:{user:null,session:null},error:c}:!l||!l.session||!l.user?{data:{user:null,session:null},error:new Qe}:(l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),{data:l,error:c})}catch(t){if(E(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOtp(e){var t,o,r,i,s;try{if("email"in e){const{email:a,options:l}=e;let c=null,d=null;this.flowType==="pkce"&&([c,d]=await Ie(this.storage,this.storageKey));const{error:u}=await S(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:a,data:(t=l==null?void 0:l.data)!==null&&t!==void 0?t:{},create_user:(o=l==null?void 0:l.shouldCreateUser)!==null&&o!==void 0?o:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},code_challenge:c,code_challenge_method:d},redirectTo:l==null?void 0:l.emailRedirectTo});return{data:{user:null,session:null},error:u}}if("phone"in e){const{phone:a,options:l}=e,{data:c,error:d}=await S(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:a,data:(r=l==null?void 0:l.data)!==null&&r!==void 0?r:{},create_user:(i=l==null?void 0:l.shouldCreateUser)!==null&&i!==void 0?i:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},channel:(s=l==null?void 0:l.channel)!==null&&s!==void 0?s:"sms"}});return{data:{user:null,session:null,messageId:c==null?void 0:c.message_id},error:d}}throw new Xe("You must provide either an email or phone number.")}catch(a){if(E(a))return{data:{user:null,session:null},error:a};throw a}}async verifyOtp(e){var t,o;try{let r,i;"options"in e&&(r=(t=e.options)===null||t===void 0?void 0:t.redirectTo,i=(o=e.options)===null||o===void 0?void 0:o.captchaToken);const{data:s,error:a}=await S(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:i}}),redirectTo:r,xform:ne});if(a)throw a;if(!s)throw new Error("An error occurred on token verification.");const l=s.session,c=s.user;return l!=null&&l.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),{data:{user:c,session:l},error:null}}catch(r){if(E(r))return{data:{user:null,session:null},error:r};throw r}}async signInWithSSO(e){var t,o,r;try{let i=null,s=null;return this.flowType==="pkce"&&([i,s]=await Ie(this.storage,this.storageKey)),await S(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(o=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&o!==void 0?o:void 0}),!((r=e==null?void 0:e.options)===null||r===void 0)&&r.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:i,code_challenge_method:s}),headers:this.headers,xform:ps})}catch(i){if(E(i))return{data:null,error:i};throw i}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:o}=e;if(o)throw o;if(!t)throw new ae;const{error:r}=await S(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:r}})}catch(e){if(E(e))return{data:{user:null,session:null},error:e};throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:o,type:r,options:i}=e,{error:s}=await S(this.fetch,"POST",t,{headers:this.headers,body:{email:o,type:r,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}},redirectTo:i==null?void 0:i.emailRedirectTo});return{data:{user:null,session:null},error:s}}else if("phone"in e){const{phone:o,type:r,options:i}=e,{data:s,error:a}=await S(this.fetch,"POST",t,{headers:this.headers,body:{phone:o,type:r,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}}});return{data:{user:null,session:null,messageId:s==null?void 0:s.message_id},error:a}}throw new Xe("You must provide either an email or phone number and a type")}catch(t){if(E(t))return{data:{user:null,session:null},error:t};throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const o=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),r=(async()=>(await o,await t()))();return this.pendingInLock.push((async()=>{try{await r}catch{}})()),r}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const o=t();for(this.pendingInLock.push((async()=>{try{await o}catch{}})()),await o;this.pendingInLock.length;){const r=[...this.pendingInLock];await Promise.all(r),this.pendingInLock.splice(0,r.length)}return await o}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await Ze(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const o=e.expires_at?e.expires_at*1e3-Date.now()<Et:!1;if(this._debug("#__loadSession()",`session has${o?"":" not"} expired`,"expires_at",e.expires_at),!o){if(this.storage.isServer){let s=this.suppressGetSessionWarning;e=new Proxy(e,{get:(l,c,d)=>(!s&&c==="user"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),s=!0,this.suppressGetSessionWarning=!0),Reflect.get(l,c,d))})}return{data:{session:e},error:null}}const{session:r,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{session:null},error:i}:{data:{session:r},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await S(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:ce}):await this._useSession(async t=>{var o,r,i;const{data:s,error:a}=t;if(a)throw a;return!(!((o=s.session)===null||o===void 0)&&o.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new ae}:await S(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(i=(r=s.session)===null||r===void 0?void 0:r.access_token)!==null&&i!==void 0?i:void 0,xform:ce})})}catch(t){if(E(t))return qi(t)&&(await this._removeSession(),await et(this.storage,`${this.storageKey}-code-verifier`)),{data:{user:null},error:t};throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async o=>{const{data:r,error:i}=o;if(i)throw i;if(!r.session)throw new ae;const s=r.session;let a=null,l=null;this.flowType==="pkce"&&e.email!=null&&([a,l]=await Ie(this.storage,this.storageKey));const{data:c,error:d}=await S(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t==null?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:a,code_challenge_method:l}),jwt:s.access_token,xform:ce});if(d)throw d;return s.user=c.user,await this._saveSession(s),await this._notifyAllSubscribers("USER_UPDATED",s),{data:{user:s.user},error:null}})}catch(o){if(E(o))return{data:{user:null},error:o};throw o}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new ae;const t=Date.now()/1e3;let o=t,r=!0,i=null;const{payload:s}=It(e.access_token);if(s.exp&&(o=s.exp,r=o<=t),r){const{session:a,error:l}=await this._callRefreshToken(e.refresh_token);if(l)return{data:{user:null,session:null},error:l};if(!a)return{data:{user:null,session:null},error:null};i=a}else{const{data:a,error:l}=await this._getUser(e.access_token);if(l)throw l;i={access_token:e.access_token,refresh_token:e.refresh_token,user:a.user,token_type:"bearer",expires_in:o-t,expires_at:o},await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)}return{data:{user:i.user,session:i},error:null}}catch(t){if(E(t))return{data:{session:null,user:null},error:t};throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var o;if(!e){const{data:s,error:a}=t;if(a)throw a;e=(o=s.session)!==null&&o!==void 0?o:void 0}if(!(e!=null&&e.refresh_token))throw new ae;const{session:r,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{user:null,session:null},error:i}:r?{data:{user:r.user,session:r},error:null}:{data:{user:null,session:null},error:null}})}catch(t){if(E(t))return{data:{user:null,session:null},error:t};throw t}}async _getSessionFromURL(e,t){try{if(!X())throw new Ye("No browser detected.");if(e.error||e.error_description||e.error_code)throw new Ye(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new yn("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new Ye("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new yn("No code detected.");const{data:_,error:v}=await this._exchangeCodeForSession(e.code);if(v)throw v;const b=new URL(window.location.href);return b.searchParams.delete("code"),window.history.replaceState(window.history.state,"",b.toString()),{data:{session:_.session,redirectType:null},error:null}}const{provider_token:o,provider_refresh_token:r,access_token:i,refresh_token:s,expires_in:a,expires_at:l,token_type:c}=e;if(!i||!a||!s||!c)throw new Ye("No session defined in URL");const d=Math.round(Date.now()/1e3),u=parseInt(a);let f=d+u;l&&(f=parseInt(l));const h=f-d;h*1e3<=Pe&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${h}s, should have been closer to ${u}s`);const g=f-u;d-g>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",g,f,d):d-g<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",g,f,d);const{data:p,error:m}=await this._getUser(i);if(m)throw m;const w={provider_token:o,provider_refresh_token:r,access_token:i,expires_in:u,expires_at:f,refresh_token:s,token_type:c,user:p.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:w,redirectType:e.type},error:null}}catch(o){if(E(o))return{data:{session:null,redirectType:null},error:o};throw o}}_isImplicitGrantCallback(e){return!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await Ze(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var o;const{data:r,error:i}=t;if(i)return{error:i};const s=(o=r.session)===null||o===void 0?void 0:o.access_token;if(s){const{error:a}=await this.admin.signOut(s,e);if(a&&!(ji(a)&&(a.status===404||a.status===401||a.status===403)))return{error:a}}return e!=="others"&&(await this._removeSession(),await et(this.storage,`${this.storageKey}-code-verifier`)),{error:null}})}onAuthStateChange(e){const t=Xi(),o={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,o),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:o}}}async _emitInitialSession(e){return await this._useSession(async t=>{var o,r;try{const{data:{session:i},error:s}=t;if(s)throw s;await((o=this.stateChangeEmitters.get(e))===null||o===void 0?void 0:o.callback("INITIAL_SESSION",i)),this._debug("INITIAL_SESSION","callback id",e,"session",i)}catch(i){await((r=this.stateChangeEmitters.get(e))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",i),console.error(i)}})}async resetPasswordForEmail(e,t={}){let o=null,r=null;this.flowType==="pkce"&&([o,r]=await Ie(this.storage,this.storageKey,!0));try{return await S(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:o,code_challenge_method:r,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(i){if(E(i))return{data:null,error:i};throw i}}async getUserIdentities(){var e;try{const{data:t,error:o}=await this.getUser();if(o)throw o;return{data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null}}catch(t){if(E(t))return{data:null,error:t};throw t}}async linkIdentity(e){var t;try{const{data:o,error:r}=await this._useSession(async i=>{var s,a,l,c,d;const{data:u,error:f}=i;if(f)throw f;const h=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(s=e.options)===null||s===void 0?void 0:s.redirectTo,scopes:(a=e.options)===null||a===void 0?void 0:a.scopes,queryParams:(l=e.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await S(this.fetch,"GET",h,{headers:this.headers,jwt:(d=(c=u.session)===null||c===void 0?void 0:c.access_token)!==null&&d!==void 0?d:void 0})});if(r)throw r;return X()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(o==null?void 0:o.url),{data:{provider:e.provider,url:o==null?void 0:o.url},error:null}}catch(o){if(E(o))return{data:{provider:e.provider,url:null},error:o};throw o}}async unlinkIdentity(e){try{return await this._useSession(async t=>{var o,r;const{data:i,error:s}=t;if(s)throw s;return await S(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(r=(o=i.session)===null||o===void 0?void 0:o.access_token)!==null&&r!==void 0?r:void 0})})}catch(t){if(E(t))return{data:null,error:t};throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const o=Date.now();return await ts(async r=>(r>0&&await es(200*Math.pow(2,r-1)),this._debug(t,"refreshing attempt",r),await S(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:ne})),(r,i)=>{const s=200*Math.pow(2,r);return i&&St(i)&&Date.now()+s-o<Pe})}catch(o){if(this._debug(t,"error",o),E(o))return{data:{session:null,user:null},error:o};throw o}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const o=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",o),X()&&!t.skipBrowserRedirect&&window.location.assign(o),{data:{provider:e,url:o},error:null}}async _recoverAndRefresh(){var e;const t="#_recoverAndRefresh()";this._debug(t,"begin");try{const o=await Ze(this.storage,this.storageKey);if(this._debug(t,"session from storage",o),!this._isValidSession(o)){this._debug(t,"session is not valid"),o!==null&&await this._removeSession();return}const r=((e=o.expires_at)!==null&&e!==void 0?e:1/0)*1e3-Date.now()<Et;if(this._debug(t,`session has${r?"":" not"} expired with margin of ${Et}s`),r){if(this.autoRefreshToken&&o.refresh_token){const{error:i}=await this._callRefreshToken(o.refresh_token);i&&(console.error(i),St(i)||(this._debug(t,"refresh failed with a non-retryable error, removing the session",i),await this._removeSession()))}}else await this._notifyAllSubscribers("SIGNED_IN",o)}catch(o){this._debug(t,"error",o),console.error(o);return}finally{this._debug(t,"end")}}async _callRefreshToken(e){var t,o;if(!e)throw new ae;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const r=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(r,"begin");try{this.refreshingDeferred=new ft;const{data:i,error:s}=await this._refreshAccessToken(e);if(s)throw s;if(!i.session)throw new ae;await this._saveSession(i.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",i.session);const a={session:i.session,error:null};return this.refreshingDeferred.resolve(a),a}catch(i){if(this._debug(r,"error",i),E(i)){const s={session:null,error:i};return St(i)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(s),s}throw(o=this.refreshingDeferred)===null||o===void 0||o.reject(i),i}finally{this.refreshingDeferred=null,this._debug(r,"end")}}async _notifyAllSubscribers(e,t,o=!0){const r=`#_notifyAllSubscribers(${e})`;this._debug(r,"begin",t,`broadcast = ${o}`);try{this.broadcastChannel&&o&&this.broadcastChannel.postMessage({event:e,session:t});const i=[],s=Array.from(this.stateChangeEmitters.values()).map(async a=>{try{await a.callback(e,t)}catch(l){i.push(l)}});if(await Promise.all(s),i.length>0){for(let a=0;a<i.length;a+=1)console.error(i[a]);throw i[0]}}finally{this._debug(r,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await eo(this.storage,this.storageKey,e)}async _removeSession(){this._debug("#_removeSession()"),await et(this.storage,this.storageKey),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&X()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),Pe);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:o}}=t;if(!o||!o.refresh_token||!o.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const r=Math.floor((o.expires_at*1e3-e)/Pe);this._debug("#_autoRefreshTokenTick()",`access token expires in ${r} ticks, a tick lasts ${Pe}ms, refresh threshold is ${Ft} ticks`),r<=Ft&&await this._callRefreshToken(o.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof to)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!X()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,o){const r=[`provider=${encodeURIComponent(t)}`];if(o!=null&&o.redirectTo&&r.push(`redirect_to=${encodeURIComponent(o.redirectTo)}`),o!=null&&o.scopes&&r.push(`scopes=${encodeURIComponent(o.scopes)}`),this.flowType==="pkce"){const[i,s]=await Ie(this.storage,this.storageKey),a=new URLSearchParams({code_challenge:`${encodeURIComponent(i)}`,code_challenge_method:`${encodeURIComponent(s)}`});r.push(a.toString())}if(o!=null&&o.queryParams){const i=new URLSearchParams(o.queryParams);r.push(i.toString())}return o!=null&&o.skipBrowserRedirect&&r.push(`skip_http_redirect=${o.skipBrowserRedirect}`),`${e}?${r.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var o;const{data:r,error:i}=t;return i?{data:null,error:i}:await S(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(o=r==null?void 0:r.session)===null||o===void 0?void 0:o.access_token})})}catch(t){if(E(t))return{data:null,error:t};throw t}}async _enroll(e){try{return await this._useSession(async t=>{var o,r;const{data:i,error:s}=t;if(s)return{data:null,error:s};const a=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:{issuer:e.issuer}),{data:l,error:c}=await S(this.fetch,"POST",`${this.url}/factors`,{body:a,headers:this.headers,jwt:(o=i==null?void 0:i.session)===null||o===void 0?void 0:o.access_token});return c?{data:null,error:c}:(e.factorType==="totp"&&(!((r=l==null?void 0:l.totp)===null||r===void 0)&&r.qr_code)&&(l.totp.qr_code=`data:image/svg+xml;utf-8,${l.totp.qr_code}`),{data:l,error:null})})}catch(t){if(E(t))return{data:null,error:t};throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var o;const{data:r,error:i}=t;if(i)return{data:null,error:i};const{data:s,error:a}=await S(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:(o=r==null?void 0:r.session)===null||o===void 0?void 0:o.access_token});return a?{data:null,error:a}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+s.expires_in},s)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",s),{data:s,error:a})})}catch(t){if(E(t))return{data:null,error:t};throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var o;const{data:r,error:i}=t;return i?{data:null,error:i}:await S(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:{channel:e.channel},headers:this.headers,jwt:(o=r==null?void 0:r.session)===null||o===void 0?void 0:o.access_token})})}catch(t){if(E(t))return{data:null,error:t};throw t}})}async _challengeAndVerify(e){const{data:t,error:o}=await this._challenge({factorId:e.factorId});return o?{data:null,error:o}:await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){const{data:{user:e},error:t}=await this.getUser();if(t)return{data:null,error:t};const o=(e==null?void 0:e.factors)||[],r=o.filter(s=>s.factor_type==="totp"&&s.status==="verified"),i=o.filter(s=>s.factor_type==="phone"&&s.status==="verified");return{data:{all:o,totp:r,phone:i},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async e=>{var t,o;const{data:{session:r},error:i}=e;if(i)return{data:null,error:i};if(!r)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:s}=It(r.access_token);let a=null;s.aal&&(a=s.aal);let l=a;((o=(t=r.user.factors)===null||t===void 0?void 0:t.filter(u=>u.status==="verified"))!==null&&o!==void 0?o:[]).length>0&&(l="aal2");const d=s.amr||[];return{data:{currentLevel:a,nextLevel:l,currentAuthenticationMethods:d},error:null}}))}async fetchJwk(e,t={keys:[]}){let o=t.keys.find(s=>s.kid===e);if(o||(o=this.jwks.keys.find(s=>s.kid===e),o&&this.jwks_cached_at+Ri>Date.now()))return o;const{data:r,error:i}=await S(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(i)throw i;if(!r.keys||r.keys.length===0)throw new He("JWKS is empty");if(this.jwks=r,this.jwks_cached_at=Date.now(),o=r.keys.find(s=>s.kid===e),!o)throw new He("No matching signing key found in JWKS");return o}async getClaims(e,t={keys:[]}){try{let o=e;if(!o){const{data:h,error:g}=await this.getSession();if(g||!h.session)return{data:null,error:g};o=h.session.access_token}const{header:r,payload:i,signature:s,raw:{header:a,payload:l}}=It(o);if(ls(i.exp),!r.kid||r.alg==="HS256"||!("crypto"in globalThis&&"subtle"in globalThis.crypto)){const{error:h}=await this.getUser(o);if(h)throw h;return{data:{claims:i,header:r,signature:s},error:null}}const c=cs(r.alg),d=await this.fetchJwk(r.kid,t),u=await crypto.subtle.importKey("jwk",d,c,!0,["verify"]);if(!await crypto.subtle.verify(c,u,s,Ji(`${a}.${l}`)))throw new He("Invalid JWT signature");return{data:{claims:i,header:r,signature:s},error:null}}catch(o){if(E(o))return{data:null,error:o};throw o}}}ze.nextInstanceID=0;const $s=ze;class Ps extends $s{constructor(e){super(e)}}var Cs=function(n,e,t,o){function r(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function a(d){try{c(o.next(d))}catch(u){s(u)}}function l(d){try{c(o.throw(d))}catch(u){s(u)}}function c(d){d.done?i(d.value):r(d.value).then(a,l)}c((o=o.apply(n,e||[])).next())})};class Ts{constructor(e,t,o){var r,i,s;if(this.supabaseUrl=e,this.supabaseKey=t,!e)throw new Error("supabaseUrl is required.");if(!t)throw new Error("supabaseKey is required.");const a=Li(e),l=new URL(a);this.realtimeUrl=new URL("realtime/v1",l),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",l),this.storageUrl=new URL("storage/v1",l),this.functionsUrl=new URL("functions/v1",l);const c=`sb-${l.hostname.split(".")[0]}-auth-token`,d={db:Ii,realtime:$i,auth:Object.assign(Object.assign({},ki),{storageKey:c}),global:Si},u=Fi(o??{},d);this.storageKey=(r=u.auth.storageKey)!==null&&r!==void 0?r:"",this.headers=(i=u.global.headers)!==null&&i!==void 0?i:{},u.accessToken?(this.accessToken=u.accessToken,this.auth=new Proxy({},{get:(f,h)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(h)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((s=u.auth)!==null&&s!==void 0?s:{},this.headers,u.global.fetch),this.fetch=Ai(t,this._getAccessToken.bind(this),u.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},u.realtime)),this.rest=new Gr(new URL("rest/v1",l).href,{headers:this.headers,schema:u.db.schema,fetch:this.fetch}),u.accessToken||this._listenForAuthEvents()}get functions(){return new br(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}get storage(){return new _i(this.storageUrl.href,this.headers,this.fetch)}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},o={}){return this.rest.rpc(e,t,o)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return Cs(this,void 0,void 0,function*(){if(this.accessToken)return yield this.accessToken();const{data:o}=yield this.auth.getSession();return(t=(e=o.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:null})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:o,storage:r,storageKey:i,flowType:s,lock:a,debug:l},c,d){const u={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new Ps({url:this.authUrl.href,headers:Object.assign(Object.assign({},u),c),storageKey:i,autoRefreshToken:e,persistSession:t,detectSessionInUrl:o,storage:r,flowType:s,lock:a,debug:l,fetch:d,hasCustomAuthorizationHeader:"Authorization"in this.headers})}_initRealtimeClient(e){return new ai(this.realtimeUrl.href,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,o)=>{this._handleTokenChanged(t,"CLIENT",o==null?void 0:o.access_token)})}_handleTokenChanged(e,t,o){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==o?this.changedAccessToken=o:e==="SIGNED_OUT"&&(this.realtime.setAuth(),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const As=(n,e,t)=>new Ts(n,e,t),xs="https://ehutpsrutyiorhqrwstz.supabase.co",Ls="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVodXRwc3J1dHlpb3JocXJ3c3R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExMTMyNzQsImV4cCI6MjA2NjY4OTI3NH0.lcfz59Uc2S6q9Mn2lj2OC_WAMG5CncrNbEnHX7MFTeI";let y=null;function no(){if(y){console.log("Supabase client already initialized, skipping...");return}try{y=As(xs,Ls),console.log(" Supabase client initialized successfully")}catch(n){console.error(" Error initializing Supabase client:",n),y=null}}const K={getItem:n=>localStorage.getItem(`nutrivalor_${n}`),setItem:(n,e)=>localStorage.setItem(`nutrivalor_${n}`,e),removeItem:n=>localStorage.removeItem(`nutrivalor_${n}`)};async function Be(){if(y)try{const{data:{user:e}}=await y.auth.getUser();return e}catch{return null}const n=K.getItem("currentUser");return n?JSON.parse(n):null}const Fs=Object.freeze(Object.defineProperty({__proto__:null,getCurrentUser:Be,initializeSupabase:no,localStorageWrapper:K,get supabase(){return y}},Symbol.toStringTag,{value:"Module"}));let ye=null;async function oo(){await ro(),Bs()}function Bs(){const n=document.querySelector("#loginForm form"),e=document.querySelector("#signupForm form"),t=document.querySelector("#forgotForm form"),o=document.getElementById("logoutBtn");n?n.addEventListener("submit",Ds):console.warn(" Login form not found"),e?e.addEventListener("submit",Rs):console.warn(" Signup form not found"),t?t.addEventListener("submit",js):console.warn(" Forgot password form not found"),o?o.addEventListener("click",so):console.warn(" Logout button not found"),document.querySelectorAll("[data-auth-tab]").forEach(i=>{i.addEventListener("click",s=>{const l=s.target.getAttribute("data-auth-tab");l&&Ge(l)})});const r=document.querySelector("[data-forgot-password]");r&&r.addEventListener("click",i=>{i.preventDefault(),io()})}async function ro(){try{Wt();const n=await Be();n?await it(n):re()}catch(n){console.error("Error checking auth state:",n),re()}}function te(){return ye}async function it(n){ye=n,gt(),Ms(),await Os(n),Ns();try{const e=await A(()=>Promise.resolve().then(()=>Pl),void 0);"loadProfile"in e&&typeof e.loadProfile=="function"&&(await e.loadProfile(),console.log(" Profile auto-loaded after login"))}catch(e){console.log(" Profile auto-load skipped (not available or error):",e)}Gt()}function Wt(){const n=document.getElementById("loadingScreen"),e=document.getElementById("auth-section"),t=document.getElementById("app-section");n&&(n.style.display="flex"),e&&(e.style.display="none"),t&&(t.style.display="none")}function gt(){const n=document.getElementById("loadingScreen");n&&(n.style.display="none")}function re(){gt();const n=document.getElementById("auth-section"),e=document.getElementById("app-section");n&&(n.style.display="flex"),e&&(e.style.display="none")}function Ms(){gt();const n=document.getElementById("auth-section"),e=document.getElementById("app-section");n&&(n.style.display="none"),e&&(e.style.display="block")}async function Os(n){const e=document.getElementById("userEmail"),t=document.getElementById("headerAvatar"),o=document.getElementById("headerAvatarPlaceholder");if(e){let r=n.email||"User",i=null;try{const{loadProfileFromDatabase:s}=await A(async()=>{const{loadProfileFromDatabase:l}=await Promise.resolve().then(()=>Ee);return{loadProfileFromDatabase:l}},void 0),a=await s();a&&(a.name&&a.name.trim()&&(r=a.name),a.avatar_url&&(i=a.avatar_url))}catch(s){console.log("Could not load profile from database for header display:",s);const a=localStorage.getItem("nutrivalor_profile");if(a)try{const l=JSON.parse(a);l.name&&l.name.trim()&&(r=l.name),l.avatar&&(i=l.avatar)}catch{console.log("Could not parse saved profile for display name")}}e.textContent=r,t&&o&&(i?(t.src=i,t.style.display="block",o.style.display="none"):(t.style.display="none",o.style.display="flex"))}}function Ge(n){document.querySelectorAll(".auth-tab").forEach(r=>r.classList.remove("active"));const e=document.getElementById("loginForm"),t=document.getElementById("signupForm"),o=document.getElementById("forgotForm");if(e&&(e.style.display="none"),t&&(t.style.display="none"),o&&(o.style.display="none"),n==="login"){const r=document.querySelector(".auth-tab");r&&r.classList.add("active"),e&&(e.style.display="block")}else if(n==="signup"){const r=document.querySelectorAll(".auth-tab")[1];r&&r.classList.add("active"),t&&(t.style.display="block")}}function io(){document.querySelectorAll(".auth-tab").forEach(o=>o.classList.remove("active"));const n=document.getElementById("loginForm"),e=document.getElementById("signupForm"),t=document.getElementById("forgotForm");n&&(n.style.display="none"),e&&(e.style.display="none"),t&&(t.style.display="block")}function M(n,e="success"){const t=document.createElement("div");t.className=`message-toast ${e}`,t.textContent=n,document.body.appendChild(t),t.offsetWidth,t.classList.add("show"),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>{document.body.removeChild(t)},300)},5e3)}async function Ds(n){n.preventDefault();const e=n.target,t=new FormData(e),o=t.get("email"),r=t.get("password");if(!o||!r){M("Please fill in all fields","error");return}try{if(Wt(),!y){const l=JSON.parse(K.getItem("users")||"[]").find(d=>d.email===o&&d.password===r);if(!l){M("Invalid email or password","error"),re();return}const c={...l};delete c.password,K.setItem("currentUser",JSON.stringify(c)),await it(c);return}const{data:i,error:s}=await y.auth.signInWithPassword({email:o,password:r});if(s){M(s.message,"error"),re();return}i.user&&(await it(i.user),M("Login successful!","success"))}catch(i){console.error("Login error:",i),M("An error occurred during login","error"),re()}}async function Rs(n){n.preventDefault();const e=n.target,t=new FormData(e),o=t.get("name"),r=t.get("email"),i=t.get("password");if(!o||!r||!i){M("Please fill in all fields","error");return}if(i.length<6){M("Password must be at least 6 characters","error");return}try{if(Wt(),!y){const l=JSON.parse(K.getItem("users")||"[]");if(l.find(u=>u.email===r)){M("User already exists","error"),re();return}const d={id:Hs(),email:r,user_metadata:{name:o},app_metadata:{},aud:"authenticated",created_at:new Date().toISOString()};l.push({...d,password:i}),K.setItem("users",JSON.stringify(l)),K.setItem("currentUser",JSON.stringify(d)),await it(d),M("Account created successfully!","success");return}const{data:s,error:a}=await y.auth.signUp({email:r,password:i,options:{data:{name:o}}});if(a){M(a.message,"error"),re();return}s.user&&(gt(),Us(r))}catch(s){console.error("Signup error:",s),M("An error occurred during signup","error"),re()}}function Us(n){const e=document.getElementById("verificationEmail");e&&(e.textContent=n);const t=document.getElementById("verificationModal");t&&(t.style.display="flex",t.classList.add("show"));const o=document.getElementById("verificationGotIt"),r=document.getElementById("verificationGoBack");o&&(o.onclick=()=>{$n(),Ge("login"),M("Please check your email to verify your account before logging in.","info")}),r&&(r.onclick=()=>{$n(),Ge("signup")})}function $n(){const n=document.getElementById("verificationModal");n&&(n.classList.remove("show"),setTimeout(()=>{n.style.display="none"},300))}async function js(n){n.preventDefault();const e=n.target,o=new FormData(e).get("email");if(!o){M("Please enter your email","error");return}try{if(!y){M("Password reset functionality requires Supabase connection","error");return}const{error:r}=await y.auth.resetPasswordForEmail(o);if(r){M(r.message,"error");return}M("Password reset email sent!","success"),Ge("login")}catch(r){console.error("Password reset error:",r),M("An error occurred sending reset email","error")}}async function so(){try{y&&await y.auth.signOut(),K.removeItem("currentUser"),K.removeItem("nutrivalor_profile"),K.removeItem("nutrivalor_meals"),K.removeItem("nutrivalor_weeklyPlan"),qs(),ye!=null&&ye.id&&K.removeItem(`macroProfile_${ye.id}`);try{const n=await A(()=>Promise.resolve().then(()=>xo),void 0);"clearAllData"in n&&await n.clearAllData();const e=document.getElementById("foodGrid");e&&(e.innerHTML='<p class="empty-state">Please log in to view your food data.</p>');const t=document.getElementById("shoppingListContainer");t&&(t.innerHTML='<p class="empty-state">Please log in to view your shopping list.</p>');const o=await A(()=>Promise.resolve().then(()=>No),void 0);"clearAllMealData"in o&&await o.clearAllMealData();const r=document.getElementById("mealGrid");r&&(r.innerHTML='<p class="empty-state">Please log in to view your meals.</p>');const i=document.querySelector(".weekly-meal-plan-container");i&&(i.innerHTML='<p class="empty-state">Please log in to view your meal plan.</p>'),console.log(" All user data cleared from memory and display")}catch(n){console.warn(" Some data clearing operations failed (this is okay):",n)}ye=null,re(),console.log(" User logged out - all data cleared for next user")}catch(n){console.error("Logout error:",n),M("Error during logout","error")}}function qs(){try{["profileName","dateOfBirth","profileAge","profileGender","profileHeight","heightUnit","profileIdealWeight","weightUnit","profileCountry"].forEach(a=>{const l=document.getElementById(a);l&&(l instanceof HTMLSelectElement?l.selectedIndex=0:l.value="")});const e=document.getElementById("avatarPreview"),t=document.getElementById("avatarPlaceholder"),o=document.getElementById("removeAvatarBtn");e&&(e.src="",e.style.display="none"),t&&(t.style.display="flex"),o&&(o.style.display="none");const r=document.getElementById("userEmail"),i=document.getElementById("headerAvatar"),s=document.getElementById("headerAvatarPlaceholder");r&&(r.textContent="User"),i&&(i.style.display="none"),s&&(s.style.display="flex"),console.log(" Profile form cleared for next user")}catch(n){console.error("Error clearing profile form:",n)}}async function Ns(){try{const{initializeFoodTracker:n}=await A(async()=>{const{initializeFoodTracker:t}=await Promise.resolve().then(()=>xo);return{initializeFoodTracker:t}},void 0);await n();const{initializeMeals:e}=await A(async()=>{const{initializeMeals:t}=await Promise.resolve().then(()=>No);return{initializeMeals:t}},void 0);await e()}catch(n){console.error(" Error loading user data:",n)}}function Hs(){return"id_"+Math.random().toString(36).substr(2,9)+Date.now().toString(36)}async function zt(){try{const n=await Be();if(!n)return console.log(" No user found, returning false"),!1;const{data:e,error:t}=await y.from("user_roles").select("role").eq("user_id",n.id).single();if(t&&t.code!=="PGRST116")return console.error(" Error checking admin status:",t),!1;t&&t.code==="PGRST116"&&console.log(" No role record found for user, defaulting to user role");const o=(e==null?void 0:e.role)||"user";return o==="admin"||o==="super_admin"}catch(n){return console.error(" Error checking admin status:",n),!1}}async function ao(){try{const n=await Be();if(!n)return!1;const{data:e,error:t}=await y.from("user_roles").select("role").eq("user_id",n.id).single();if(t&&t.code!=="PGRST116")return console.error("Error checking super admin status:",t),!1;const o=(e==null?void 0:e.role)||"user";return console.log(" User role:",o),o==="super_admin"}catch(n){return console.error("Error checking super admin status:",n),!1}}async function lo(){try{const n=await Be();if(!n)return"guest";const{data:e,error:t}=await y.from("user_roles").select("role").eq("user_id",n.id).single();return t&&t.code!=="PGRST116"?(console.error("Error getting user role:",t),"user"):(e==null?void 0:e.role)||"user"}catch(n){return console.error("Error getting user role:",n),"user"}}async function Gt(){const n=document.getElementById("adminTab");if(!n){console.error(" Admin tab element not found in DOM");return}try{const e=await zt();n.style.display=e?"block":"none"}catch(e){console.error(" Error in updateAdminNavigation:",e),n.style.display="none"}}async function co(){console.log(" === ADMIN DEBUG START ===");const n=await Be();if(console.log(" Current user:",n),!n){console.log(" No user logged in");return}try{const e=await lo();console.log(" User role:",e);const t=await zt();console.log(" Is admin:",t);const o=await ao();console.log(" Is super admin:",o);const r=document.getElementById("adminTab");console.log(" Admin tab element:",r),console.log(" Admin tab display:",r==null?void 0:r.style.display),await Gt()}catch(e){console.error(" Debug error:",e)}console.log(" === ADMIN DEBUG END ===")}window.debugAdminStatus=co;const Ws=Object.freeze(Object.defineProperty({__proto__:null,checkAuthState:ro,debugAdminStatus:co,getCurrentAuthUser:te,getCurrentUserRole:lo,handleLogout:so,initializeAuth:oo,isCurrentUserAdmin:zt,isCurrentUserSuperAdmin:ao,showAuthTab:Ge,showForgotPassword:io,updateAdminNavigation:Gt},Symbol.toStringTag,{value:"Module"}));async function uo(){if(!y)throw new Error("Supabase client not initialized");try{const{data:n,error:e}=await y.from("foods").select("count").limit(1);e&&e.code!=="PGRST116"&&(console.warn("Database tables may not be created yet:",e.message),console.log("Please run the SQL script from database-setup.sql in your Supabase dashboard"))}catch(n){console.warn("Database verification failed:",n)}}async function Vt(n){if(!y)throw new Error("Supabase not initialized");const{data:{user:e},error:t}=await y.auth.getUser();let o="Unknown User";if(!t&&e)try{const{data:a}=await y.from("user_profiles").select("name").eq("user_id",e.id).single();o=(a==null?void 0:a.name)||e.email||"Unknown User"}catch{o=e.email||"Unknown User"}const r={...n,created_by:o},{data:i,error:s}=await y.from("foods").insert([r]).select();if(s)throw s;return i[0]}async function ho(n){if(!y)throw new Error("Supabase not initialized");const{data:e,error:t}=await y.from("foods").insert(n).select();if(t)throw t;return e||[]}async function fo(){if(!y)throw new Error("Supabase not initialized");const{data:{user:n},error:e}=await y.auth.getUser();if(e||!n)return console.log("No authenticated user, returning empty food list"),[];const{data:t,error:o}=await y.from("foods").select("*").order("name");if(o)throw o;return t||[]}async function go(n){if(!y)throw new Error("Supabase not initialized");const{error:e}=await y.from("foods").delete().eq("id",n);if(e)throw e}async function po(){if(!y)throw new Error("Supabase not initialized");const{data:{user:n},error:e}=await y.auth.getUser();if(e||!n)throw new Error("User must be authenticated to clear foods");const{error:t}=await y.from("foods").delete().eq("user_id",n.id);if(t)throw t;console.log(" Cleared all existing foods for user:",n.id)}async function mo(n,e=1,t="EACH"){if(!y)throw new Error("Supabase not initialized");const{data:{user:o},error:r}=await y.auth.getUser();if(r||!o)throw new Error("No authenticated user");const i={food_id:n,user_id:o.id,quantity:e,unit:t},{data:s,error:a}=await y.from("shopping_list").insert([i]).select();if(a)throw a;return s[0]}async function Jt(){const n=await te();if(!n)return null;const{data:e,error:t}=await y.from("shopping_list").select(`
            *,
            food:food_id (
                name,
                brand,
                category,
                carbs,
                fat,
                protein
            )
        `).eq("user_id",n.id);return t?(console.error("Error loading shopping list:",t.message),null):e.map(r=>({...r,checked:r.checked||!1}))}async function yo(n){if(!y)throw new Error("Supabase not initialized");const{data:{user:e},error:t}=await y.auth.getUser();if(t||!e)throw new Error("User must be authenticated to remove from shopping list");const{error:o}=await y.from("shopping_list").delete().eq("id",n).eq("user_id",e.id);if(o)throw o}async function vo(n,e){if(!y)throw new Error("Supabase not initialized");const{data:{user:t},error:o}=await y.auth.getUser();if(o||!t)throw new Error("User must be authenticated to update shopping list");const{data:r,error:i}=await y.from("shopping_list").update({quantity:e}).eq("id",n).eq("user_id",t.id).select();if(i)throw i;return r[0]}async function Kt(){if(!y)throw new Error("Supabase not initialized");const{data:{user:n},error:e}=await y.auth.getUser();if(e||!n)throw new Error("User must be authenticated to clear shopping list");const{error:t}=await y.from("shopping_list").delete().eq("user_id",n.id);if(t)throw t;console.log(" Cleared shopping list for user:",n.id)}async function wo(n){if(!y)throw new Error("Supabase not initialized");const{data:{user:e},error:t}=await y.auth.getUser();if(t||!e)throw new Error("User must be authenticated to save profile");const o={user_id:e.id,name:n.name,date_of_birth:n.dateOfBirth,age:n.age?parseInt(n.age):null,gender:n.gender,height:n.height?parseFloat(n.height):null,height_unit:n.heightUnit||"cm",ideal_weight:n.idealWeight?parseFloat(n.idealWeight):null,weight_unit:n.weightUnit||"kg",country:n.country,avatar_url:n.avatar,updated_at:new Date().toISOString()},{data:r,error:i}=await y.from("user_profiles").select("id").eq("user_id",e.id).single();if(i&&i.code!=="PGRST116")throw i;if(r){const{data:s,error:a}=await y.from("user_profiles").update(o).eq("user_id",e.id).select();if(a)throw a;return s[0]}else{const{data:s,error:a}=await y.from("user_profiles").insert([o]).select();if(a)throw a;return s[0]}}async function Qt(){if(!y)throw new Error("Supabase not initialized");const{data:{user:n},error:e}=await y.auth.getUser();if(e||!n)return console.log("No authenticated user, returning null profile"),null;const{data:t,error:o}=await y.from("user_profiles").select("*").eq("user_id",n.id).single();if(o){if(o.code==="PGRST116")return null;throw o}return t}async function _o(n,e,t){if(!y)throw new Error("Supabase not initialized");const{data:{user:o},error:r}=await y.auth.getUser();if(r||!o)throw new Error("User must be authenticated to save weight entry");const i={user_id:o.id,weight:n,entry_date:e,notes:null},{data:s,error:a}=await y.from("weight_entries").insert([i]).select();if(a)throw a;return s[0]}async function Xt(){if(!y)throw new Error("Supabase not initialized");const{data:{user:n},error:e}=await y.auth.getUser();if(e||!n)return console.log("No authenticated user, returning empty weight entries"),[];const{data:t,error:o}=await y.from("weight_entries").select("*").eq("user_id",n.id).order("entry_date",{ascending:!0});if(o)throw o;return t||[]}async function bo(){if(!y)throw new Error("Supabase not initialized");const{data:{user:n},error:e}=await y.auth.getUser();if(e||!n)throw new Error("User must be authenticated to clear weight entries");const{error:t}=await y.from("weight_entries").delete().eq("user_id",n.id);if(t)throw t;console.log(" Cleared all weight entries for user:",n.id)}const Ee=Object.freeze(Object.defineProperty({__proto__:null,addToShoppingList:mo,clearAllFoodsForUser:po,clearAllWeightEntriesFromDatabase:bo,clearShoppingListFromDatabase:Kt,deleteFoodFromDatabase:go,initializeDatabase:uo,loadFoodsFromDatabase:fo,loadProfileFromDatabase:Qt,loadShoppingListFromDatabase:Jt,loadWeightEntriesFromDatabase:Xt,removeFromShoppingList:yo,saveAllFoodsToDatabase:ho,saveFoodToDatabase:Vt,saveProfileToDatabase:wo,saveWeightEntryToDatabase:_o,updateShoppingListQuantity:vo},Symbol.toStringTag,{value:"Module"}));async function Eo(){zs(),await fe(),await pt(),Io()}function zs(){const n=document.getElementById("foodFileInput");n?n.addEventListener("change",ko):console.warn(" Food file input not found")}let F=[],L=[];async function pt(){try{L=await Jt()||[],Oe()}catch(n){console.error(" Error loading shopping list:",n),L=[]}}async function fe(){try{const n=await fo();F=n,Gs(n),Me(n)}catch(n){console.error(" Error loading foods:",n),x("Error loading foods: "+n.message,"error")}}function Gs(n){const e=document.querySelector(".category-filters");if(!e)return;const t=[...new Set(n.map(i=>i.category).filter(i=>i&&i!=="General"))],r=["all",...["VEGETABLES","SALAD","DAIRY","PROTEIN","CONDIMENTS","DRINKS","OTHER"].filter(i=>t.includes(i))];e.innerHTML=r.map((i,s)=>`
      <button class="filter-btn ${s===0?"active":""}" onclick="filterByCategory('${i}')" data-category="${i}">
        ${i==="all"?"ALL":i}
      </button>
    `).join("")}function So(n){console.log(` Filtering by category: ${n}`),document.querySelectorAll(".filter-btn").forEach(o=>{o.classList.remove("active")});const e=document.querySelector(`[data-category="${n}"]`);e&&e.classList.add("active");let t=F;n!=="all"&&(t=F.filter(o=>o.category&&o.category.toLowerCase()===n.toLowerCase())),console.log(` Filtered to ${t.length} foods`),Me(t)}function Me(n){const e=document.getElementById("foodGrid");if(!e){console.warn(" Food grid element not found");return}if(n.length===0){e.innerHTML='<p class="empty-state">No foods found. Upload your food data to get started!</p>';return}n.sort((t,o)=>t.name.localeCompare(o.name)),e.innerHTML=n.map(t=>{const o=L.some(a=>a.food_id===t.id),r=o?"add-btn added":"add-btn",i=o?"Remove from List":"Add to List",s=o?`handleRemoveFromShoppingList('${t.id}', true)`:`addToShoppingList('${t.id}')`;return`
      <div class="food-card" data-food-id="${t.id}">
        <h4>${t.name}</h4>
        ${t.brand?`<div class="brand-info">Brand: ${t.brand}</div>`:""}
        <div class="nutrition-info">
          <span>Carbs: ${Ce(t.carbs)}g</span>
          <span>Fat: ${Ce(t.fat)}g</span>
          <span>Protein: ${Ce(t.protein)}g</span>
        </div>
        ${t.instructions?`<div class="food-instructions">${t.instructions}</div>`:""}
        <div class="food-attribution">
          Created by: ${t.created_by||"Unknown"}
        </div>
        <div class="food-actions">
          <div class="quantity-unit-group">
            <input type="number" 
                   class="quantity-input" 
                   value="1" 
                   min="1" 
                   id="qty-${t.id}"
                   onchange="updateQuantity('${t.id}', this.value)"
                   placeholder="Qty">
          </div>
          <button class="${r}" onclick="${s}">
            ${i}
          </button>
        </div>
      </div>
    `}).join("")}function Ce(n){if(n==null||n==="")return"0";const e=parseFloat(n);return isNaN(e)?"0":e.toFixed(1)}function Vs(n,e){const t=parseFloat(e);if(isNaN(t)||t<1)return;const o=document.getElementById(`unit-${n}`);if(!o)return;const r=o.options[o.selectedIndex],i=r.dataset.gramsPerUnit?parseFloat(r.dataset.gramsPerUnit):1;console.log(`Updated quantity for food ${n}: ${t} ${o.value} (${t*i}g total)`)}function Js(n,e){const t=document.getElementById(`qty-${n}`),o=document.getElementById(`unit-${n}`);if(!t||!o)return;const r=parseFloat(t.value),i=o.options[o.selectedIndex],s=i.dataset.gramsPerUnit?parseFloat(i.dataset.gramsPerUnit):1;console.log(`Updated unit for food ${n}: ${r} ${e} (${r*s}g total)`)}function Ks(){const n=new Date,e=n.toLocaleDateString()+" "+n.toLocaleTimeString();localStorage.setItem("lastFoodUploadDate",e),Io()}function Io(){const n=localStorage.getItem("lastFoodUploadDate"),e=document.getElementById("lastUpdateInfo"),t=document.getElementById("lastUpdateDate");n&&e&&t?(t.textContent=n,e.style.display="block"):e&&(e.style.display="none")}async function ko(n){const e=n.target;if(!e.files||e.files.length===0)return;const t=e.files[0];try{if(x("Processing file...","success"),console.log(" Processing file:",t.name),!t.name.endsWith(".xlsx")&&!t.name.endsWith(".xls"))throw new Error("Please upload an Excel file (.xlsx or .xls)");if(!y)throw new Error("Supabase client not initialized");const{data:{user:o},error:r}=await y.auth.getUser();if(r||!o)throw new Error("You must be logged in to upload food data");console.log(" Current user:",o.id);const i=await Qs(t);if(i&&i.length>0){console.log(` Parsed ${i.length} foods from Excel`),x("Clearing existing foods and uploading new data...","success");const{isCurrentUserAdmin:s}=await A(async()=>{const{isCurrentUserAdmin:g}=await Promise.resolve().then(()=>Ws);return{isCurrentUserAdmin:g}},void 0),a=await s();let l=!1;if(a)if(console.log(" Admin upload detected - choosing upload strategy"),confirm(` SMART MODE UPLOAD (Recommended) 

This will:
 Replace Excel-uploaded foods with new data
 PRESERVE your manually added foods
 Keep admin panel foods safe

Click OK to use Smart Mode (recommended)
Click Cancel for old "Replace All" mode`)){console.log(" Smart Mode activated: Preserving manually added admin foods");try{const{error:p}=await y.from("foods").delete().eq("created_by","Excel Upload").is("user_id",null);if(p)throw p;console.log(" Cleared only Excel-uploaded foods, manually added admin foods preserved")}catch(p){console.warn(" Could not clear Excel foods:",p)}}else{if(!confirm(` FINAL WARNING 

This will DELETE ALL FOODS including manually added ones.
Are you absolutely sure?`)){x("Upload cancelled","error"),e.value="";return}try{const{error:m}=await y.from("foods").delete().neq("id","00000000-0000-0000-0000-000000000000");if(m)throw m;console.log(" Cleared entire food database")}catch(m){console.warn(" Could not clear database:",m)}}else if(console.log(" User upload detected - using smart sharing approach"),l=confirm(` SMART SHARING (Recommended) 

To prevent database bloat, we recommend sharing Excel data globally:

 Adds foods to shared global database
 Prevents duplicate storage
 All users benefit from shared data
 Shows your name as contributor

Click OK to share globally (recommended)
Click Cancel for personal-only storage`),l){console.log(" Smart sharing mode: Adding to global database");try{const{error:g}=await y.from("foods").delete().eq("created_by","Excel Upload").is("user_id",null);if(g)throw g;console.log(" Cleared previous Excel uploads to prevent duplication")}catch(g){console.warn(" Could not clear previous Excel uploads:",g)}}else{console.log(" Personal mode: User-specific storage");try{await po(),console.log(" Cleared user's existing foods")}catch(g){console.warn(" Could not clear existing foods:",g)}}let c;a?c=i.map(g=>({...g,user_id:null,created_by:"Excel Upload"})):l?c=i.map(g=>({...g,user_id:null,created_by:`Excel Upload by ${o.email||"User"}`})):c=i.map(g=>({...g,user_id:o.id,created_by:o.email})),console.log(` Saving ${c.length} foods in bulk...`);let d=0,u=0;try{await ho(c),console.log(` Successfully saved all ${c.length} foods`),d=c.length,u=0}catch(g){console.error(" Failed to save foods in bulk:",g),console.log(" Falling back to individual saves..."),d=0,u=0;for(const p of c)try{await Vt(p),d++}catch(m){console.warn(" Failed to save food:",p.name,m),u++}}console.log(` Save results: ${d} saved, ${u} errors`),await fe();const f=document.getElementById("uploadModal");f&&(f.style.display="none");const h=u>0?`Uploaded ${d} foods (${u} failed)`:`Successfully uploaded ${d} food items!`;x(h,"success"),Ks()}else x("No valid food data found in the file","error")}catch(o){console.error(" Error processing food file:",o),x(`Error: ${o instanceof Error?o.message:"Unknown error"}`,"error")}e.value=""}async function Qs(n){return new Promise((e,t)=>{const o=new FileReader;o.onload=function(r){var i;try{typeof window.XLSX>"u"?Xs(()=>{var s;Pn((s=r.target)==null?void 0:s.result,e,t)}):Pn((i=r.target)==null?void 0:i.result,e,t)}catch(s){t(s)}},o.onerror=()=>t(new Error("Failed to read file")),o.readAsArrayBuffer(n)})}function Xs(n){const e=document.createElement("script");e.src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js",e.onload=n,e.onerror=()=>{throw new Error("Failed to load XLSX library")},document.head.appendChild(e)}function Pn(n,e,t){try{const o=window.XLSX,r=o.read(n,{type:"array"}),i=r.SheetNames[0],s=r.Sheets[i],a=o.utils.decode_range(s["!ref"]),l=[];for(let d=a.s.r;d<=a.e.r;d++){const u=[];for(let f=a.s.c;f<=a.e.c;f++){const h=o.utils.encode_cell({r:d,c:f}),g=s[h],p=g&&g.v||"";u.push(p.toString().trim())}l.push(u)}console.log(" Excel data converted to 2D array, first 3 rows:",l.slice(0,3));const c=Ys(l);console.log(` Parsed ${c.length} foods from Excel file`),e(c)}catch(o){console.error(" Error parsing Excel data:",o),t(new Error("Failed to parse Excel file. Please check the format."))}}function Ys(n){const e=[];if(n.length<3)return console.error("Excel has too few rows to parse."),[];const t=n[0].length;for(let o=0;o+4<t;o+=6){const r=(n[0][o]||"").toString().trim();if(!r)continue;const i=[(n[1][o]||"").toString().trim().toLowerCase(),(n[1][o+1]||"").toString().trim().toLowerCase(),(n[1][o+2]||"").toString().trim().toLowerCase(),(n[1][o+3]||"").toString().trim().toLowerCase(),(n[1][o+4]||"").toString().trim().toLowerCase()];if(i.join(",")!=="food item,brand,carb,fat,prot"){console.log(` Skipping section "${r}" - headers don't match expected format:`,i);continue}console.log(` Processing section "${r}" at column ${o}`);for(let s=2;s<n.length;s++){const a=n[s];if(!a||a.length<=o+4)continue;const l=(a[o]||"").toString().trim();if(!l)continue;let c=(a[o+1]||"").toString().trim();const d=parseFloat(a[o+2])||0,u=parseFloat(a[o+3])||0,f=parseFloat(a[o+4])||0;if((!c||c.length<=1||/^\d+$/.test(c)||/^\d+\.\d+$/.test(c)||/^[0-9\s\.]+$/.test(c)||c.toLowerCase().includes("carb")||c.toLowerCase().includes("fat")||c.toLowerCase().includes("prot")||c.toLowerCase().includes("protein")||c.toLowerCase().includes("brand")||c.toLowerCase().includes("item")||c.toLowerCase().includes("total")||c.toLowerCase().includes("example"))&&(c=""),l&&l.length>0&&l.length<100){const h=l.toLowerCase();if(["food item","foor item","brand","item","carb","fat","prot","total","add up values","example"].some(m=>h.includes(m)))continue;e.find(m=>m.name.toLowerCase()===tt(l).toLowerCase()&&m.brand.toLowerCase()===(c?tt(c):"").toLowerCase()&&m.category===r)||e.push({name:tt(l),brand:c?tt(c):"",carbs:d,fat:u,instructions:"",protein:f,category:r,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})}}}return e}function tt(n){return n.replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())}async function Zs(n){try{if(!y)throw new Error("Supabase client not initialized");const{data:{user:e},error:t}=await y.auth.getUser();if(t||!e)throw new Error("You must be logged in to add food data");const o={...n,user_id:e.id,created_by:e.email};await Vt(o),await fe(),x("Food added successfully","success")}catch(e){console.error("Error adding food:",e),x("Error adding food","error")}}async function $o(n){try{const e=document.getElementById(`qty-${n}`);if(!e)throw new Error("Could not find quantity input");const t=parseInt(e.value)||1;await mo(n,t);const o=document.querySelector(`[onclick="addToShoppingList('${n}')"]`);o&&(o.classList.add("added"),o.textContent="Remove from List",o.setAttribute("onclick",`handleRemoveFromShoppingList('${n}', true)`)),await pt(),x(`Added ${t} to shopping list!`,"success")}catch(e){console.error("Error adding to shopping list:",e),x("Error adding to shopping list","error")}}function x(n,e="success"){let t=document.getElementById("food-tracker-message");if(!t){t=document.createElement("div"),t.id="food-tracker-message",t.className="message";const o=document.getElementById("food-tracker")||document.body;o.insertBefore(t,o.firstChild)}t.textContent=n,t.className=`message ${e}`,t.style.display="block",setTimeout(()=>{t&&(t.style.display="none")},3e3)}async function Yt(n,e=!1){try{const t=L.find(o=>o.food_id===n||o.id===n);if(t){const{removeFromShoppingList:o}=await A(async()=>{const{removeFromShoppingList:r}=await Promise.resolve().then(()=>Ee);return{removeFromShoppingList:r}},void 0);await o(t.id),L=L.filter(r=>r.food_id!==n),Oe(),Me(F.filter(r=>{var a;const i=document.querySelector(".filter-btn.active"),s=(i==null?void 0:i.getAttribute("data-category"))||"all";return s==="all"||((a=r.category)==null?void 0:a.toLowerCase())===s.toLowerCase()})),setTimeout(()=>{document.querySelectorAll(".food-card").forEach(i=>{const s=i.querySelector(".add-btn"),a=i.getAttribute("data-food-id");if(s&&a){const l=L.some(c=>c.food_id===a||c.id===a);s.textContent=l?"Remove":"Add to List",s.classList.toggle("added",l)}})},100)}}catch(t){console.error("Error removing from shopping list:",t),x("Error removing item from shopping list","error")}}function Oe(){const n=document.getElementById("shoppingItems");if(!n)return;if(L.length===0){n.innerHTML='<p class="empty-state">Your shopping list is empty. Add items from the Food Tracker!</p>';return}const e=L.reduce((r,i)=>{var a;const s=((a=i.food)==null?void 0:a.category)||"Other";return r[s]||(r[s]=[]),r[s].push(i),r},{}),t=Object.keys(e).sort();t.forEach(r=>{e[r].sort((i,s)=>{var c,d;const a=((c=i==null?void 0:i.food)==null?void 0:c.name)||"",l=((d=s==null?void 0:s.food)==null?void 0:d.name)||"";return a.localeCompare(l)})});const o=t.map(r=>`
        <div class="shopping-category">
            <h3>${r}</h3>
            <div class="shopping-items-list">
                ${e[r].map(i=>{var s,a,l,c,d;return`
                    <div class="shopping-item" data-id="${i.id}">
                        <div class="item-info">
                            <span class="item-name">${((s=i.food)==null?void 0:s.name)||"Unknown Food"}</span>
                            ${(a=i.food)!=null&&a.brand?`<span class="item-brand">(${i.food.brand})</span>`:""}
                            <div class="macro-info">
                                <span>Carbs: ${((l=i.food)==null?void 0:l.carbs)||0}g</span>
                                <span>Fat: ${((c=i.food)==null?void 0:c.fat)||0}g</span>
                                <span>Protein: ${((d=i.food)==null?void 0:d.protein)||0}g</span>
                            </div>
                        </div>
                        <div class="item-quantity">
                            <input type="number" 
                                   value="${i.quantity}" 
                                   min="1" 
                                   onchange="updateShoppingItemQuantity('${i.id}', this.value)">
                            <button onclick="handleRemoveFromShoppingList('${i.id}')" class="remove-btn">
                                Remove
                            </button>
                        </div>
                    </div>
                `}).join("")}
            </div>
        </div>
    `).join("");n.innerHTML=o,ea()}function ea(){const n=document.getElementById("shoppingTotals");if(!n)return;const e=L.reduce((o,r)=>{const i=r.quantity||0,s=r.grams_per_unit||1,l=i*s/100;return o.carbs+=(r.carbs||0)*l,o.fat+=(r.fat||0)*l,o.protein+=(r.protein||0)*l,o},{carbs:0,fat:0,protein:0}),t={carbs:e.carbs.toFixed(1),fat:e.fat.toFixed(1),protein:e.protein.toFixed(1)};n.innerHTML=`
        <div class="totals-header">Shopping List Totals</div>
        <div class="macro-totals">
            <div class="macro-total">
                <span class="macro-label">Carbs:</span>
                <span class="macro-value">${t.carbs}g</span>
            </div>
            <div class="macro-total">
                <span class="macro-label">Fat:</span>
                <span class="macro-value">${t.fat}g</span>
            </div>
            <div class="macro-total">
                <span class="macro-label">Protein:</span>
                <span class="macro-value">${t.protein}g</span>
            </div>
        </div>
    `,n.style.display="block"}async function ta(){try{console.log(" Force refreshing shopping list to clear orphaned data..."),await Kt(),L=[],await pt(),console.log(" Shopping list force refresh completed")}catch(n){console.error(" Error during force refresh:",n)}}async function Zt(){try{console.log(" FOOD-TRACKER: Starting shopping list clear..."),await Kt(),console.log(" Database cleared"),L=[],console.log(" Local food-tracker array cleared");try{typeof window.clearAllShoppingItems=="function"&&(await window.clearAllShoppingItems(!0),console.log(" shopping-list.ts system also cleared"))}catch(n){console.warn(" Could not clear shopping-list.ts system:",n)}Oe(),Me(F.filter(n=>{var o;const e=document.querySelector(".filter-btn.active"),t=(e==null?void 0:e.getAttribute("data-category"))||"all";return t==="all"||((o=n.category)==null?void 0:o.toLowerCase())===t.toLowerCase()})),console.log(" Shopping list fully cleared!"),x("Shopping list cleared! ","success")}catch(n){console.error(" Error clearing shopping list:",n),x("Error clearing shopping list","error")}}async function Po(){console.log(" Reloading shopping list from database..."),await pt(),console.log(" Shopping list reloaded successfully")}window.addToShoppingList=$o;window.removeFromShoppingList=Yt;window.handleRemoveFromShoppingList=oa;window.filterByCategory=So;window.clearShoppingList=Zt;window.handleClearShoppingList=na;window.updateShoppingListDisplay=Oe;window.reloadShoppingListFromDatabase=Po;window.printShoppingList=Co;window.loadAndDisplayFoods=fe;window.reloadFoodTracker=fe;window.editFood=To;window.updateQuantity=Vs;window.updateServingUnit=Js;window.debugShoppingList=function(){if(console.log(" DEBUG: Shopping List State"),console.log(" FOOD-TRACKER array length:",L.length),console.log(" FOOD-TRACKER array contents:",L),typeof window.getCurrentShoppingList=="function"){const n=window.getCurrentShoppingList();console.log(" SHOPPING-LIST array length:",n.length),console.log(" SHOPPING-LIST array contents:",n)}Oe()};window.forceFixShoppingList=function(){console.log(" FORCE FIX: Clearing shopping list completely"),ta().then(()=>{console.log(" Shopping list force fix completed")}).catch(n=>{console.error(" Error during force fix:",n)})};function na(){if(console.log(" FOOD-TRACKER: Clear shopping list requested..."),!L||L.length===0){x("Shopping list is already empty!","success");return}confirm(`Are you sure you want to clear all ${L.length} items from your shopping list? This cannot be undone.`)?Zt().catch(e=>{console.error("Error clearing shopping list:",e),x("Error clearing shopping list","error")}):console.log(" Clear shopping list cancelled by user")}function oa(n,e=!1){Yt(n,e).catch(t=>{console.error("Error removing from shopping list:",t),x("Error removing item","error")})}function Co(){var c;if(!L||L.length===0){x("Your shopping list is empty. Add some items first!","error");return}const n=te(),e=((c=n==null?void 0:n.user_metadata)==null?void 0:c.name)||(n==null?void 0:n.email)||"User",t=window.open("","_blank");if(!t){x("Please allow popups to print your shopping list","error");return}let o=0,r=0,i=0,s=0;L.forEach(d=>{o+=(parseFloat(d.carbs)||0)*d.quantity,r+=(parseFloat(d.fat)||0)*d.quantity,i+=(parseFloat(d.protein)||0)*d.quantity,s+=d.quantity});const a={};L.forEach(d=>{const u=d.category||"Other";a[u]||(a[u]=[]),a[u].push(d)});const l=`
    <!DOCTYPE html>
    <html>
    <head>
      <title>NutriValor - Shopping List</title>
      <style>
        body { 
          font-family: Arial, sans-serif; 
          margin: 10px; 
          line-height: 1.2;
          font-size: 12px;
        }
        .header {
          text-align: center;
          border-bottom: 1px solid #333;
          padding-bottom: 8px;
          margin-bottom: 15px;
        }
        .header h1 {
          font-size: 18px;
          margin: 0 0 5px 0;
        }
        .user-info {
          font-size: 12px;
          color: #667eea;
          font-weight: bold;
          margin-bottom: 5px;
        }
        .header p {
          font-size: 10px;
          margin: 0;
          color: #666;
        }
        .content-wrapper {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          column-fill: balance;
        }
        .category {
          margin-bottom: 12px;
          break-inside: avoid;
          page-break-inside: avoid;
        }
        .category-title {
          background: #f5f5f5;
          padding: 4px 8px;
          font-weight: bold;
          font-size: 13px;
          border-left: 3px solid #667eea;
          margin-bottom: 5px;
        }
        .item {
          padding: 3px 8px;
          border-bottom: 1px solid #eee;
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          font-size: 11px;
        }
        .item-checkbox {
          width: 12px;
          height: 12px;
          border: 1px solid #333;
          margin-right: 8px;
          margin-top: 2px;
          flex-shrink: 0;
        }
        .item-details {
          flex: 1;
          margin-right: 8px;
        }
        .item-name {
          font-weight: bold;
          font-size: 12px;
          line-height: 1.2;
        }
        .item-brand {
          color: #666;
          font-style: italic;
          font-size: 10px;
          line-height: 1.1;
        }
        .item-nutrition {
          font-size: 9px;
          color: #888;
          line-height: 1.1;
          margin-top: 2px;
        }
        .item-quantity {
          font-weight: bold;
          color: #667eea;
          font-size: 11px;
          white-space: nowrap;
        }
        .totals {
          margin-top: 15px;
          border: 1px solid #333;
          padding: 10px;
          background: #f9f9f9;
          break-inside: avoid;
          page-break-inside: avoid;
          grid-column: 1 / -1;
        }
        .totals-title {
          font-size: 14px;
          font-weight: bold;
          margin-bottom: 8px;
          text-align: center;
        }
        .totals-grid {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 8px;
          text-align: center;
        }
        .total-item {
          padding: 5px;
          background: white;
          border-radius: 3px;
        }
        .total-label {
          font-size: 9px;
          color: #666;
          display: block;
        }
        .total-value {
          font-size: 12px;
          font-weight: bold;
          color: #333;
        }
        .footer {
          margin-top: 15px;
          text-align: center;
          font-size: 9px;
          color: #666;
          border-top: 1px solid #ccc;
          padding-top: 5px;
          grid-column: 1 / -1;
        }
        @media screen and (max-width: 600px) {
          .content-wrapper {
            grid-template-columns: 1fr;
          }
        }
        @media print {
          body { margin: 5px; }
          .category { break-inside: avoid; page-break-inside: avoid; }
          .item { break-inside: avoid; }
          .totals { break-inside: avoid; page-break-inside: avoid; }
        }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>NutriValor Shopping List</h1>
        <div class="user-info">For: ${e}</div>
        <p>${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p>
      </div>
      
      <div class="content-wrapper">
        ${Object.keys(a).sort().map(d=>`
          <div class="category">
            <div class="category-title">${d}</div>
            ${a[d].map(u=>`
              <div class="item">
                <div class="item-checkbox"></div>
                <div class="item-details">
                  <div class="item-name">${u.name}</div>
                  ${u.brand?`<div class="item-brand">${u.brand}</div>`:""}
                  <div class="item-nutrition">
                    C:${Ce(u.carbs)}g F:${Ce(u.fat)}g P:${Ce(u.protein)}g
                  </div>
                </div>
                <div class="item-quantity">${u.quantity}</div>
              </div>
            `).join("")}
          </div>
        `).join("")}
        
        <div class="totals">
          <div class="totals-title">Nutrition Totals</div>
          <div class="totals-grid">
            <div class="total-item">
              <span class="total-label">Items</span>
              <div class="total-value">${s}</div>
            </div>
            <div class="total-item">
              <span class="total-label">Carbs</span>
              <div class="total-value">${o.toFixed(1)}g</div>
            </div>
            <div class="total-item">
              <span class="total-label">Fat</span>
              <div class="total-value">${r.toFixed(1)}g</div>
            </div>
            <div class="total-item">
              <span class="total-label">Protein</span>
              <div class="total-value">${i.toFixed(1)}g</div>
            </div>
          </div>
        </div>
        
        <div class="footer">
          <p> NutriValor - Value your Nutrition</p>
        </div>
      </div>
      
      <script>
        window.onload = function() {
          window.print();
        }
      <\/script>
    </body>
    </html>
  `;t.document.write(l),t.document.close(),x("Opening print dialog...","success")}function To(n){const e=F.find(f=>f.id===n);if(!e){console.error("Food not found:",n);return}const t=document.getElementById("editFoodForm"),o=document.getElementById("editFoodId"),r=document.getElementById("editFoodName"),i=document.getElementById("editFoodBrand"),s=document.getElementById("editFoodCarbs"),a=document.getElementById("editFoodFat"),l=document.getElementById("editFoodProtein"),c=document.getElementById("editFoodInstructions"),d=document.getElementById("editFoodCategory");if(!t||!o||!r||!i||!s||!a||!l||!c||!d){console.error("Edit form elements not found");return}o.value=e.id,r.value=e.name,i.value=e.brand||"",s.value=e.carbs||"0",a.value=e.fat||"0",l.value=e.protein||"0",c.value=e.instructions||"",d.value=e.category||"OTHER";const u=document.getElementById("editFoodModal");u&&(u.style.display="block")}function Ao(){const n=document.getElementById("editFoodModal");n&&(n.style.display="none")}async function ra(){const n=document.getElementById("editFoodId");if(!n||!n.value){x("No food selected for deletion","error");return}if(confirm("Are you sure you want to delete this food?"))try{await go(n.value),x("Food deleted successfully","success"),Ao(),await fe()}catch(t){console.error("Error deleting food:",t),x("Error deleting food","error")}}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("editFoodForm")&&console.log("Food edit form found, event handling moved to simple-edit.ts")});const xo=Object.freeze(Object.defineProperty({__proto__:null,addFood:Zs,addToShoppingList:$o,get allFoods(){return F},cancelFoodEdit:Ao,clearShoppingList:Zt,deleteFoodFromEdit:ra,displayFoods:Me,editFood:To,filterByCategory:So,handleFoodFileUpload:ko,initializeFoodTracker:Eo,loadAndDisplayFoods:fe,printShoppingList:Co,reloadShoppingListFromDatabase:Po,removeFromShoppingList:Yt,updateShoppingListDisplay:Oe},Symbol.toStringTag,{value:"Module"}));let R=[],z="",U="",V="",j=null,Ot=!1;async function ia(){await Lo(),da(),ca(),sa(),mt(),yt(),la(),aa()}function sa(){const n=document.getElementById("idealWeight"),e=()=>{n!=null&&n.value&&en()};n&&n.addEventListener("input",e)}function aa(){setTimeout(()=>{const n=document.getElementById("idealWeight");n!=null&&n.value?en():pa(" Tip: Fill out your ideal weight in Settings  Profile to auto-populate here")},500)}async function Lo(){if(Ot)return;try{R=(await Xt()).map(o=>({date:o.entry_date,weight:o.weight,user_id:o.user_id}))}catch{R=[]}const n=te(),e=(n==null?void 0:n.id)||"anonymous";try{const{loadProfileFromDatabase:t}=await A(async()=>{const{loadProfileFromDatabase:r}=await Promise.resolve().then(()=>Ee);return{loadProfileFromDatabase:r}},void 0),o=await t();if(o&&o.ideal_weight){let r=o.ideal_weight;o.weight_unit==="lbs"&&(r=o.ideal_weight*.453592),U=r.toString(),setTimeout(()=>{const i=document.getElementById("idealWeight");i&&Bo(i,`Ideal weight loaded from profile (${o.ideal_weight} ${o.weight_unit})`)},100)}else U=localStorage.getItem(`idealWeight_${e}`)||""}catch{U=localStorage.getItem(`idealWeight_${e}`)||""}z=localStorage.getItem(`startingWeight_${e}`)||"",V=localStorage.getItem(`targetDate_${e}`)||""}function Fo(){const n=te(),e=(n==null?void 0:n.id)||"anonymous";localStorage.setItem(`startingWeight_${e}`,z),localStorage.setItem(`idealWeight_${e}`,U),localStorage.setItem(`targetDate_${e}`,V)}function la(){const n=new Date().toISOString().split("T")[0],e=document.getElementById("entryDate");e&&!e.value&&(e.value=n)}function ca(){const n=document.getElementById("startingWeight"),e=document.getElementById("idealWeight"),t=document.getElementById("targetDate");n&&(n.value=z,n.addEventListener("input",fa),n.addEventListener("change",nt),n.addEventListener("blur",()=>{nt()})),e&&(e.value=U,e.addEventListener("change",nt)),t&&(t.value=V,t.addEventListener("change",nt))}function da(){if(document.getElementById("weightChart"))if(typeof window.Chart>"u"){const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/chart.js",e.onload=()=>Cn(),document.head.appendChild(e)}else Cn()}function Cn(){const n=document.getElementById("weightChart");if(!n)return;j&&(j.destroy(),j=null);const e=n.getContext("2d");e&&(j=new window.Chart(e,{type:"line",data:{labels:[],datasets:[{label:"Actual Weight",data:[],borderColor:"#667eea",backgroundColor:"rgba(102, 126, 234, 0.1)",tension:.3,fill:!0},{label:"Ideal Path",data:[],borderColor:"#10b981",borderDash:[5,5],tension:0,fill:!1,pointRadius:0}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Date"}},y:{title:{display:!0,text:"Weight (kg)"}}},plugins:{title:{display:!0,text:"Weight Progress",font:{size:16,weight:"bold"}},legend:{position:"bottom",labels:{padding:20,font:{size:12}}}}}}))}function ua(n){if(!z||!U||R.length===0)return[];const e=R[0].date,t=new Date(e).getTime();let o;V?o=new Date(V).getTime():o=t+6*30*24*60*60*1e3;const r=o-t;if(r<=0)return[];const i=parseFloat(z),a=parseFloat(U)-i;return(V?[...new Set([...n,V])].sort():n).map(d=>{const u=new Date(d).getTime();if(u<t)return null;const f=u-t,h=Math.min(1,f/r),g=i+a*h;return{x:d,y:parseFloat(g.toFixed(1))}}).filter(d=>d!==null)}function mt(){if(!j)return;R.sort((r,i)=>new Date(r.date).getTime()-new Date(i.date).getTime());const n=R.map(r=>r.date),e=R.map(r=>({x:r.date,y:r.weight}));j.data.datasets[0].data=e;const t=ua(n);j.data.datasets[1].data=t;const o=[...new Set([...n,V].filter(Boolean))].sort();V&&z&&U?j.data.labels=o:j.data.labels=n,j.update()}function yt(){const n=document.getElementById("progressText");if(!n)return;if(!z||R.length===0){n.textContent="";return}const e=parseFloat(z);if(isNaN(e)){n.textContent="";return}if(R.length>0&&!z){n.textContent='Please click "Clear All Data" to reset tracking.',n.style.color="#d97706";return}const t=R[R.length-1].weight,o=(e-t).toFixed(1);parseFloat(o)>0?(n.textContent=`Congratulations! You've lost ${o}kg so far.`,n.style.color="#065f46"):parseFloat(o)<0?(n.textContent=`You've gained ${Math.abs(parseFloat(o))}kg. Keep going!`,n.style.color="#991b1b"):(n.textContent="You're at your starting weight. Keep going!",n.style.color="#1e293b")}async function ha(){const n=document.getElementById("entryDate"),e=document.getElementById("entryWeight"),t=document.getElementById("startingWeight"),o=n==null?void 0:n.value,r=parseFloat((e==null?void 0:e.value)||"0"),i=parseFloat((t==null?void 0:t.value)||"0");if(!o||!r){ue("Please enter a date and weight.");return}if(!i&&!z){ue("Please enter a starting weight first.");return}i&&!z&&(z=i.toString());try{await _o(r,o);const s=R.findIndex(a=>a.date===o);s>-1?R[s].weight=r:R.push({date:o,weight:r}),Fo(),mt(),yt(),e&&(e.value=""),ue("Weight entry added successfully!")}catch{ue("Error saving weight entry. Please try again.")}}async function fa(){document.getElementById("startingWeight");const n=document.getElementById("idealWeight"),e=document.getElementById("targetDate"),t=(n==null?void 0:n.value)||"",o=(e==null?void 0:e.value)||"",r=t&&t!==U;U=t,V=o;const i=te(),s=(i==null?void 0:i.id)||"anonymous";if(localStorage.setItem(`idealWeight_${s}`,U),localStorage.setItem(`targetDate_${s}`,V),r)try{const{loadProfileFromDatabase:a,saveProfileToDatabase:l}=await A(async()=>{const{loadProfileFromDatabase:d,saveProfileToDatabase:u}=await Promise.resolve().then(()=>Ee);return{loadProfileFromDatabase:d,saveProfileToDatabase:u}},void 0),c=await a();if(c){const d={name:c.name,dateOfBirth:c.date_of_birth,age:c.age,gender:c.gender,height:c.height,heightUnit:c.height_unit,idealWeight:t,weightUnit:c.weight_unit||"kg",country:c.country,avatar:c.avatar_url};await l(d)}}catch{}mt(),yt()}async function nt(){const n=document.getElementById("startingWeight"),e=document.getElementById("idealWeight"),t=document.getElementById("targetDate"),o=(n==null?void 0:n.value)||"",r=(e==null?void 0:e.value)||"",i=(t==null?void 0:t.value)||"",s=r&&r!==U;z=o,U=r,V=i,Fo();const a=document.getElementById("entryWeight"),l=new Date().toISOString().split("T")[0],c=R.find(u=>u.date===l);if(o&&a&&!a.value&&!c&&(a.value=o,ue(` Your starting weight (${o}kg) has been added to today's weight field. Click "Add Entry" to save it.`)),s)try{const{loadProfileFromDatabase:u,saveProfileToDatabase:f}=await A(async()=>{const{loadProfileFromDatabase:g,saveProfileToDatabase:p}=await Promise.resolve().then(()=>Ee);return{loadProfileFromDatabase:g,saveProfileToDatabase:p}},void 0),h=await u();if(h){const g={name:h.name,dateOfBirth:h.date_of_birth,age:h.age,gender:h.gender,height:h.height,heightUnit:h.height_unit,idealWeight:r,weightUnit:h.weight_unit||"kg",country:h.country,avatar:h.avatar_url};await f(g)}}catch{}mt(),yt()}async function ga(){if(confirm("Are you sure you want to delete all weight data? This cannot be undone.")){Ot=!0;try{if(await bo(),(await Xt()).length>0){ue("Warning: Not all data was cleared. Please try again.");return}const e=te(),t=(e==null?void 0:e.id)||"anonymous";localStorage.removeItem(`startingWeight_${t}`),localStorage.removeItem(`idealWeight_${t}`),localStorage.removeItem(`targetDate_${t}`),R=[],z="",U="",V="";const o=document.getElementById("startingWeight"),r=document.getElementById("idealWeight"),i=document.getElementById("targetDate"),s=document.getElementById("progressText"),a=document.getElementById("entryWeight");o&&(o.value=""),r&&(r.value=""),i&&(i.value=""),a&&(a.value=""),s&&(s.textContent="");let l=!1;try{const{loadProfileFromDatabase:c}=await A(async()=>{const{loadProfileFromDatabase:u}=await Promise.resolve().then(()=>Ee);return{loadProfileFromDatabase:u}},void 0),d=await c();d&&d.ideal_weight&&(l=!0)}catch{}if(j&&(j.data.labels=[],j.data.datasets[0].data=[],j.data.datasets[1].data=[],j.update()),en(),l){await Lo();const c=document.getElementById("idealWeight");c&&U&&(c.value=U,Bo(c,"Ideal weight from profile"))}ue("All weight data cleared successfully!")}catch{ue("Error clearing weight data. Please try again.")}finally{Ot=!1}}}function ue(n,e="success"){let t=document.getElementById("weight-message");if(!t){t=document.createElement("div"),t.id="weight-message",t.className="message";const o=document.getElementById("weight-tracker")||document.body;o.insertBefore(t,o.firstChild)}t.textContent=n,t.className=`message ${e}`,t.style.display="block",setTimeout(()=>{t&&(t.style.display="none")},3e3)}function pa(n){let e=document.getElementById("weight-profile-tip");if(!e){e=document.createElement("div"),e.id="weight-profile-tip",e.className="message warning";const t=document.getElementById("weight-tracker")||document.body;t.insertBefore(e,t.firstChild)}e.textContent=n,e.className="message warning",e.style.display="block"}function en(){const n=document.getElementById("weight-profile-tip");n&&(n.style.display="none")}function Bo(n,e){var r;const t=(r=n.parentElement)==null?void 0:r.querySelector(".profile-indicator");t&&t.remove();const o=document.createElement("span");o.className="profile-indicator",o.innerHTML="",o.title=e,o.style.marginLeft="8px",o.style.color="#10b981",o.style.fontSize="14px",o.style.cursor="help",o.style.filter="grayscale(0.3) brightness(1.2)",n.style.borderLeft="3px solid #10b981",n.parentElement&&(n.parentElement.style.position="relative",n.parentElement.appendChild(o))}window.addWeightEntry=ha;window.clearWeightData=ga;async function ma(){await va(),wa(),ya()}function ya(){const n=document.getElementById("macro-age"),e=document.getElementById("macro-gender"),t=document.getElementById("macro-height"),o=()=>{n!=null&&n.value&&(e!=null&&e.value)&&(t!=null&&t.value)&&Mo()};n&&n.addEventListener("input",o),e&&e.addEventListener("change",o),t&&t.addEventListener("input",o)}async function va(){try{const n=await Qt();if(n){const r=document.getElementById("macro-age"),i=document.getElementById("macro-gender"),s=document.getElementById("macro-height");if(r&&n.age&&(r.value=n.age.toString(),$t(r,"Age loaded from profile")),i&&n.gender&&(i.value=n.gender,$t(i,"Gender loaded from profile")),s&&n.height){let a=n.height;n.height_unit==="ft"&&(a=n.height*30.48),s.value=a.toString(),$t(s,`Height loaded from profile (${n.height} ${n.height_unit})`)}}setTimeout(()=>{const r=document.getElementById("macro-age"),i=document.getElementById("macro-gender"),s=document.getElementById("macro-height"),a=[];if(r!=null&&r.value||a.push("Age"),(!(i!=null&&i.value)||(i==null?void 0:i.value)==="")&&a.push("Gender"),s!=null&&s.value||a.push("Height"),a.length>0){const l=a.join(", ");Sa(` Tip: Fill out your profile in Settings to auto-populate ${l}`)}else Mo()},500);const e=te(),t=(e==null?void 0:e.id)||"anonymous",o=localStorage.getItem(`macroProfile_${t}`);if(o)try{const r=JSON.parse(o);if(console.log(" Found localStorage macro profile:",r),!n)console.log(" No Supabase profile, using full localStorage profile"),Tn(r);else{console.log(" Using Supabase profile + localStorage macro settings");const i=document.getElementById("macro-weight"),s=document.getElementById("macro-activity"),a=document.getElementById("macro-lossRate"),l=document.getElementById("macro-proteinRatio"),c=document.getElementById("macro-fatRatio");s&&(s.value=r.activity.toString()),a&&(a.value=r.lossRate.toString()),l&&(l.value=r.proteinRatio.toString()),c&&(c.value=r.fatRatio.toString()),console.log(" Skipped loading weight from localStorage - user should enter manually")}}catch(r){console.error("Error loading saved macro profile:",r)}}catch(n){console.error("Error loading profile from database:",n);const e=te(),t=(e==null?void 0:e.id)||"anonymous",o=localStorage.getItem(`macroProfile_${t}`);if(o)try{const r=JSON.parse(o);Tn(r)}catch(r){console.error("Error loading saved macro profile:",r)}}}function wa(){const n=document.getElementById("macro-activity"),e=document.getElementById("macro-lossRate"),t=document.getElementById("macro-proteinRatio"),o=document.getElementById("macro-fatRatio");n&&!n.value&&(n.value="1.55"),e&&!e.value&&(e.value="0"),t&&!t.value&&(t.value="2.2"),o&&!o.value&&(o.value="0.8")}function Tn(n){const e=document.getElementById("macro-age"),t=document.getElementById("macro-gender"),o=document.getElementById("macro-weight"),r=document.getElementById("macro-height"),i=document.getElementById("macro-activity"),s=document.getElementById("macro-lossRate"),a=document.getElementById("macro-proteinRatio"),l=document.getElementById("macro-fatRatio");e&&(e.value=n.age.toString()),t&&(t.value=n.gender),o&&(o.value=n.weight.toString()),r&&(r.value=n.height.toString()),i&&(i.value=n.activity.toString()),s&&(s.value=n.lossRate.toString()),a&&(a.value=n.proteinRatio.toString()),l&&(l.value=n.fatRatio.toString())}function _a(){const n=document.getElementById("macro-age"),e=document.getElementById("macro-gender"),t=document.getElementById("macro-weight"),o=document.getElementById("macro-height"),r=document.getElementById("macro-activity"),i=document.getElementById("macro-lossRate"),s=document.getElementById("macro-proteinRatio"),a=document.getElementById("macro-fatRatio"),l=parseFloat((n==null?void 0:n.value)||"0"),c=(e==null?void 0:e.value)||"male",d=parseFloat((t==null?void 0:t.value)||"0"),u=parseFloat((o==null?void 0:o.value)||"0"),f=parseFloat((r==null?void 0:r.value)||"1.55"),h=parseFloat((i==null?void 0:i.value)||"0"),g=parseFloat((s==null?void 0:s.value)||"2.2"),p=parseFloat((a==null?void 0:a.value)||"0.8");if(!l||!d||!u){de("Please fill in all required fields (Age, Weight, Height)","error");return}if(l<10||l>120){de("Please enter a valid age between 10 and 120","error");return}if(d<20||d>300){de("Please enter a valid weight between 20 and 300 kg","error");return}if(u<100||u>250){de("Please enter a valid height between 100 and 250 cm","error");return}let m;c==="male"?m=10*d+6.25*u-5*l+5:m=10*d+6.25*u-5*l-161;let w=m*f;const _=w+h;let v=d*g,b=d*p,k=(_-v*4-b*9)/4;v=Math.max(0,Math.round(v)),b=Math.max(0,Math.round(b)),k=Math.max(10,Math.round(k));const $={protein:v,carbs:k,fat:b,calories:Math.round(_),bmr:Math.round(m),tdee:Math.round(w)};ba($),de("Macro calculations completed successfully!","success")}function ba(n){const e=document.getElementById("protein-value"),t=document.getElementById("carbs-value"),o=document.getElementById("fat-value"),r=document.getElementById("calories-value"),i=document.getElementById("bmr-value"),s=document.getElementById("tdee-value"),a=document.getElementById("adjusted-calories"),l=document.getElementById("macro-results"),c=document.getElementById("macro-explanation");e&&(e.textContent=`${n.protein}g`),t&&(t.textContent=`${n.carbs}g`),o&&(o.textContent=`${n.fat}g`),r&&(r.textContent=n.calories.toString()),i&&(i.textContent=n.bmr.toString()),s&&(s.textContent=n.tdee.toString()),a&&(a.textContent=n.calories.toString()),l&&(l.style.display="grid",l.classList.add("show-results")),c&&(c.style.display="block")}function Ea(){const n=document.getElementById("macro-age"),e=document.getElementById("macro-gender"),t=document.getElementById("macro-weight"),o=document.getElementById("macro-height"),r=document.getElementById("macro-activity"),i=document.getElementById("macro-lossRate"),s=document.getElementById("macro-proteinRatio"),a=document.getElementById("macro-fatRatio"),l={age:parseFloat((n==null?void 0:n.value)||"0"),gender:(e==null?void 0:e.value)||"male",weight:parseFloat((t==null?void 0:t.value)||"0"),height:parseFloat((o==null?void 0:o.value)||"0"),activity:parseFloat((r==null?void 0:r.value)||"1.55"),lossRate:parseFloat((i==null?void 0:i.value)||"0"),proteinRatio:parseFloat((s==null?void 0:s.value)||"2.2"),fatRatio:parseFloat((a==null?void 0:a.value)||"0.8")};if(!l.age||!l.weight||!l.height){de("Please fill in all required fields before saving","error");return}const c=te(),d=(c==null?void 0:c.id)||"anonymous";try{localStorage.setItem(`macroProfile_${d}`,JSON.stringify(l)),de("Macro profile saved successfully!","success")}catch(u){console.error("Error saving macro profile:",u),de("Error saving macro profile","error")}}function de(n,e="success"){let t=document.getElementById("macro-message");if(!t){t=document.createElement("div"),t.id="macro-message",t.className="message";const o=document.getElementById("macro-calculator")||document.body;o.insertBefore(t,o.firstChild)}t.textContent=n,t.className=`message ${e}`,t.style.display="block",setTimeout(()=>{t&&(t.style.display="none")},4e3)}function Sa(n){let e=document.getElementById("macro-profile-tip");if(!e){e=document.createElement("div"),e.id="macro-profile-tip",e.className="message warning";const t=document.getElementById("macro-calculator")||document.body;t.insertBefore(e,t.firstChild)}e.textContent=n,e.className="message warning",e.style.display="block"}function Mo(){const n=document.getElementById("macro-profile-tip");n&&(n.style.display="none")}function $t(n,e){var r;const t=(r=n.parentElement)==null?void 0:r.querySelector(".profile-indicator");t&&t.remove();const o=document.createElement("span");o.className="profile-indicator",o.innerHTML="",o.title=e,o.style.marginLeft="8px",o.style.color="#10b981",o.style.fontSize="14px",o.style.cursor="help",o.style.filter="grayscale(0.3) brightness(1.2)",n.style.borderLeft="3px solid #10b981",n.parentElement&&(n.parentElement.style.position="relative",n.parentElement.appendChild(o))}window.calculateMacros=_a;window.saveMacroProfile=Ea;let ee=[],vt=ee,P={},q={},Dt=!1,Pt=!1;async function Oo(){await tn(),Ia(),La(),De(),Ra()}async function Do(){console.log(" Reloading meals..."),await tn()}function Ia(){document.addEventListener("click",n=>{n.target.closest(".add-to-plan-container")||document.querySelectorAll(".meal-plan-dropdown").forEach(t=>{t.style.display="none"})}),window.removeIngredientRow=qo,window.addNewIngredientRow=Ua,window.addToMealPlan=nn,window.toggleMealPlanDropdown=Uo,window.updateMealShoppingCheckboxes=jo}window.showMealUploadModal=function(){W("Meal upload functionality has been deprecated. Meals are now managed through the database.","info")};window.closeMealUploadModal=function(){};async function tn(){try{const{data:n,error:e}=await y.from("meals").select("*").order("name");if(e)throw e;const{data:t,error:o}=await y.from("foods").select("*");if(o)throw o;const{data:r,error:i}=await y.from("serving_units").select("*");if(i)throw i;const s=(n||[]).map(a=>{let l;try{l=typeof a.ingredients=="string"?JSON.parse(a.ingredients):a.ingredients||[]}catch(d){console.error(`Error parsing ingredients for meal ${a.name}:`,d),l=[]}const c=l.map(d=>{const u=t.find(w=>w.id===d.food_id);if(!u)return d;const f=d.quantity??1,h=(d.serving_unit||"").toUpperCase();let g=0,p=0,m=0;if(h==="EACH")g=+(u.carbs*f).toFixed(1),p=+(u.fat*f).toFixed(1),m=+(u.protein*f).toFixed(1);else{const w=r.find(_=>_.food_id===u.id&&_.unit_name===h);if(w&&w.grams_per_unit){const v=w.grams_per_unit*f/100;g=+(u.carbs*v).toFixed(1),p=+(u.fat*v).toFixed(1),m=+(u.protein*v).toFixed(1)}else return console.warn(` [DEBUG] No serving unit found for ${u.name} ${h}, using stored values`),d}return{...d,carbs:g,fat:p,protein:m}});return{...a,ingredients:c}});vt=s,await Ke(s)}catch(n){console.error("Error loading meals:",n),W("Error loading meals","error")}}function ka(){const n=document.getElementById("mealGrid"),e=document.getElementById("availableMealsGrid");n&&(n.innerHTML='<p class="no-data">No meals found in database. Meals can be created through the admin interface.</p>'),e&&(e.innerHTML='<p class="no-data">No meals found in database. Meals can be created through the admin interface.</p>')}function Ke(n,e=!1){var s;if(!n||n.length===0){ka();return}e||$a(n);const t=document.querySelector(".meal-filters .filter-btn.active"),o=((s=t==null?void 0:t.getAttribute("data-category"))==null?void 0:s.toUpperCase())||"ALL",r=o==="ALL"?n:n.filter(a=>a.meal_type===o),i=document.getElementById("mealGrid");i&&Pa(i,r)}function $a(n){const e=document.querySelectorAll(".meal-filters");if(!e.length){console.log(" No meal filter containers found");return}const o=[...new Set(n.map(s=>s.meal_type).filter(s=>s))].map(s=>s.toUpperCase()),i=["all",...["BREAKFAST","LUNCH","DINNER","SNACKS","SAUCES","OTHER"].filter(s=>o.includes(s))];e.forEach((s,a)=>{s.innerHTML=i.map((l,c)=>`
              <button class="filter-btn ${c===0?"active":""}" onclick="filterMealsByCategory('${l}')" data-category="${l}">
                ${l==="all"?"All":l==="BREAKFAST"?"Breakfast":l==="LUNCH"?"Lunch":l==="DINNER"?"Dinner":l==="SNACKS"?"Snacks":l==="SAUCES"?"Sauces":l}
              </button>
            `).join("")})}function Pa(n,e){if(e.length===0){n.innerHTML='<p class="no-data">No meals found in database. Meals can be created through the admin interface.</p>';return}const t=["Breakfast","Lunch","Dinner","Snacks","Sauces"],o=[...e].sort((i,s)=>{const a=t.indexOf(i.meal_type),l=t.indexOf(s.meal_type);return a!==-1&&l!==-1?a-l:a!==-1?-1:l!==-1?1:i.meal_type.localeCompare(s.meal_type)});let r="";o.forEach(i=>{r+=Ca(i)}),n.innerHTML=r}function Ca(n){console.log(` [DEBUG] Generating card for meal: ${n.name}`),console.log(" [DEBUG] Meal data:",n);const e=n.totalCarbs||n.ingredients.reduce((s,a)=>s+(a.carbs||0),0),t=n.totalFat||n.ingredients.reduce((s,a)=>s+(a.fat||0),0),o=n.totalProtein||n.ingredients.reduce((s,a)=>s+(a.protein||0),0);console.log(` [DEBUG] ${n.name} display totals: Carbs=${e}, Fat=${t}, Protein=${o}`),console.log(` [DEBUG] ${n.name} ingredients for display:`,n.ingredients);let r=null,i=n.name;if(n.picture)n.picture.startsWith("data:image/")?(r=n.picture,i=n.name):n.picture.startsWith("http")?(r=n.picture,i=n.picture.split("/").pop()||n.name):(r=`/images/${n.picture}`,i=n.picture);else{const s=n.name.replace(/[^\w\s]/g,"").trim();r=`/images/${s}.jpg`,i=`${s}.jpg`}return`
        <div class="meal-card" data-meal-id="${n.id||""}" data-meal-name="${n.name}">
            ${r?`
                <div class="meal-image-container">
                    <img src="${r}" alt="${n.name}" class="meal-image" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                         onload="this.style.display='block'; this.nextElementSibling.style.display='none';">
                    <div class="meal-image-fallback" style="display: none;">
                        <span class="image-icon"></span>
                        <div class="fallback-text">No Image</div>
                    </div>
                    <div class="meal-image-name">${i}</div>
                </div>
            `:`
                <div class="meal-image-container">
                    <div class="meal-image-fallback">
                        <span class="image-icon"></span>
                        <div class="fallback-text">No Image</div>
                    </div>
                </div>
            `}
            <div class="meal-header">
                <h4 class="meal-name">${n.name}</h4>
                <div class="meal-creator">Created By: ${n.created_by}</div>
            </div>
            ${n.cooking_instructions?`
                <div class="cooking-instructions">
                    <h5>Cooking Instructions:</h5>
                    <div class="instructions-content">${n.cooking_instructions}</div>
                </div>
            `:""}
            <div class="meal-ingredients">
                ${n.ingredients.map(s=>{if(typeof s.carbs!="number"&&typeof s.fat!="number"&&typeof s.protein!="number")return`
                            <div class="ingredient-item missing-ingredient">
                                <span class="ingredient-name">${s.name||s.food_name||"Unknown Ingredient"} (ingredient missing)</span>
                            </div>
                        `;const l=s.carbs||0,c=s.fat||0,d=s.protein||0;return`
                        <div class="ingredient-item">
                            <span class="ingredient-name">${s.name||s.food_name||"Unknown Ingredient"}</span>
                            <div class="ingredient-nutrition">
                                <span class="ingredient-carbs">${G(l)}g carbs</span>
                                <span class="ingredient-fat">${G(c)}g fat</span>
                                <span class="ingredient-protein">${G(d)}g protein</span>
                            </div>
                            ${s.instructions?`<div class="ingredient-instructions">${s.instructions}</div>`:""}
                        </div>
                    `}).join("")}
            </div>
            <div class="nutrition-info">
                <span>Carbs: ${G(e)}g</span>
                <span>Fat: ${G(t)}g</span>
                <span>Protein: ${G(o)}g</span>
            </div>
            <div class="meal-actions">
                <div class="add-to-plan-container">
                    <button class="secondary-btn add-to-plan-btn" onclick="toggleMealPlanDropdown('${n.id}')">
                        Add to Plan
                    </button>
                    <div class="meal-plan-dropdown" id="dropdown-${n.id}" style="display: none;">
                        <div class="dropdown-content">
                            <div class="dropdown-section">
                                <label>Day:</label>
                                <select class="day-select" id="day-${n.id}">
                                    <option value="Monday">Monday</option>
                                    <option value="Tuesday">Tuesday</option>
                                    <option value="Wednesday">Wednesday</option>
                                    <option value="Thursday">Thursday</option>
                                    <option value="Friday">Friday</option>
                                    <option value="Saturday">Saturday</option>
                                    <option value="Sunday">Sunday</option>
                                </select>
                            </div>
                            <div class="dropdown-section">
                                <label>Meal Time:</label>
                                <select class="meal-time-select" id="mealtime-${n.id}">
                                    <option value="breakfast" ${n.meal_type.toLowerCase()==="breakfast"?"selected":""}>Breakfast</option>
                                    <option value="lunch" ${n.meal_type.toLowerCase()==="lunch"?"selected":""}>Lunch</option>
                                    <option value="dinner" ${n.meal_type.toLowerCase()==="dinner"?"selected":""}>Dinner</option>
                                    <option value="snack" ${n.meal_type.toLowerCase()==="snack"||n.meal_type.toLowerCase()==="snacks"?"selected":""}>Snack</option>
                                </select>
                            </div>
                            <div class="dropdown-actions">
                                <button class="primary-btn" onclick="addMealToWeeklyPlan('${n.id}', '${n.name.replace(/'/g,"\\'")}')">Add</button>
                                <button class="secondary-btn" onclick="hideMealPlanDropdown('${n.id}')">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `}function W(n,e="info"){window.showMessage?window.showMessage(n,e):console.log(`${e.toUpperCase()}: ${n}`)}function nn(n){const e=ee.find(i=>i.id===n);if(!e){console.error("Meal not found:",n);return}const t=new Date().toISOString().split("T")[0];q[t]||(q[t]={breakfast:[],lunch:[],dinner:[],snack:[]});const o=["breakfast","lunch","dinner","snack"];let r=!1;for(const i of o)if(q[t][i].length<2){q[t][i].push(e),r=!0;break}if(!r){W("Meal plan is full for today","error");return}localStorage.setItem("nutrivalor_meal_plan",JSON.stringify(q)),wt(),W(`Added "${e.name}" to meal plan!`,"success")}function wt(){const n=document.getElementById("mealPlanGrid");if(!n)return;if(Object.keys(q).length===0){const r=localStorage.getItem("nutrivalor_meal_plan");if(r)try{q=JSON.parse(r),console.log(" Loaded daily meal plan from localStorage")}catch(i){console.error("Error loading daily meal plan:",i)}}const e=new Date().toISOString().split("T")[0],t=q[e]||{breakfast:[],lunch:[],dinner:[],snack:[]},o=["breakfast","lunch","dinner","snack"];n.innerHTML=`
        <div class="meal-plan-day">
            <h3>Today's Meal Plan</h3>
            ${o.map(r=>{const i=t[r]||[],s=i.reduce((a,l)=>a+(l.totalCarbs||0),0);return`
                    <div class="meal-type-plan">
                        <h4>${r.charAt(0).toUpperCase()+r.slice(1)}</h4>
                        <div class="meal-type-totals">
                            <span>Carbs: ${G(s)}g</span>
                        </div>
                        <div class="planned-meals">
                            ${i.map(a=>`
                                <div class="planned-meal">
                                    <span>${a.name}</span>
                                    <button onclick="removeMealFromPlan('${a.id}', '${r}')" class="remove-btn"></button>
                                </div>
                            `).join("")}
                        </div>
                    </div>
                `}).join("")}
        </div>
    `}function G(n){if(n==null||n==="")return"0";const e=parseFloat(n);return isNaN(e)?"0":e.toFixed(1)}function Ro(n){if(console.log(` Filtering meals by category: ${n}`),!ee||ee.length===0){console.log(" No meals available for filtering");const t=document.getElementById("mealGrid"),o=document.getElementById("availableMealsGrid");t&&(t.innerHTML='<p class="no-data">No meals loaded. Please upload your meal Excel file.</p>'),o&&(o.innerHTML='<p class="no-data">No meals loaded. Please upload your meal Excel file.</p>');return}let e;n==="all"||n==="ALL"?e=ee:e=ee.filter(t=>t.meal_type.toUpperCase()===n.toUpperCase()),console.log(` Found ${e.length} meals for category: ${n}`),document.querySelectorAll(".meal-filters .filter-btn").forEach(t=>{t.classList.remove("active")}),document.querySelectorAll(`[data-category="${n}"]`).forEach(t=>{t.classList.add("active")}),Ke(e,!0)}function Uo(n){document.querySelectorAll(".meal-plan-dropdown").forEach(t=>{t.id!==`dropdown-${n}`&&(t.style.display="none")});const e=document.getElementById(`dropdown-${n}`);if(e){const t=e.style.display==="block";if(e.style.display=t?"none":"block",e.style.visibility=t?"hidden":"visible",e.style.opacity=t?"0":"1",e.style.pointerEvents=t?"none":"auto",!t){const o=e.closest(".add-to-plan-container");if(o){const r=o.getBoundingClientRect(),s=window.innerHeight-r.bottom;r.top>s||s<200?(e.style.bottom="100%",e.style.top="auto",e.style.marginBottom="5px",e.style.marginTop="0"):(e.style.top="100%",e.style.bottom="auto",e.style.marginTop="5px",e.style.marginBottom="0")}setTimeout(()=>{document.addEventListener("click",function r(i){const s=i.target;!e.contains(s)&&!(s!=null&&s.closest(`#dropdown-${n}`))&&!(s!=null&&s.closest(".add-to-plan-btn"))&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",e.style.pointerEvents="none",document.removeEventListener("click",r))})},10)}}}function Rt(n){const e=document.getElementById(`dropdown-${n}`);e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",e.style.pointerEvents="none")}function Ta(n,e){console.log(` addMealToWeeklyPlan called with mealId: "${n}", mealName: "${e}"`),console.log(` Current meals count: ${ee.length}`),console.log(" Available meal IDs:",ee.map(l=>({id:l.id,name:l.name})));const t=ee.find(l=>l.id===n);if(!t){console.error(` Meal not found with ID: "${n}"`),console.error("Available meals:",ee.map(l=>`ID: "${l.id}", Name: "${l.name}"`)),W(`Meal not found: ${e}`,"error");return}console.log(` Found meal: ${t.name} with ID: ${t.id}`);const o=document.getElementById(`day-${n}`),r=document.getElementById(`mealtime-${n}`);if(!o||!r){console.error(` Dropdown selects not found for meal ID: ${n}`),console.error("daySelect:",o),console.error("mealTimeSelect:",r),W("Error: Dropdown elements not found","error");return}const i=o.value,s=r.value;console.log(` Selected day: ${i}, meal time: ${s}`),P[i]||(P[i]={breakfast:[],lunch:[],dinner:[],snack:[]}),console.log(` DUPLICATE CHECK: Looking for meal ID "${n}" in ${i} ${s}`),console.log(" DUPLICATE CHECK: Current meals in that slot:",P[i][s]),console.log(" DUPLICATE CHECK: Meal IDs in that slot:",P[i][s].map(l=>l.id));const a=P[i][s].find(l=>l.id===n);if(a){console.log(" DUPLICATE CHECK: Found existing meal:",a),W(`${e} is already planned for ${i} ${s}`,"error"),Rt(n);return}console.log(" DUPLICATE CHECK: No duplicate found, proceeding to add meal"),P[i][s].push(t),localStorage.setItem("nutrivalor_weekly_meal_plan",JSON.stringify(P)),De(),Rt(n),W(`Added "${e}" to ${i} ${s}!`,"success"),console.log(" Successfully added meal to weekly plan")}function Aa(n,e,t){if(P[e]&&P[e][t]){const o=P[e][t].findIndex(r=>r.id===n);o!==-1&&(P[e][t].splice(o,1),localStorage.setItem("nutrivalor_weekly_meal_plan",JSON.stringify(P)),De(),W("Meal removed from weekly plan","success"))}}function De(){const n=document.getElementById("weeklyMealPlan");if(!n)return;const e=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],t=["breakfast","lunch","dinner","snack"],o=["Breakfast","Lunch","Dinner","Snack"];let r="";e.forEach(i=>{const s=P[i]||{breakfast:[],lunch:[],dinner:[],snack:[]};let a=0,l=0,c=0,d=!1;r+=`
            <div class="day-plan">
                <div class="day-header">
                    <div class="day-name">${i}</div>
                </div>
                <div class="meal-types">
                    ${t.map((u,f)=>{const h=s[u]||[],g=h.reduce((w,_)=>w+(_.totalCarbs||0),0),p=h.reduce((w,_)=>w+(_.totalFat||0),0),m=h.reduce((w,_)=>w+(_.totalProtein||0),0);return a+=g,l+=p,c+=m,h.length>0&&(d=!0),`
                            <div class="meal-type">
                                <div class="meal-type-label">${o[f]}</div>
                                ${h.map(w=>`
                                    <div class="planned-meal">
                                        <div class="planned-meal-content">
                                            <input 
                                                type="checkbox" 
                                                class="meal-shopping-checkbox" 
                                                id="shopping-${w.id}-${i}-${u}"
                                                title="Add ingredients to Shopping List"
                                                onchange="console.log(' CHECKBOX EVENT: Checkbox clicked!', this.id, this.checked); handleMealToShoppingList('${w.id}', '${w.name.replace(/'/g,"\\'")}', this.checked)"
                                            />
                                            <span class="planned-meal-name">${w.name}</span>
                                        </div>
                                        <button class="remove-planned-btn" onclick="removeMealFromWeeklyPlan('${w.id}', '${i}', '${u}')"></button>
                                    </div>
                                `).join("")}
                                ${h.length===0?'<div class="empty-meal-slot">No meals planned</div>':""}
                                ${h.length>0?`
                                    <div class="meal-time-totals">
                                        <span class="total-carbs">Carbs: ${G(g)}g</span>
                                        <span class="total-fat">Fat: ${G(p)}g</span>
                                        <span class="total-protein">Protein: ${G(m)}g</span>
                                    </div>
                                `:""}
                            </div>
                        `}).join("")}
                    
                    <div class="daily-totals-column">
                        <div class="daily-totals-label">Daily Total</div>
                        ${d?`
                            <div class="daily-totals-values">
                                <span class="daily-total-carbs">Carbs: ${G(a)}g</span>
                                <span class="daily-total-fat">Fat: ${G(l)}g</span>
                                <span class="daily-total-protein">Protein: ${G(c)}g</span>
                            </div>
                        `:'<div class="empty-meal-slot">No meals</div>'}
                    </div>
                </div>
            </div>
        `}),n.innerHTML=r,jo()}async function jo(){if(Pt){console.log(" Shopping checkbox update already in progress, skipping...");return}try{Pt=!0;const n=await xa();if(!n){console.log(" No shopping list items available, skipping checkbox update");return}const e=await Oa();if(!e){console.log(" No foods available for matching, skipping checkbox update");return}const t=new Set(n.filter(r=>r&&r.food_id).map(r=>r.food_id)),o=new Set(n.filter(r=>r&&typeof r.name=="string").map(r=>r.name.toLowerCase().trim()));if(t.size===0&&o.size===0){console.log("No shopping list items to check against, skipping update");return}if(!P||typeof P!="object"){console.log("Weekly meal plan not initialized, skipping update");return}Object.keys(P).forEach(r=>{P[r]&&Object.keys(P[r]).forEach(i=>{Array.isArray(P[r][i])&&P[r][i].forEach(s=>{if(!s||!s.id)return;const a=`shopping-${s.id}-${r}-${i}`,l=document.getElementById(a);if(!l||!s.ingredients)return;const c=s.ingredients.filter(u=>u&&typeof u=="object"&&u.name&&typeof u.name=="string");let d=!1;for(const u of c){const f=u.name.trim().toLowerCase(),h=Da(f,e);if(h&&t.has(h.id)){d=!0;break}if(o.has(f)){d=!0;break}}l.checked=d})})})}catch(n){console.error("Error updating meal shopping checkboxes:",n)}finally{Pt=!1}}async function xa(){try{const{supabase:n}=await A(async()=>{const{supabase:i}=await Promise.resolve().then(()=>Fs);return{supabase:i}},void 0);if(!n)throw new Error("Supabase client not available");const{data:{user:e},error:t}=await n.auth.getUser();if(t||!e)throw new Error("User must be authenticated");const{data:o,error:r}=await n.from("shopping_list").select("*").eq("user_id",e.id);if(r)throw r;return o||[]}catch(n){return console.error("Error loading shopping list items:",n),[]}}function La(){if(Dt)return;const n=localStorage.getItem("nutrivalor_weekly_meal_plan");if(n)try{const e=JSON.parse(n);Object.keys(P).forEach(t=>delete P[t]),Object.keys(e).forEach(t=>{P[t]={},e[t]&&typeof e[t]=="object"&&Object.keys(e[t]).forEach(o=>{P[t][o]=[],Array.isArray(e[t][o])&&(P[t][o]=e[t][o].filter(r=>r&&typeof r=="object"&&r.id&&r.name&&Array.isArray(r.ingredients)))})}),console.log(" Loaded weekly meal plan from localStorage"),De()}catch(e){console.error("Error loading weekly meal plan:",e),P={}}else P={};Dt=!0}function Fa(){confirm("Are you sure you want to clear all meal plan data? This cannot be undone.")&&(P={},localStorage.removeItem("nutrivalor_weekly_meal_plan"),q={},localStorage.removeItem("nutrivalor_meal_plan"),De(),wt(),W("All meal plan data has been cleared!","success"),console.log(" All meal plan data cleared"))}function Ba(){console.log(" Clearing all meal data for user switch..."),ee=[],P={},q={},Dt=!1,localStorage.removeItem("nutrivalor_meals"),localStorage.removeItem("nutrivalor_weekly_meal_plan"),localStorage.removeItem("nutrivalor_meal_plan"),De(),wt(),console.log(" All meal data cleared for next user")}function Ma(){console.log(" Clearing all meal shopping checkboxes..."),console.log(" Searching for checkboxes with class: .meal-shopping-checkbox");const n=document.querySelectorAll(".meal-shopping-checkbox");console.log(` Found ${n.length} checkboxes total`);let e=0,t=0;n.forEach((o,r)=>{if(o instanceof HTMLInputElement){const i=o.checked;i&&t++,console.log(` Checkbox ${r+1}: ID="${o.id}", checked=${i}`),i&&(o.checked=!1,e++,console.log(` Unchecked checkbox: ${o.id}`))}}),console.log(` Summary: ${e} unchecked out of ${t} that were checked`),e>0?(W(`Cleared ${e} "Add to List" selections`,"success"),console.log(` Successfully unchecked ${e} meal shopping checkboxes`)):t===0?(W("No checkboxes were selected to clear","info"),console.log(" No meal shopping checkboxes were checked")):(W("All checkboxes were already cleared","info"),console.log(" All checkboxes were already unchecked"))}window.addMealToPlan=function(n,e){console.log(` Adding meal ${e} to plan`),nn(n)};window.toggleMealPlanDropdown=function(n){Uo(n)};window.hideMealPlanDropdown=function(n){Rt(n)};window.addMealToWeeklyPlan=function(n,e){Ta(n,e)};window.removeMealFromWeeklyPlan=function(n,e,t){Aa(n,e,t)};window.filterMealsByCategory=function(n){Ro(n)};window.clearAllMealPlanData=function(){Fa()};window.clearMealShoppingCheckboxes=function(){Ma()};window.removeMealFromPlan=function(n,e){const t=new Date().toISOString().split("T")[0];if(q[t]&&q[t][e]){const o=q[t][e].findIndex(r=>r.id===n);o!==-1&&(q[t][e].splice(o,1),localStorage.setItem("nutrivalor_meal_plan",JSON.stringify(q)),wt(),W("Meal removed from plan","success"))}};async function Oa(){try{const{data:n,error:e}=await y.from("foods").select("*").order("name");if(e)throw e;return n||[]}catch(n){return console.error("Error loading foods for matching:",n),[]}}function Da(n,e){if(!e||e.length===0)return null;const t=n.toLowerCase().trim();return e.find(r=>r.name.toLowerCase().trim()===t)||null}function Ra(){const n=localStorage.getItem("lastMealUpdateDate"),e=document.getElementById("lastMealUpdateInfo"),t=document.getElementById("lastMealUpdateDate");n&&e&&t?(t.textContent=n,e.style.display="block"):e&&(e.style.display="none")}function Ua(){const n=document.getElementById("ingredientsContainer");if(!n)return;const e=n.children.length,t=document.createElement("div");t.className="ingredient-row";const o=document.createElement("select");o.className="food-select",o.onchange=()=>window.updateFoodDetails(o,e),o.innerHTML=`
        <option value="">Select a food</option>
        ${F.map(l=>`
            <option value="${l.id}">${l.name}</option>
        `).join("")}
    `;const r=document.createElement("input");r.type="number",r.className="ingredient-quantity",r.value="1",r.min="0",r.step="0.1",r.onchange=()=>window.updateFoodDetails(o,e);const i=document.createElement("select");i.className="serving-unit-select",i.innerHTML='<option value="g">g</option><option value="EACH">each</option>',i.onchange=()=>window.updateFoodDetails(o,e);const s=document.createElement("button");s.type="button",s.className="remove-ingredient-btn",s.innerHTML="&times;",s.onclick=()=>qo(t);const a=document.createElement("div");a.id=`food-details-${e}`,a.className="food-details",a.innerHTML=`
        <div class="food-info">
            <div class="food-name">Select a food</div>
            <div class="food-macros">
                <span>Carbs: 0g</span>
                <span>Fat: 0g</span>
                <span>Protein: 0g</span>
            </div>
        </div>
    `,t.appendChild(o),t.appendChild(r),t.appendChild(i),t.appendChild(s),t.appendChild(a),n.appendChild(t)}function qo(n){const e=document.getElementById("ingredientsContainer");e&&n&&e.removeChild(n)}const No=Object.freeze(Object.defineProperty({__proto__:null,addToMealPlan:nn,get allMeals(){return vt},clearAllMealData:Ba,displayMeals:Ke,filterMealsByCategory:Ro,initializeMeals:Oo,loadUserMeals:tn,reloadMeals:Do},Symbol.toStringTag,{value:"Module"}));let ie=[];async function Ho(){await xe(),window.addEventListener("shoppingListNeedsRefresh",async n=>{var t;console.log(" Received shopping list refresh event from:",(t=n.detail)==null?void 0:t.source);try{await xe(),console.log(" Shopping list refreshed via event listener")}catch(o){console.error(" Error refreshing shopping list via event:",o)}})}async function xe(){const n=await Jt();n&&on(n)}function Wo(n){const e={};return n.forEach(t=>{var a,l;if(!t||!((a=t.food)!=null&&a.name)){console.warn(" Skipping invalid shopping list item:",t);return}const o=(t.food.brand||"Any").toString(),r=(t.food.category||"General").toString(),i=(t.unit||"EACH").toString(),s=`${t.food.name.toString().toLowerCase().trim()}_${o.toLowerCase().trim()}_${r.toLowerCase().trim()}_${i.toLowerCase().trim()}`;if(console.log(` Processing item: ${(l=t.food)==null?void 0:l.name}, Brand: ${o}, Category: ${r}, Unit: ${i}, Key: ${s}`),console.log(` Item quantity RAW: value="${t.quantity}", type="${typeof t.quantity}", parsed=${parseInt(t.quantity)}`),e[s]){const c=e[s].quantity,d=parseInt(t.quantity)||1;e[s].quantity=(parseInt(c)||1)+d,console.log(` Consolidated ${t.name}: ${c} + ${d} = ${e[s].quantity} total quantity`)}else{const c=parseInt(t.quantity)||1;e[s]={...t,quantity:c},console.log(` Added new item: ${t.name} with quantity ${c} (original: ${t.quantity}, type: ${typeof t.quantity})`)}}),console.log(` Consolidation complete: ${Object.keys(e).length} unique items`),Object.values(e)}function on(n){const e=document.getElementById("shoppingItems"),t=document.getElementById("shoppingTotals");if(!e)return;if(t&&(t.style.display="none",t.innerHTML=""),!n||n.length===0){e.innerHTML='<p class="empty-state">Your shopping list is empty. Add items from the Food Tracker!</p>',t&&(t.style.display="none");return}const o=Wo(n),r=o.reduce((a,l)=>{var d,u;const c=((d=l.food)==null?void 0:d.category)||((u=l.food)==null?void 0:u.brand)||"General";return a[c]||(a[c]=[]),a[c].push(l),a},{}),i=Object.keys(r).sort((a,l)=>a==="SUNDRIES"?1:l==="SUNDRIES"?-1:a.localeCompare(l));e.innerHTML=i.map(a=>{const l=r[a],c=a==="SUNDRIES";return`
      <div class="shopping-category">
        <h3 class="category-header ${c?"sundries-header":""}">${a}${c?" (From Meal Plans)":""}</h3>
        <div class="category-items">
          ${l.map(d=>{var u,f,h,g,p,m;return`
            <div class="shopping-item" data-id="${d.id}">
              <div class="item-info">
                <h4>${((u=d.food)==null?void 0:u.name)||"Unknown Food"}</h4>
                ${(f=d.food)!=null&&f.brand&&d.food.brand!=="SUNDRIES"?`<div class="brand-info">Brand: ${d.food.brand}</div>`:""}
                <div class="nutrition-info">
                  <span>Carbs: ${Te((h=d.food)==null?void 0:h.carbs)}g</span>
                  <span>Fat: ${Te((g=d.food)==null?void 0:g.fat)}g</span>
                  <span>Protein: ${Te((p=d.food)==null?void 0:p.protein)}g</span>
                </div>
                ${c?"":`<div class="category-info">${((m=d.food)==null?void 0:m.category)||"General"}</div>`}
              </div>
              <div class="item-controls">
                <div class="quantity-controls">
                  <button onclick="updateItemQuantity('${d.id}', ${d.quantity-1})" class="qty-btn" ${d.quantity<=1?"disabled":""}>-</button>
                  <span class="quantity">${d.quantity}</span>
                  <button onclick="updateItemQuantity('${d.id}', ${d.quantity+1})" class="qty-btn">+</button>
                  <span class="unit-label">${d.unit||"EACH"}</span>
                </div>
                <button onclick="removeShoppingItem('${d.id}')" class="remove-btn">Remove</button>
              </div>
            </div>
          `}).join("")}
        </div>
      </div>
    `}).join("");const s=zo(o);if(t)if(t.style.display="block",s.totalItems>0){const a=`
        <div class="totals-header">
          <h3>Shopping List Totals</h3>
        </div>
        <div class="totals-grid">
          <div class="total-item">
            <span class="label">Total Carbs:</span>
            <span class="value">${s.totalCarbs.toFixed(1)}g</span>
          </div>
          <div class="total-item">
            <span class="label">Total Fat:</span>
            <span class="value">${s.totalFat.toFixed(1)}g</span>
          </div>
          <div class="total-item">
            <span class="label">Total Protein:</span>
            <span class="value">${s.totalProtein.toFixed(1)}g</span>
          </div>
        </div>
      `;t.innerHTML=a}else{const a=`
        <div class="totals-header">
          <h3>Shopping List Totals</h3>
        </div>
        <div class="totals-grid">
          <div class="total-item">
            <span class="label">Total Carbs:</span>
            <span class="value">0.0g</span>
          </div>
          <div class="total-item">
            <span class="label">Total Fat:</span>
            <span class="value">0.0g</span>
          </div>
          <div class="total-item">
            <span class="label">Total Protein:</span>
            <span class="value">0.0g</span>
          </div>
        </div>
      `;t.innerHTML=a}}function zo(n){const e={totalItems:n.reduce((t,o)=>t+(o.quantity||0),0),totalCarbs:0,totalFat:0,totalProtein:0};return n.forEach(t=>{if(t.food){const o=t.quantity||0;e.totalCarbs+=(parseFloat(t.food.carbs)||0)*o,e.totalFat+=(parseFloat(t.food.fat)||0)*o,e.totalProtein+=(parseFloat(t.food.protein)||0)*o}}),e}function Te(n){if(n==null||n==="")return"0";const e=parseFloat(n);return isNaN(e)?"0":e.toFixed(1)}async function rn(n){try{await yo(n),await xe();try{typeof window.refreshMealShoppingCheckboxes=="function"&&(await window.refreshMealShoppingCheckboxes(),console.log(" Meal plan checkboxes refreshed after item removal"))}catch(e){console.warn(" Could not refresh meal plan checkboxes:",e)}se("Item removed from shopping list","success")}catch(e){console.error("Error removing item:",e),se("Error removing item","error")}}async function Go(n,e){if(e<1){await rn(n);return}try{await vo(n,e),await xe()}catch(t){console.error("Error updating quantity:",t),se("Error updating quantity","error")}}async function sn(n=!1){console.log(" SHOPPING-LIST: Starting shopping list clear...");try{if(n)console.log(" Database clear skipped (already done by food-tracker)");else{const{clearShoppingListFromDatabase:e}=await A(async()=>{const{clearShoppingListFromDatabase:t}=await Promise.resolve().then(()=>Ee);return{clearShoppingListFromDatabase:t}},void 0);await e(),console.log(" Database cleared successfully")}ie=[],console.log(" Local shopping list array cleared"),on([]),console.log(" Display updated");try{typeof window.refreshMealShoppingCheckboxes=="function"&&(await window.refreshMealShoppingCheckboxes(),console.log(" Meal plan checkboxes refreshed after clearing list"))}catch(e){console.warn(" Could not refresh meal plan checkboxes:",e)}n||se("Shopping list cleared","success")}catch(e){console.error(" Error clearing shopping list:",e),n||se("Error clearing shopping list","error")}}function ja(n){return ie.some(e=>e.food_id===n)}function Vo(){return ie}function se(n,e="success"){let t=document.getElementById("shopping-message");if(!t){t=document.createElement("div"),t.id="shopping-message",t.className="message";const o=document.getElementById("shopping-list")||document.body;o.insertBefore(t,o.firstChild)}t.textContent=n,t.className=`message ${e}`,t.style.display="block",setTimeout(()=>{t&&(t.style.display="none")},3e3)}window.removeShoppingItem=rn;window.updateItemQuantity=Go;window.loadAndDisplayShoppingList=xe;window.printShoppingList=Jo;window.clearAllShoppingItems=sn;window.getCurrentShoppingList=Vo;function Jo(){if(console.log(" Printing shopping list..."),!ie||ie.length===0){se("Shopping list is empty - nothing to print!","error");return}const n=window.open("","_blank");if(!n){se("Unable to open print window. Please check your browser settings.","error");return}const e=qa();n.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>NutriValor Shopping List</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        .category { margin-bottom: 20px; }
        .category h2 { color: #666; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        .item { margin: 8px 0; padding: 8px 0; border-bottom: 1px dotted #ddd; display: flex; align-items: flex-start; }
        .checkbox { font-size: 24px; font-weight: bold; margin-right: 12px; line-height: 1; color: #333; }
        .item-content { flex: 1; }
        .item-name { font-weight: bold; margin-bottom: 4px; }
        .item-details { font-size: 0.9em; color: #666; }
        .totals { margin-top: 30px; padding: 15px; background: #f5f5f5; border-radius: 5px; }
        @media print { body { margin: 0; } }
      </style>
    </head>
    <body>
      ${e}
    </body>
    </html>
  `),n.document.close(),n.focus(),n.print(),se("Shopping list opened for printing!","success")}function qa(){const n=Wo(ie),e=zo(n),t=new Date().toLocaleDateString(),o=n.reduce((s,a)=>{const l=a.category||a.brand||"General";return s[l]||(s[l]=[]),s[l].push(a),s},{}),r=Object.keys(o).sort((s,a)=>s==="SUNDRIES"?1:a==="SUNDRIES"?-1:s.localeCompare(a));let i=`
    <h1>NutriValor Shopping List</h1>
    <p><strong>Generated:</strong> ${t}</p>
    <p><strong>Total Items:</strong> ${e.totalItems}</p>
  `;return r.forEach(s=>{const a=o[s];i+=`
      <div class="category">
        <h2>${s}${s==="SUNDRIES"?" (From Meal Plans)":""}</h2>
    `,a.forEach(c=>{const d=c.unit?c.quantity>1&&c.unit.toUpperCase()==="SLICE"?"SLICES":c.unit:"";i+=`
        <div class="item">
          <div class="checkbox"></div>
          <div class="item-content">
            <div class="item-name">${c.name} (Qty: ${c.quantity} ${d})</div>
            <div class="item-details">
              Carbs: ${Te(c.carbs)}g | 
              Fat: ${Te(c.fat)}g | 
              Protein: ${Te(c.protein)}g
              ${c.brand&&c.brand!=="SUNDRIES"?` | Brand: ${c.brand}`:""}
            </div>
          </div>
        </div>
      `}),i+="</div>"}),i+=`
    <div class="totals">
      <h2>Totals</h2>
      <p><strong>Total Carbs:</strong> ${e.totalCarbs.toFixed(1)}g</p>
      <p><strong>Total Fat:</strong> ${e.totalFat.toFixed(1)}g</p>
      <p><strong>Total Protein:</strong> ${e.totalProtein.toFixed(1)}g</p>
    </div>
  `,i}function Na(){if(console.log(" Clear shopping list requested..."),!ie||ie.length===0){se("Shopping list is already empty!","info");return}confirm(`Are you sure you want to clear all ${ie.length} items from your shopping list? This cannot be undone.`)?sn():console.log(" Clear shopping list cancelled by user")}const Ha=Object.freeze(Object.defineProperty({__proto__:null,clearAllShoppingItems:sn,displayShoppingList:on,getCurrentShoppingList:Vo,handleClearShoppingList:Na,initializeShoppingList:Ho,isInShoppingList:ja,loadAndDisplayShoppingList:xe,printShoppingList:Jo,removeShoppingItem:rn,updateItemQuantity:Go},Symbol.toStringTag,{value:"Module"}));let J=null,Z=null,T=[],st=null,ve=null,we=[];async function Wa(){console.log(" openEditFoodModal called!");const n=document.getElementById("editFoodModal");if(console.log(" Modal element found:",!!n),!n){console.error(" Modal element not found!");return}console.log(" Loading foods dropdown..."),await za();const e=document.getElementById("editFoodForm");console.log(" Form element found:",!!e),e&&(e.style.display="none",e.reset(),e.onsubmit=Zo),console.log(" Setting modal display..."),n.style.cssText=`
        display: block;
        opacity: 1;
        visibility: visible;
        background-color: rgba(0, 0, 0, 0.7);
    `,n.classList.add("visible"),console.log(" Modal should now be visible")}function an(){const n=document.getElementById("editFoodModal");n&&(n.style.display="none"),J=null}async function za(){try{const{data:n,error:e}=await y.from("foods").select("*").order("name");if(e)throw e;const t=document.getElementById("editFoodSelect");if(!t)return;t.innerHTML='<option value="">Choose a food...</option>',n&&n.forEach(o=>{const r=document.createElement("option");r.value=o.id,r.textContent=`${o.name}${o.brand?` (${o.brand})`:""}`,t.appendChild(r)})}catch(n){console.error("Error loading foods:",n),I("Error loading foods","error")}}async function Ga(n){var t,o,r;const e=document.getElementById("editFoodForm");if(e){if(!n){e.style.display="none";return}try{const[i,s]=await Promise.all([y.from("foods").select("*").eq("id",n).single(),y.from("serving_units").select("*").eq("food_id",n)]);if(i.error)throw i.error;if(s.error)throw s.error;const a=i.data;if(!a){I("Food not found","error");return}J=a,st=null,we=s.data||[],document.getElementById("editFoodId").value=a.id,document.getElementById("editFoodName").value=a.name||"",document.getElementById("editFoodBrand").value=a.brand||"",document.getElementById("editFoodCategory").value=a.category||"",document.getElementById("editFoodCarbs").value=((t=a.carbs)==null?void 0:t.toString())||"0",document.getElementById("editFoodFat").value=((o=a.fat)==null?void 0:o.toString())||"0",document.getElementById("editFoodProtein").value=((r=a.protein)==null?void 0:r.toString())||"0",document.getElementById("editFoodInstructions").value=a.instructions||"";const l=document.getElementById("servingUnitsList");l&&(l.innerHTML=we.map(h=>Ko(h.id,h.unit_name,h.grams_per_unit,h.is_default)).join(""));const c=document.getElementById("editFoodImagePreview"),d=document.getElementById("editFoodImagePlaceholder"),u=document.getElementById("editFoodImage");u&&(u.value="");const f=a.image_url||a.image||a.picture||null;f&&f.trim()!==""?(c.src=f,c.style.display="block",d.style.display="none"):(c.style.display="none",d.style.display="flex"),e.style.display="block"}catch(i){console.error("Error loading food:",i),I("Error loading food","error")}}}function Ko(n,e="",t=0,o=!1){return`
        <div class="serving-unit-item" data-unit-id="${n}">
            <select class="unit-name" 
                    name="unit_name"
                    onchange="updateServingUnitField('${n}', 'name', this.value); toggleGramsInput('${n}', this.value)">
                <option value="">Select unit type</option>
                <option value="GRAMS" ${e==="GRAMS"?"selected":""}>GRAMS</option>
                <option value="EACH" ${e==="EACH"?"selected":""}>EACH</option>
                <option value="SLICE" ${e==="SLICE"?"selected":""}>SLICE</option>
            </select>
            <input type="number" 
                   class="grams-per-unit" 
                   name="grams_per_unit"
                   value="${t}" 
                   min="0" 
                   step="0.1" 
                   placeholder="Grams per unit"
                   ${e==="EACH"?"disabled":""}
                   onchange="updateServingUnitField('${n}', 'grams', this.value)">
            <div class="unit-actions">
                <label>
                    <input type="checkbox" 
                           class="default-unit-checkbox"
                           name="is_default" 
                           ${o?"checked":""}
                           onchange="updateServingUnitField('${n}', 'default', this.checked)">
                    Default
                </label>
                <button type="button" class="remove-unit-btn" onclick="removeServingUnit('${n}')">&times;</button>
            </div>
        </div>
    `}function Qo(n,e,t){const o=we.find(r=>r.id===n);if(o)e==="name"?(o.unit_name=t,o.grams_per_unit=An(t)):e==="grams"?o.grams_per_unit=t:e==="default"&&(t===!0&&we.forEach(r=>{r.id!==n&&(r.is_default=!1)}),o.is_default=t);else{const r=e==="name"?An(t):e==="grams"?t:0;we.push({id:n,unit_name:e==="name"?t:"",grams_per_unit:r,is_default:e==="default"?t:!1})}}function An(n){switch(n){case"GRAMS":return 1;case"EACH":return null;case"SLICE":return null;default:return null}}function Xo(n,e){const t=document.querySelector(`.serving-unit-item[data-unit-id="${n}"]`);if(!t)return;const o=t.querySelector(".grams-per-unit");o&&(e==="EACH"?(o.disabled=!0,o.value=""):(o.disabled=!1,o.value=""))}function Yo(n){const e=document.querySelector(`.serving-unit-item[data-unit-id="${n}"]`);e&&(e.remove(),we=we.filter(t=>t.id!==n))}async function Zo(n){var e,t,o,r,i;if(n.preventDefault(),!J){I("No food selected","error");return}try{const s=n.target,a=new FormData(s),l={name:a.get("name"),brand:a.get("brand"),carbs:parseFloat(a.get("carbs"))||0,fat:parseFloat(a.get("fat"))||0,protein:parseFloat(a.get("protein"))||0,instructions:a.get("instructions"),category:a.get("category")},{error:c}=await y.from("foods").update(l).eq("id",J.id);if(c)throw c;const d=Array.from(document.querySelectorAll(".serving-unit-item")).map(p=>p.getAttribute("data-unit-id")).filter(p=>p!==null&&/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(p));if(d.length>0){const{error:p}=await y.from("serving_units").delete().eq("food_id",J.id).not("id","in",`(${d.join(",")})`);if(p)throw p}const u=document.querySelectorAll(".serving-unit-item[data-unit-id]");for(const p of u){const m={id:p.getAttribute("data-unit-id"),unit_name:((e=p.querySelector('select[name="unit_name"]'))==null?void 0:e.value)||((t=p.querySelector('input[name="unit_name"]'))==null?void 0:t.value),grams_per_unit:((o=p.querySelector('select[name="unit_name"]'))==null?void 0:o.value)==="EACH"?null:parseFloat(((r=p.querySelector('input[name="grams_per_unit"]'))==null?void 0:r.value)||"0"),is_default:(i=p.querySelector('input[name="is_default"]'))==null?void 0:i.checked},{error:w}=await y.from("serving_units").update({unit_name:m.unit_name,grams_per_unit:m.grams_per_unit,is_default:m.is_default}).eq("id",m.id);if(w)throw w}const f=Array.from(document.querySelectorAll(".serving-unit-item:not([data-unit-id])")).map(p=>{var m,w,_,v,b;return{food_id:J.id,unit_name:((m=p.querySelector('select[name="unit_name"]'))==null?void 0:m.value)||((w=p.querySelector('input[name="unit_name"]'))==null?void 0:w.value),grams_per_unit:((_=p.querySelector('select[name="unit_name"]'))==null?void 0:_.value)==="EACH"?null:parseFloat(((v=p.querySelector('input[name="grams_per_unit"]'))==null?void 0:v.value)||"0"),is_default:(b=p.querySelector('input[name="is_default"]'))==null?void 0:b.checked}});if(f.length>0){const{error:p}=await y.from("serving_units").insert(f);if(p)throw p}I("Food updated successfully","success"),an();const{data:h,error:g}=await y.from("foods").select("*").order("name");if(g)throw g;h&&Me(h)}catch(s){console.error("Error saving food:",s),I("Error saving food","error")}}async function Va(){if(!J){I("No food selected","error");return}if(confirm(`Are you sure you want to delete "${J.name}"? This cannot be undone.`))try{const{error:e}=await y.from("foods").delete().eq("id",J.id);if(e)throw e;I("Food deleted successfully!","success"),an(),await fe()}catch(e){console.error("Error deleting food:",e),I("Error deleting food","error")}}async function Ja(){console.log(" openEditMealModal called!");const n=document.getElementById("editMealModal");if(console.log(" Meal modal element found:",!!n),!n){console.error(" Meal modal element not found!");return}try{const{data:t,error:o}=await y.from("foods").select("*").order("name");if(o)throw o;F.length=0,F.push(...t||[]),console.log(" Loaded foods:",(t==null?void 0:t.length)||0)}catch(t){console.error("Error loading foods:",t),I("Error loading foods","error")}console.log(" Loading meals dropdown..."),await er();const e=document.getElementById("editMealForm");console.log(" Meal form element found:",!!e),e&&(e.style.display="none",e.reset()),console.log(" Setting meal modal display..."),n.style.cssText=`
        display: block;
        opacity: 1;
        visibility: visible;
        background-color: rgba(0, 0, 0, 0.7);
    `,console.log(" Meal modal should now be visible")}function ln(){const n=document.getElementById("editMealModal");n&&(n.style.display="none",n.classList.remove("visible")),Z=null,T=[]}async function er(){try{const{data:n,error:e}=await y.from("meals").select("*").order("name");if(e)throw e;const t=document.getElementById("editMealSelect");if(!t)return;t.innerHTML='<option value="">Choose a meal...</option>',n&&n.forEach(o=>{const r=document.createElement("option");r.value=o.id,r.textContent=`${o.name} (${o.meal_type||"Unknown"})`,t.appendChild(r)})}catch(n){console.error("Error loading meals:",n),I("Error loading meals","error")}}async function tr(n){if(console.log(" loadMealForEdit called with mealId:",n),!n){console.log(" No mealId provided, hiding form");const e=document.getElementById("editMealForm");e&&(e.style.display="none");return}try{const{data:e,error:t}=await y.from("meals").select("*").eq("id",n).single();if(t)throw t;if(!e)throw new Error("Meal not found");Z=e;let o;typeof e.ingredients=="string"?o=JSON.parse(e.ingredients||"[]"):o=e.ingredients||[];const{data:r,error:i}=await y.from("foods").select("*");if(i)throw i;const{data:s,error:a}=await y.from("serving_units").select("*");if(a)throw a;T=await Promise.all(o.map(async f=>{const h=r.find(k=>k.id===f.food_id);if(!h)return f;const g=s.filter(k=>k.food_id===h.id);let p;g.length>0&&(p=g.find(k=>k.unit_name.toLowerCase()===(f.serving_unit||"").toLowerCase()),p||(p=g.find(k=>k.unit_name.toUpperCase()==="EACH")),p||(p=g.find(k=>k.is_default)||g[0])),p||(p={unit_name:"g",grams_per_unit:1,is_default:!0});const m=f.quantity||1,w=p.unit_name.toLowerCase();let _,v,b;if(w==="each")_=Math.round(h.carbs*m*10)/10,v=Math.round(h.fat*m*10)/10,b=Math.round(h.protein*m*10)/10,console.log("[NutrientCalc] EACH unit calculation:",{baseValues:{carbs:h.carbs,fat:h.fat,protein:h.protein},quantity:m,result:{carbs:_,fat:v,protein:b}});else{const k=p.grams_per_unit*m,$=k/100;_=Math.round(h.carbs*$*10)/10,v=Math.round(h.fat*$*10)/10,b=Math.round(h.protein*$*10)/10,console.log("[NutrientCalc] Weight-based calculation:",{baseValues:{carbs:h.carbs,fat:h.fat,protein:h.protein},totalGrams:k,factor:$,result:{carbs:_,fat:v,protein:b}})}return{...f,food_id:h.id,food_name:h.name,serving_unit:p.unit_name,serving_units:g||[],carbs:_,fat:v,protein:b,quantity:m}}));const l=document.getElementById("editMealForm");l?(l.style.display="block",console.log(" Form displayed successfully")):console.error(" Form element not found!");const c=document.getElementById("editMealName"),d=document.getElementById("editMealType"),u=document.getElementById("editMealInstructions");c&&(c.value=e.name||""),d&&(d.value=e.meal_type||""),u&&(u.value=e.cooking_instructions||""),await Re(),console.log(" Meal loaded successfully:",e.name)}catch(e){console.error(" Error loading meal for edit:",e),I("Error loading meal","error")}}async function Re(){const n=document.getElementById("editMealIngredients");if(n){n.innerHTML="";try{T.forEach((e,t)=>{var u,f;const o=document.createElement("div");o.className="ingredient-edit-row";let r=`<select class="food-select" onchange="updateIngredientFood(${t}, this.value)"><option value="">Select a food...</option>`;const i=F.reduce((h,g)=>{const p=g.category||"Other";return h[p]||(h[p]=[]),h[p].push(g),h},{});for(const h in i)r+=`<optgroup label="${h}">`,r+=i[h].map(g=>`<option value="${g.id}" ${e.food_id===g.id?"selected":""}>${g.name}</option>`).join(""),r+="</optgroup>";r+="</select>";let s=`<select class="unit-select" onchange="updateIngredientUnit(${t}, this.value)" ${(u=e.serving_units)!=null&&u.length?"":"disabled"}>`;(f=e.serving_units)!=null&&f.length?s+=e.serving_units.map(h=>`<option value="${h.unit_name}" ${e.serving_unit===h.unit_name?"selected":""}>${h.unit_name}</option>`).join(""):s+="<option>g</option>",s+="</select>";const a=`<input type="number" class="quantity-input" value="${e.quantity||1}" onchange="updateIngredientQuantity(${t}, this.value)" min="0">`;let l=e.carbs||0,c=e.fat||0,d=e.protein||0;o.innerHTML=`
                <div class="ingredient-main-controls">
                    ${r}
                    <div class="ingredient-quant-controls">
                        ${a}
                        ${s}
                    </div>
                    <button class="remove-ingredient-btn" onclick="removeIngredientFromMeal(${t})">&times;</button>
                </div>
                <div class="ingredient-details">
                    <div class="nutrient-tags">
                        <span class="nutrient-tag carbs">${l.toFixed(1)}g C</span>
                        <span class="nutrient-tag fat">${c.toFixed(1)}g F</span>
                        <span class="nutrient-tag protein">${d.toFixed(1)}g P</span>
                    </div>
                </div>
            `,n.appendChild(o)})}catch(e){console.error("Error rendering ingredients:",e),I("Error rendering ingredients","error")}}}async function Ka(){try{if(F.length===0){const{data:e,error:t}=await y.from("foods").select("*").order("name");if(t)throw t;F.push(...e||[]),console.log(" Loaded foods for new ingredient:",(e==null?void 0:e.length)||0)}const n={food_id:"",food_name:"",quantity:1,carbs:0,fat:0,protein:0,instructions:""};T.push(n),await Re()}catch(n){console.error("Error adding ingredient:",n),I("Error adding ingredient","error")}}function nr(n){T.splice(n,1),Re()}async function or(n,e){if(T[n])try{const t=F.find(d=>d.id===e);if(!t){console.warn(`Food not found: ${e}`);return}const{data:o}=await y.from("serving_units").select("*").eq("food_id",e);let r;o&&o.length>0?(r=o.find(d=>d.unit_name.toUpperCase()==="EACH"),r||(r=o.find(d=>d.is_default)||o[0])):r={unit_name:"g",grams_per_unit:1,is_default:!0};const i=T[n].quantity||1,s=r.unit_name.toLowerCase();let a,l,c;if(s==="each")a=Math.round(t.carbs*i*10)/10,l=Math.round(t.fat*i*10)/10,c=Math.round(t.protein*i*10)/10,console.log(`[NutrientCalc] EACH unit calculation for ${t.name}:`,{baseValues:{carbs:t.carbs,fat:t.fat,protein:t.protein},quantity:i,result:{carbs:a,fat:l,protein:c}});else{const d=r.grams_per_unit*i,u=d/100;a=Math.round(t.carbs*u*10)/10,l=Math.round(t.fat*u*10)/10,c=Math.round(t.protein*u*10)/10,console.log(`[NutrientCalc] Weight-based calculation for ${t.name}:`,{baseValues:{carbs:t.carbs,fat:t.fat,protein:t.protein},totalGrams:d,factor:u,result:{carbs:a,fat:l,protein:c}})}T[n]={...T[n],food_id:t.id,food_name:t.name,serving_unit:r.unit_name,serving_units:o||[],carbs:a,fat:l,protein:c,quantity:i},console.log(" Updated ingredient:",T[n]),await _e()}catch(t){console.error("Error updating ingredient food:",t),I("Error updating food","error")}}async function rr(n,e){if(T[n])try{const t=T[n];t.quantity=parseFloat(e)||0;const o=F.find(c=>c.id===t.food_id);if(!o||!t.serving_units||t.serving_units.length===0){await _e();return}const r=t.serving_units.find(c=>c.unit_name===t.serving_unit);if(!r){console.warn(`Unit ${t.serving_unit} not found for recalculation`),await _e();return}console.group(`[Debug] Nutrient Calculation for: ${o.name}`),console.log(`Input Quantity: ${t.quantity}`),console.log(`Selected Unit: '${r.unit_name}' (Grams per unit: ${r.grams_per_unit})`),console.log(`Base Nutrients (per 100g): C=${o.carbs}, F=${o.fat}, P=${o.protein}`);const i=(r.unit_name||"").toLowerCase();let s,a,l;if(i==="each")s=Math.round(o.carbs*t.quantity*10)/10,a=Math.round(o.fat*t.quantity*10)/10,l=Math.round(o.protein*t.quantity*10)/10,console.log(`[NutrientCalc] EACH unit calculation for ${o.name}:`,{baseValues:{carbs:o.carbs,fat:o.fat,protein:o.protein},quantity:t.quantity,result:{carbs:s,fat:a,protein:l}});else{const c=r.grams_per_unit*t.quantity,d=c/100;s=Math.round(o.carbs*d*10)/10,a=Math.round(o.fat*d*10)/10,l=Math.round(o.protein*d*10)/10,console.log(`[NutrientCalc] Weight-based calculation for ${o.name}:`,{baseValues:{carbs:o.carbs,fat:o.fat,protein:o.protein},totalGrams:c,factor:d,result:{carbs:s,fat:a,protein:l}})}t.carbs=s,t.fat=a,t.protein=l,console.log(`Result -> Final Nutrients: C=${t.carbs}, F=${t.fat}, P=${t.protein}`),console.groupEnd(),await _e()}catch(t){console.error("Error updating ingredient quantity:",t),I("Error updating ingredient","error")}}async function ir(n,e){if(T[n])try{const t=T[n],o=F.find(c=>c.id===t.food_id);if(!o||!t.serving_units||t.serving_units.length===0){await _e();return}const r=t.serving_units.find(c=>c.unit_name===e);if(!r){console.warn(`Unit ${e} not found for recalculation`),await _e();return}t.serving_unit=e;const i=e.toLowerCase();console.log(`[NutrientCalc] Ingredient: ${o.name}, Unit: '${e}', Quantity: ${t.quantity}`);let s,a,l;if(i==="each")s=Math.round(o.carbs*t.quantity*10)/10,a=Math.round(o.fat*t.quantity*10)/10,l=Math.round(o.protein*t.quantity*10)/10,console.log("[NutrientCalc] EACH unit calculation:",{baseValues:{carbs:o.carbs,fat:o.fat,protein:o.protein},quantity:t.quantity,result:{carbs:s,fat:a,protein:l}});else{const c=r.grams_per_unit*t.quantity,d=c/100;s=Math.round(o.carbs*d*10)/10,a=Math.round(o.fat*d*10)/10,l=Math.round(o.protein*d*10)/10,console.log("[NutrientCalc] Weight-based calculation:",{baseValues:{carbs:o.carbs,fat:o.fat,protein:o.protein},totalGrams:c,factor:d,result:{carbs:s,fat:a,protein:l}})}t.carbs=s,t.fat=a,t.protein=l,console.log(`Result -> Final Nutrients: C=${t.carbs}, F=${t.fat}, P=${t.protein}`),await _e()}catch(t){console.error("Error updating ingredient unit:",t),I("Error updating unit","error")}}function sr(n,e,t){T[n]&&(T[n][e]=parseFloat(t)||0)}function ar(n,e){T[n]&&(T[n].instructions=e)}async function Qa(n){if(console.log(" saveEditedMeal called!",{event:n}),n.preventDefault(),!Z){console.error(" No meal selected for editing"),I("No meal selected","error");return}if(!T||T.length===0){console.error(" No ingredients to save"),I("Cannot save meal without ingredients","error");return}console.log(" Current meal data:",{currentEditingMeal:Z,currentMealIngredients:T,currentMealImageFile:ve});try{let e=Z.image_url,t=Z.picture;if(ve){console.log(" Uploading new image:",ve);const h=ve.name.split(".").pop(),g=`meal_${Z.id}_${Date.now()}.${h}`,{error:p}=await y.storage.from("meal-images").upload(g,ve);if(p)throw p;const{data:{publicUrl:m}}=y.storage.from("meal-images").getPublicUrl(g);e=m,t=g,console.log(" Image uploaded:",{imageUrl:e,picture:t})}const o=document.getElementById("editMealName").value,r=document.getElementById("editMealType").value,i=document.getElementById("editMealInstructions").value;console.log(" Form values:",{name:o,mealType:r,instructions:i});let s=0,a=0,l=0;const{data:c,error:d}=await y.from("serving_units").select("*");if(d)throw d;console.log(" Loaded serving units:",(c==null?void 0:c.length)||0);const u=await Promise.all(T.map(async h=>{const{data:g}=await y.from("foods").select("*").eq("id",h.food_id).single();if(!g)return console.warn(` Food not found for ingredient: ${h.food_name}`),h;let p=c==null?void 0:c.find(v=>v.food_id===g.id&&(v.unit_name.toLowerCase()===(h.serving_unit||"").toLowerCase()||v.is_default));p||(console.log(` Using default serving unit for ${g.name}`),p={unit_name:"g",grams_per_unit:1,is_default:!0});let m,w,_;if(p.unit_name.toUpperCase()==="EACH")m=Math.round(g.carbs*h.quantity*100)/100,w=Math.round(g.fat*h.quantity*100)/100,_=Math.round(g.protein*h.quantity*100)/100,console.log(` Calculating macros for ${g.name} (EACH):`,{quantity:h.quantity,carbs:m,fat:w,protein:_});else{const v=p.grams_per_unit*h.quantity,b=v/100;console.log(` Calculating macros for ${g.name} (weight-based):`,{quantity:h.quantity,servingUnit:p.unit_name,gramsPerUnit:p.grams_per_unit,totalGrams:v,factor:b}),m=Math.round(g.carbs*b*100)/100,w=Math.round(g.fat*b*100)/100,_=Math.round(g.protein*b*100)/100}return s+=m,a+=w,l+=_,{food_id:g.id,food_name:g.name,quantity:h.quantity,serving_unit:p.unit_name,instructions:h.instructions||"",carbs:m,fat:w,protein:_}}));console.log(" Saving meal with ingredients:",u),console.log(" Calculated totals:",{totalCarbs:s,totalFat:a,totalProtein:l});const{error:f}=await y.from("meals").update({name:o,meal_type:r,cooking_instructions:i||null,ingredients:JSON.stringify(u),total_carbs:Math.round(s*100)/100,total_fat:Math.round(a*100)/100,total_protein:Math.round(l*100)/100,image_url:e,picture:t,updated_at:new Date().toISOString()}).eq("id",Z.id);if(f)throw f;console.log(" Meal saved successfully!"),I("Meal saved successfully!","success"),ln(),await er(),await Ke(vt)}catch(e){console.error(" Error saving meal:",e),I("Error saving meal","error")}}async function Xa(){if(!Z){I("No meal selected","error");return}if(confirm(`Are you sure you want to delete "${Z.name}"? This cannot be undone.`))try{const{error:e}=await y.from("meals").delete().eq("id",Z.id);if(e)throw e;I("Meal deleted successfully!","success"),ln(),await Ke(vt)}catch(e){console.error("Error deleting meal:",e),I("Error deleting meal","error")}}function Ya(n){if(n.files&&n.files[0]){st=n.files[0];const e=new FileReader;e.onload=function(t){var i;const o=document.getElementById("editFoodImagePreview"),r=document.getElementById("editFoodImagePlaceholder");(i=t.target)!=null&&i.result&&(o.src=t.target.result,o.style.display="block",r.style.display="none")},e.readAsDataURL(st)}}function Za(){st=null;const n=document.getElementById("editFoodImagePreview"),e=document.getElementById("editFoodImagePlaceholder"),t=document.getElementById("editFoodImage");n.style.display="none",e.style.display="flex",t.value="",J&&(J.image_url=null,J.image=null,J.picture=null),console.log("Food image marked for removal")}function el(n){var i;const e=(i=n.files)==null?void 0:i[0];if(!e)return;const t=new FileReader,o=document.getElementById("editMealImagePreview"),r=document.getElementById("editMealImagePlaceholder");t.onload=s=>{var a;(a=s.target)!=null&&a.result&&o&&r&&(o.src=s.target.result,o.style.display="block",r.style.display="none",ve=e)},t.readAsDataURL(e)}function tl(){const n=document.getElementById("editMealImagePreview"),e=document.getElementById("editMealImagePlaceholder"),t=document.getElementById("editMealImage");n&&e&&t&&(n.src="",n.style.display="none",e.style.display="flex",t.value="",ve=null)}function lr(){const n=document.getElementById("servingUnitsList");if(!n)return;const e=Date.now().toString(),t=Ko(e);n.insertAdjacentHTML("beforeend",t)}function cr(n){const e=n.closest(".ingredient-row");if(!e)return;const t=document.getElementById("editMealIngredients");if(!t)return;const r=Array.from(t.querySelectorAll(".ingredient-row")).indexOf(e);r!==-1&&(T.splice(r,1),Re())}async function dr(){try{if(F.length===0){const{data:e,error:t}=await y.from("foods").select("*").order("name");if(t)throw t;F.push(...e||[]),console.log(" Loaded foods for new ingredient:",(e==null?void 0:e.length)||0)}const n={food_id:"",food_name:"",quantity:1,carbs:0,fat:0,protein:0,instructions:""};T.push(n),await Re()}catch(n){console.error("Error adding ingredient:",n),I("Error adding ingredient","error")}}async function nl(){const n=document.getElementById("ingredientsList");if(n){n.innerHTML="";try{T.forEach((e,t)=>{var p,m;const o=document.createElement("div");o.className="ingredient-edit-row";let r=`<select class="food-select" onchange="updateIngredientFood(${t}, this.value)"><option value="">Select a food...</option>`;const i=F.reduce((w,_)=>{const v=_.category||"Other";return w[v]||(w[v]=[]),w[v].push(_),w},{});for(const w in i)r+=`<optgroup label="${w}">`,r+=i[w].map(_=>`<option value="${_.id}" ${e.food_id===_.id?"selected":""}>${_.name}</option>`).join(""),r+="</optgroup>";r+="</select>";let s='<select class="unit-select" onchange="updateIngredientUnit('+t+', this.value)" '+((p=e.serving_units)!=null&&p.length?"":"disabled")+">";(m=e.serving_units)!=null&&m.length?s+=e.serving_units.map(w=>`<option value="${w.unit_name}" ${e.serving_unit===w.unit_name?"selected":""}>${w.unit_name}</option>`).join(""):s+="<option>g</option>",s+="</select>";const a=`<input type="number" class="quantity-input" value="${e.quantity||1}" onchange="updateIngredientQuantity(${t}, this.value)" min="0">`;let l=e.carbs||0,c=e.fat||0,d=e.protein||0;const u=(e.serving_unit||"").toLowerCase(),f=e.quantity||1;u==="each"&&(l=l*f,c=c*f,d=d*f);const h=`
                <div class="nutrient-tags">
                    <span class="nutrient-tag carbs">${l.toFixed(1)}g C</span>
                    <span class="nutrient-tag fat">${c.toFixed(1)}g F</span>
                    <span class="nutrient-tag protein">${d.toFixed(1)}g P</span>
                </div>`,g=`<button class="remove-ingredient-btn" onclick="removeIngredientFromMeal(${t})">&times;</button>`;o.innerHTML=`
                <div class="ingredient-main-controls">
                  ${r}
                  <div class="ingredient-quant-controls">
                    ${a}
                    ${s}
                  </div>
                </div>
                ${h}
                ${g}
            `,n.appendChild(o)})}catch(e){console.error("Failed to render ingredients for create form",e),n.innerHTML="Error rendering ingredients"}}}async function _e(){const n=document.getElementById("ingredientsList"),e=document.getElementById("editMealIngredients");n?await nl():e&&await Re()}window.removeIngredientFromMeal=nr;window.updateIngredientFood=or;window.updateIngredientQuantity=rr;window.updateIngredientUnit=ir;window.updateIngredientNutrient=sr;window.updateIngredientInstructions=ar;window.updateServingUnitField=Qo;window.toggleGramsInput=Xo;window.loadMealForEdit=tr;window.addNewIngredient=dr;window.removeIngredientRow=cr;window.addServingUnit=lr;window.removeServingUnit=Yo;const ol=Object.freeze(Object.defineProperty({__proto__:null,addIngredientToMeal:Ka,addNewIngredient:dr,addServingUnit:lr,closeEditFoodModal:an,closeEditMealModal:ln,get currentMealIngredients(){return T},deleteEditedFood:Va,deleteEditedMeal:Xa,loadFoodForEdit:Ga,loadMealForEdit:tr,openEditFoodModal:Wa,openEditMealModal:Ja,previewFoodImage:Ya,previewMealImage:el,removeFoodImage:Za,removeIngredientFromMeal:nr,removeIngredientRow:cr,removeMealImage:tl,removeServingUnit:Yo,saveEditedFood:Zo,saveEditedMeal:Qa,toggleGramsInput:Xo,updateIngredientFood:or,updateIngredientInstructions:ar,updateIngredientNutrient:sr,updateIngredientQuantity:rr,updateIngredientUnit:ir,updateServingUnitField:Qo},Symbol.toStringTag,{value:"Module"}));document.addEventListener("DOMContentLoaded",()=>{setTimeout(rl,100)});function rl(){const n=document.createElement("div");n.id="splashScreen",n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100vw",n.style.height="100vh",n.style.background="linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)",n.style.display="flex",n.style.flexDirection="column",n.style.justifyContent="center",n.style.alignItems="center",n.style.zIndex="9999";const e=document.querySelector('img[src*="nutrivalor_logo"]'),t=e?e.src:"/assets/nutrivalor_logo.png";n.innerHTML=`
    <img src="${t}" alt="NutriValor Logo" style="max-width: 320px; width: 40vw; height: auto; margin-bottom: 1rem;" />
    <div style="font-size: 1.6rem; font-weight: 400; color: #8a99b3; font-family: 'Poppins', sans-serif; font-style: italic;">"Value your Nutrition"</div>
  `,document.body.appendChild(n),setTimeout(()=>{n.style.transition="opacity 0.5s",n.style.opacity="0",setTimeout(()=>n.remove(),500)},2e3)}async function il(){try{no(),await oo(),await uo(),await Eo(),await ia(),await ma(),await Oo(),await Ho(),await fr(),pl(),vl(),yl(),ll()}catch(n){console.error(" Error initializing application:",n)}}async function sl(){var n,e,t,o,r,i,s,a,l;console.log(" Updating profile...");try{const c=(n=document.getElementById("profileName"))==null?void 0:n.value,d=(e=document.getElementById("dateOfBirth"))==null?void 0:e.value,u=(t=document.getElementById("profileAge"))==null?void 0:t.value,f=(o=document.getElementById("profileGender"))==null?void 0:o.value,h=(r=document.getElementById("profileHeight"))==null?void 0:r.value,g=(i=document.getElementById("heightUnit"))==null?void 0:i.value,p=(s=document.getElementById("profileIdealWeight"))==null?void 0:s.value,m=(a=document.getElementById("weightUnit"))==null?void 0:a.value,w=(l=document.getElementById("profileCountry"))==null?void 0:l.value,_=document.getElementById("avatarPreview"),v={name:c,dateOfBirth:d,age:u,gender:f,height:h,heightUnit:g,idealWeight:p,weightUnit:m,country:w,avatar:(_==null?void 0:_.src)||null},b=await wo(v),k=document.getElementById("userEmail"),$=document.getElementById("headerAvatar"),O=document.getElementById("headerAvatarPlaceholder");k&&c&&c.trim()&&(k.textContent=c),$&&O&&(v.avatar?($.src=v.avatar,$.style.display="block",O.style.display="none"):($.style.display="none",O.style.display="flex")),I("Profile updated successfully!","success"),console.log(" Profile saved to Supabase:",b)}catch(c){console.error(" Error saving profile:",c),I("Error saving profile. Please try again.","error")}}async function ur(){try{const n=await Qt();if(n){const e=document.getElementById("profileName"),t=document.getElementById("dateOfBirth"),o=document.getElementById("profileAge"),r=document.getElementById("profileGender"),i=document.getElementById("profileHeight"),s=document.getElementById("heightUnit"),a=document.getElementById("profileIdealWeight"),l=document.getElementById("weightUnit"),c=document.getElementById("profileCountry"),d=document.getElementById("avatarPreview"),u=document.getElementById("avatarPlaceholder"),f=document.getElementById("removeAvatarBtn");e&&(e.value=n.name||""),t&&(t.value=n.date_of_birth||""),o&&(o.value=n.age||""),r&&(r.value=n.gender||""),i&&(i.value=n.height||""),s&&(s.value=n.height_unit||"cm"),a&&(a.value=n.ideal_weight||""),l&&(l.value=n.weight_unit||"kg"),c&&(c.value=n.country||""),n.avatar_url&&d&&u&&(d.src=n.avatar_url,d.style.display="block",u.style.display="none",f&&(f.style.display="inline-flex")),I("Profile loaded successfully!","success")}else I("No saved profile found","info")}catch(n){console.error(" Error loading profile:",n),I("Error loading profile","error")}}function al(){const n=document.getElementById("avatarPreview"),e=document.getElementById("avatarPlaceholder"),t=document.getElementById("removeAvatarBtn"),o=document.getElementById("avatarInput"),r=document.getElementById("headerAvatar"),i=document.getElementById("headerAvatarPlaceholder");n&&e&&(n.style.display="none",n.src="",e.style.display="flex",t&&(t.style.display="none"),o&&(o.value="")),r&&i&&(r.style.display="none",r.src="",i.style.display="flex"),console.log(" Avatar removed")}function I(n,e="info"){const t=document.getElementById("messageToast");t&&(t.textContent=n,t.className=`message-toast ${e}`,t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3))}function ll(){window.showUploadModal=cl,window.closeUploadModal=dl,window.showSection=hr,window.updateProfile=sl,window.loadProfile=ur,window.removeAvatar=al,window.exportData=ul,window.clearAllData=hl,window.reloadMeals=Do,window.clearShoppingList=fl,window.formatText=bl,window.formatEditText=El,window.removeMealPicture=kl,window.removeEditMealPicture=$l,window.setupMealPictureEventListeners=cn,window.exportFoodsToCSV=async()=>{try{const{exportFoodsToCSV:n}=await A(async()=>{const{exportFoodsToCSV:e}=await import("./admin-CtBnY5h_.js");return{exportFoodsToCSV:e}},[]);await n()}catch(n){console.error(" Error loading CSV export function:",n),I("Error loading CSV export function","error")}},window.importFoodsFromCSV=async()=>{try{const{importFoodsFromCSV:n}=await A(async()=>{const{importFoodsFromCSV:e}=await import("./admin-CtBnY5h_.js");return{importFoodsFromCSV:e}},[]);await n()}catch(n){console.error(" Error loading CSV import function:",n),I("Error loading CSV import function","error")}},window.createFoodsBackup=async()=>{try{const{createFoodsBackup:n}=await A(async()=>{const{createFoodsBackup:e}=await import("./admin-CtBnY5h_.js");return{createFoodsBackup:e}},[]);await n()}catch(n){console.error(" Error loading backup function:",n),I("Error loading backup function","error")}},window.restoreFromBackup=async()=>{try{const{restoreFromBackup:n}=await A(async()=>{const{restoreFromBackup:e}=await import("./admin-CtBnY5h_.js");return{restoreFromBackup:e}},[]);await n()}catch(n){console.error(" Error loading restore function:",n),I("Error loading restore function","error")}}}function cl(){const n=document.getElementById("uploadModal");n&&(n.style.display="flex",console.log(" Upload modal opened"))}function dl(){const n=document.getElementById("uploadModal");n&&(n.style.display="none",console.log(" Upload modal closed"))}function hr(n){document.querySelectorAll(".nav-tab").forEach(o=>{o.classList.remove("active")}),document.querySelectorAll(".content-section").forEach(o=>{o.classList.remove("active")});const e=document.getElementById(n);e&&e.classList.add("active");const t=document.querySelector(`[data-section="${n}"]`);if(t&&t.classList.add("active"),n==="shopping-list"){console.log(" Loading shopping list...");try{A(()=>Promise.resolve().then(()=>Ha),void 0).then(o=>{o.loadAndDisplayShoppingList()})}catch(o){console.error(" Error loading shopping list:",o)}}else n==="admin"&&gl();console.log(` Switched to section: ${n}`)}function ul(){console.log(" Export data")}function hl(){console.log(" Clear all data")}function fl(){console.log(" Clear shopping list")}async function gl(){try{console.log(" Loading admin section...");const{initializeAdmin:n}=await A(async()=>{const{initializeAdmin:e}=await import("./admin-CtBnY5h_.js");return{initializeAdmin:e}},[]);await n(),console.log(" Admin section loaded")}catch(n){console.warn(" Admin initialization had errors, continuing with simple edit system:",n)}await fr()}async function fr(){try{if(console.log(" Ensuring simple edit system is available..."),await new Promise(n=>setTimeout(n,100)),console.log(" Checking window.openEditFoodModal:",typeof window.openEditFoodModal),console.log(" Checking window.openEditMealModal:",typeof window.openEditMealModal),typeof window.openEditFoodModal!="function"||typeof window.openEditMealModal!="function"){console.log(" Simple edit functions not available, attempting manual import...");try{const n=await A(()=>Promise.resolve().then(()=>ol),void 0);window.openEditFoodModal=n.openEditFoodModal,window.closeEditFoodModal=n.closeEditFoodModal,window.loadFoodForEdit=n.loadFoodForEdit,window.saveEditedFood=n.saveEditedFood,window.deleteEditedFood=n.deleteEditedFood,window.previewFoodImage=n.previewFoodImage,window.removeFoodImage=n.removeFoodImage,window.openEditMealModal=n.openEditMealModal,window.closeEditMealModal=n.closeEditMealModal,window.loadMealForEdit=n.loadMealForEdit,window.saveEditedMeal=n.saveEditedMeal,window.deleteEditedMeal=n.deleteEditedMeal,window.previewMealImage=n.previewMealImage,window.removeMealImage=n.removeMealImage,window.addIngredientToMeal=n.addIngredientToMeal,window.removeIngredientFromMeal=n.removeIngredientFromMeal,window.addNewIngredientRow=n.addNewIngredientRow,window.removeIngredientRow=n.removeIngredientRow,window.updateIngredientFood=n.updateIngredientFood,window.updateIngredientQuantity=n.updateIngredientQuantity,window.updateIngredientNutrient=n.updateIngredientNutrient,window.updateIngredientInstructions=n.updateIngredientInstructions,console.log(" Simple edit functions manually attached to window")}catch(n){console.error(" Failed to import simple-edit module:",n)}}if(typeof window.openEditFoodModal=="function"&&typeof window.openEditMealModal=="function"){console.log(" Simple edit functions are available");const n=document.querySelector('[onclick*="openEditFoodModal"]'),e=document.querySelector('[onclick*="openEditMealModal"]');console.log(n?" Edit Food button found":" Edit Food button not found in DOM"),console.log(e?" Edit Meal button found":" Edit Meal button not found in DOM")}else console.error(" Simple edit functions still not available after manual import"),console.log("Available window functions:",Object.keys(window).filter(n=>n.includes("Edit")))}catch(n){console.error(" Error initializing simple edit system:",n)}}function pl(){document.addEventListener("click",n=>{const e=n.target;if(e.classList.contains("modal")){const t=e;t.style.display="none",t.classList.remove("visible")}}),document.addEventListener("keydown",n=>{n.key==="Escape"&&ml()})}function ml(){document.querySelectorAll(".modal").forEach(n=>{const e=n;e.style.display="none",e.classList.remove("visible")})}function yl(){const n=document.getElementById("avatarPreview"),e=document.getElementById("chooseAvatarBtn"),t=document.getElementById("changeAvatarBtn");e&&(e.style.display="inline-flex"),t&&(t.style.display="none"),n&&n.src&&n.style.display!=="none"&&(e&&(e.style.display="none"),t&&(t.style.display="inline-flex"))}function vl(){const n=document.getElementById("avatarInput");n&&n.addEventListener("change",wl);const e=document.getElementById("dateOfBirth");e&&e.addEventListener("change",_l),setTimeout(()=>{ur()},1e3)}function wl(n){var o;const t=(o=n.target.files)==null?void 0:o[0];if(t&&t.type.startsWith("image/")){const r=new FileReader;r.onload=i=>{var c;const s=document.getElementById("avatarPreview"),a=document.getElementById("avatarPlaceholder"),l=document.getElementById("removeAvatarBtn");s&&a&&((c=i.target)!=null&&c.result)&&(s.src=i.target.result,s.style.display="block",a.style.display="none",l&&(l.style.display="block"))},r.readAsDataURL(t)}else I("Please select a valid image file","error")}function _l(){const n=document.getElementById("dateOfBirth"),e=document.getElementById("profileAge");if(n&&e&&n.value){const t=new Date(n.value),o=new Date;let r=o.getFullYear()-t.getFullYear();const i=o.getMonth()-t.getMonth();(i<0||i===0&&o.getDate()<t.getDate())&&r--,e.value=r.toString()}}function bl(n){const e=document.getElementById("cookingInstructions"),t=document.getElementById("cookingInstructionsHidden");e&&(e.focus(),document.execCommand(n,!1),t&&(t.value=e.innerHTML))}function El(n){const e=document.getElementById("editCookingInstructions"),t=document.getElementById("editCookingInstructionsHidden");e&&(e.focus(),document.execCommand(n,!1),t&&(t.value=e.innerHTML))}function Sl(){const n=document.getElementById("cookingInstructions"),e=document.getElementById("cookingInstructionsHidden");n&&e&&(n.addEventListener("input",()=>{e.value=n.innerHTML}),n.addEventListener("paste",r=>{r.preventDefault();const i=(r.clipboardData||window.clipboardData).getData("text/plain");document.execCommand("insertText",!1,i)}));const t=document.getElementById("editCookingInstructions"),o=document.getElementById("editCookingInstructionsHidden");t&&o&&(t.addEventListener("input",()=>{o.value=t.innerHTML}),t.addEventListener("paste",r=>{r.preventDefault();const i=(r.clipboardData||window.clipboardData).getData("text/plain");document.execCommand("insertText",!1,i)}))}function cn(){const n=document.getElementById("mealPictureFile");n&&n.addEventListener("change",Il)}function Il(n){var o;console.log(" Main meal picture upload triggered");const t=(o=n.target.files)==null?void 0:o[0];if(console.log(" Selected file:",t==null?void 0:t.name,t==null?void 0:t.type),t&&t.type.startsWith("image/")){console.log(" Valid image file detected");const r=new FileReader;r.onload=i=>{var d;console.log(" File read complete");const s=document.getElementById("mealPicturePreview"),a=document.getElementById("mealPicturePlaceholder"),l=document.getElementById("removeMealPictureBtn"),c=document.getElementById("mealPicture");console.log(" Elements found:",{preview:!!s,placeholder:!!a,removeBtn:!!l,hiddenInput:!!c}),s&&a&&((d=i.target)!=null&&d.result)?(s.src=i.target.result,s.style.display="block",a.style.display="none",l&&(l.style.display="block"),c&&(c.value=i.target.result),console.log(" Image preview updated successfully")):console.error(" Missing required elements for image preview")},r.readAsDataURL(t)}else console.error(" Invalid file type:",t==null?void 0:t.type),I("Please select a valid image file","error")}function kl(){const n=document.getElementById("mealPicturePreview"),e=document.getElementById("mealPicturePlaceholder"),t=document.getElementById("removeMealPictureBtn"),o=document.getElementById("mealPicture"),r=document.getElementById("mealPictureFile");n&&(n.style.display="none"),e&&(e.style.display="block"),t&&(t.style.display="none"),o&&(o.value=""),r&&(r.value="")}function $l(){const n=document.getElementById("editMealPicturePreview"),e=document.getElementById("editMealPicturePlaceholder"),t=document.getElementById("removeEditMealPictureBtn"),o=document.getElementById("editMealPicture"),r=document.getElementById("editMealPictureFile");n&&(n.style.display="none"),e&&(e.style.display="block"),t&&(t.style.display="none"),o&&(o.value=""),r&&(r.value="")}il();setTimeout(()=>{Sl(),cn()},2e3);const xn=document.querySelector(`[onclick="showSection('admin')"]`);xn&&xn.addEventListener("click",()=>{setTimeout(()=>{cn()},500)});window.showSection=hr;const Pl=Object.freeze(Object.defineProperty({__proto__:null,showMessage:I},Symbol.toStringTag,{value:"Module"}));export{A as _,F as a,Ws as b,T as c,Be as g,ao as i,Do as r,y as s};
//# sourceMappingURL=main-M_9bQhuz.js.map
